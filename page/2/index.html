
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>茶包哥的迷你仓</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="专注于云&#x2F;大数据&#x2F;容器化方向">
<meta property="og:type" content="website">
<meta property="og:title" content="茶包哥的迷你仓">
<meta property="og:url" content="https://theodorew.github.io/wxsblog.github.io/page/2/index.html">
<meta property="og:site_name" content="茶包哥的迷你仓">
<meta property="og:description" content="专注于云&#x2F;大数据&#x2F;容器化方向">
<meta property="og:locale">
<meta property="article:author" content="Xinsheng Wang">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="茶包哥的迷你仓" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/wxsblog.github.io/css/style.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 6.0.0"></head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/wxsblog.github.io/" id="logo">茶包哥的迷你仓</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/wxsblog.github.io/">Home</a>
        
          <a class="main-nav-link" href="/wxsblog.github.io/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="theodorew.github.io/wxsblog.github.io">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main">
  
    <article id="post-2020-01-18-AzureMonitorRestfulAPI" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/wxsblog.github.io/2020/01/18/2020-01-18-AzureMonitorRestfulAPI/" class="article-date">
  <time datetime="2020-01-18T07:45:29.000Z" itemprop="datePublished">2020-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/">Microsoft Azure</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/">Monitor</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/MongoDB/">MongoDB</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/MongoDB/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/wxsblog.github.io/2020/01/18/2020-01-18-AzureMonitorRestfulAPI/">集成 Microsoft Azure Monitor Restful API 来监控 MongoDB</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>随时 IT 技术的蓬勃发展，出现了越来越多地以各种技术栈为核心的应用程序，同时应用架构和服务的调用关系也就变得越来越复杂，所以建立一个强大的监控系统的必要性就很自然的体现了出来。一般在实际的生产环境中，监控对象类型丰富多样，工具平台也有很多可以来选择。比如从最早的 Smokeping，Cacti，Nagios，Ganglia 发展到现在比较流行功能也更加强大的 Zabbix，Prometheus，Openfalcon 以及偏业务层做代码追踪的监控平台 CAT，Zipkin 等，这些都是很不错的工具和平台，只要运用合适，都可以解决很多场景和不同维度的监控需求。但是维护这些监控平台并不是一件容易的事情，从可靠性、性能到定制化开发，都需要花费很多的人力物力来做底层代码层面的修改，不然直接上生产有非常大的风险。依据此背景，Azure 也推出自己的监控服务 Azure Monitor，帮助客户不需要担心监控系统的可靠性，只需要关注业务的可靠性和监控需求的落地即可。Azure Monitor 支持从基础架构层、应用层甚至于容器层面的监控。本文主要介绍通过 Azure Monitor Restful API 来收集 MongoDB 的指标，从而来模拟通过 Azure Monitor 来做二开监控平台的场景。</p>
<p>&amp;nbsp;</p>
<h2 id="2-Azure-Monitor-介绍"><a href="#2-Azure-Monitor-介绍" class="headerlink" title="2. Azure Monitor 介绍"></a>2. Azure Monitor 介绍</h2><p>Azure Monitor 提供用于收集、分析和处理来自云与本地环境的遥测数据的综合解决方案，可将应用程序和服务的可用性和性能最大化。它可以帮助你了解应用程序的性能，并主动识别影响应用程序及其所依赖资源的问题。下图提供了 Azure Monitor 的概要视图。示意图的中心是用于存储指标和日志 ( Azure Monitor 使用的两种基本类型的数据 ) 的数据存储，左侧是用于填充这些数据存储的监视数据源，右侧是 Azure Monitor 针对这些收集的数据执行的不同功能，例如分析、警报和流式传输到外部系统。</p>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2020-01-18-AzureMonitorRestfulAPI/Azure-Monitor-Arch.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2020-01-18-AzureMonitorRestfulAPI/Azure-Monitor-Arch.jpg&quot;</a> “height:800px” width&#x3D;”800px” div align&#x3D;center&#x2F;&gt;</p>
<p>Azure Monitor 支持监控的数据类型的层级都很多，具体可以参考<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/azure-monitor/overview">官方文档</a>，就不在此赘述了。对于收集上来的数据，Azure Monitor 使用 Azure Data Explorer 使用的 Kusto 查询语言来做查询，同时包括高级功能，例如聚合、联接和智能分析等。话不多说，直接开干。</p>
<p>&amp;nbsp;</p>
<h2 id="3-Azure-Monitor-通过-Restful-API-监控-MongoDB"><a href="#3-Azure-Monitor-通过-Restful-API-监控-MongoDB" class="headerlink" title="3. Azure Monitor 通过 Restful API 监控 MongoDB"></a>3. Azure Monitor 通过 Restful API 监控 MongoDB</h2><h3 id="3-1-创建测试服务器-CentOS-Server"><a href="#3-1-创建测试服务器-CentOS-Server" class="headerlink" title="3.1 创建测试服务器 CentOS Server"></a>3.1 创建测试服务器 CentOS Server</h3><p>首先，通过 Terraform 自动化部署 CentOS 7.7 实例，具体的 .tf 文件内容如下，其中变量引用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configure the Microsoft Azure Provider</span></span><br><span class="line">provider <span class="string">&quot;azurerm&quot;</span> &#123;</span><br><span class="line">    subscription_id = <span class="string">&quot;<span class="variable">$&#123;var.subscription_id&#125;</span>&quot;</span></span><br><span class="line">    client_id       = <span class="string">&quot;<span class="variable">$&#123;var.client_id&#125;</span>&quot;</span></span><br><span class="line">    client_secret   = <span class="string">&quot;<span class="variable">$&#123;var.client_secret&#125;</span>&quot;</span></span><br><span class="line">    tenant_id       = <span class="string">&quot;<span class="variable">$&#123;var.tenant_id&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a resource group if it doesn’t exist</span></span><br><span class="line">resource <span class="string">&quot;azurerm_resource_group&quot;</span> <span class="string">&quot;myterraformgroup&quot;</span> &#123;</span><br><span class="line">    name     = <span class="string">&quot;<span class="variable">$&#123;var.lab_namespace&#125;</span>rg0001&quot;</span></span><br><span class="line">    location = <span class="string">&quot;<span class="variable">$&#123;var.location&#125;</span>&quot;</span></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Automation&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create virtual network</span></span><br><span class="line">resource <span class="string">&quot;azurerm_virtual_network&quot;</span> <span class="string">&quot;myterraformnetwork&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;<span class="variable">$&#123;var.lab_namespace&#125;</span>vnet0001&quot;</span></span><br><span class="line">    address_space       = [<span class="string">&quot;10.11.0.0/16&quot;</span>]</span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;var.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Automation&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create Network Security Group and rule</span></span><br><span class="line">resource <span class="string">&quot;azurerm_network_security_group&quot;</span> <span class="string">&quot;publicnsg&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;public-nsg&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;var.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;SSH&quot;</span></span><br><span class="line">        priority                   = 1001</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;22&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;RDP&quot;</span></span><br><span class="line">        priority                   = 1002</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;3389&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Automation&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_network_security_group&quot;</span> <span class="string">&quot;opnsg&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;op-nsg&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;var.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;SSH&quot;</span></span><br><span class="line">        priority                   = 1001</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;22&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;RDP&quot;</span></span><br><span class="line">        priority                   = 1002</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;3389&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Automation&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create subnet</span></span><br><span class="line">resource <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;publicsubnet&quot;</span> &#123;</span><br><span class="line">    name                 = <span class="string">&quot;publicsubnet0001&quot;</span></span><br><span class="line">    resource_group_name  = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    virtual_network_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_virtual_network.myterraformnetwork.name&#125;</span>&quot;</span></span><br><span class="line">    address_prefix       = <span class="string">&quot;10.11.0.0/23&quot;</span></span><br><span class="line">    network_security_group_id = <span class="string">&quot;<span class="variable">$&#123;azurerm_network_security_group.publicnsg.id&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;opsubnet&quot;</span> &#123;</span><br><span class="line">    name                 = <span class="string">&quot;opsubnet0001&quot;</span></span><br><span class="line">    resource_group_name  = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    virtual_network_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_virtual_network.myterraformnetwork.name&#125;</span>&quot;</span></span><br><span class="line">    address_prefix       = <span class="string">&quot;10.11.2.0/23&quot;</span></span><br><span class="line">    network_security_group_id = <span class="string">&quot;<span class="variable">$&#123;azurerm_network_security_group.opnsg.id&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create Public IP</span></span><br><span class="line">resource <span class="string">&quot;azurerm_public_ip&quot;</span> <span class="string">&quot;centospips&quot;</span> &#123;</span><br><span class="line">    name                         = <span class="string">&quot;centos0001pip&quot;</span></span><br><span class="line">    location                     = <span class="string">&quot;<span class="variable">$&#123;var.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name          = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    allocation_method            = <span class="string">&quot;Static&quot;</span></span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Automation&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create Network interface</span></span><br><span class="line">resource <span class="string">&quot;azurerm_network_interface&quot;</span> <span class="string">&quot;centosnics&quot;</span> &#123;</span><br><span class="line">    name                        = <span class="string">&quot;centos0001nic0001&quot;</span></span><br><span class="line">    location                    = <span class="string">&quot;<span class="variable">$&#123;var.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name         = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    ip_configuration &#123;</span><br><span class="line">        name                          = <span class="string">&quot;centos0001nic0001&quot;</span></span><br><span class="line">        subnet_id                     = <span class="string">&quot;<span class="variable">$&#123;azurerm_subnet.publicsubnet.id&#125;</span>&quot;</span></span><br><span class="line">        private_ip_address_allocation = <span class="string">&quot;Static&quot;</span></span><br><span class="line">        private_ip_address            = <span class="string">&quot;10.11.0.4&quot;</span></span><br><span class="line">        public_ip_address_id          = <span class="string">&quot;<span class="variable">$&#123;azurerm_public_ip.centospips.id&#125;</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Automation&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create storage account for boot diagnostics</span></span><br><span class="line">resource <span class="string">&quot;azurerm_storage_account&quot;</span> <span class="string">&quot;mystorageaccount&quot;</span> &#123;</span><br><span class="line">    name                        = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>sa0001&quot;</span></span><br><span class="line">    resource_group_name         = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    location                    = <span class="string">&quot;<span class="variable">$&#123;var.location&#125;</span>&quot;</span></span><br><span class="line">    account_kind                = <span class="string">&quot;StorageV2&quot;</span></span><br><span class="line">    account_tier                = <span class="string">&quot;Standard&quot;</span></span><br><span class="line">    account_replication_type    = <span class="string">&quot;LRS&quot;</span></span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Automation&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create virtual machine</span></span><br><span class="line">resource <span class="string">&quot;azurerm_virtual_machine&quot;</span> <span class="string">&quot;centos0001&quot;</span> &#123;</span><br><span class="line">    name                  = <span class="string">&quot;centos0001&quot;</span></span><br><span class="line">    location              = <span class="string">&quot;<span class="variable">$&#123;var.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name   = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    network_interface_ids = [<span class="string">&quot;<span class="variable">$&#123;azurerm_network_interface.centosnics.id&#125;</span>&quot;</span>]</span><br><span class="line">    vm_size               = <span class="string">&quot;Standard_D2s_v3&quot;</span></span><br><span class="line"></span><br><span class="line">    storage_os_disk &#123;</span><br><span class="line">        name              = <span class="string">&quot;centos0001OsDisk&quot;</span></span><br><span class="line">        caching           = <span class="string">&quot;ReadWrite&quot;</span></span><br><span class="line">        create_option     = <span class="string">&quot;FromImage&quot;</span></span><br><span class="line">        managed_disk_type = <span class="string">&quot;Standard_LRS&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    storage_image_reference &#123;</span><br><span class="line">        <span class="built_in">id</span> = <span class="string">&quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/xxxxxx/providers/Microsoft.Compute/images/centos77image0001&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    os_profile &#123;</span><br><span class="line">        computer_name  = <span class="string">&quot;centos0001&quot;</span></span><br><span class="line">        admin_username = <span class="string">&quot;<span class="variable">$&#123;var.admin_username&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    os_profile_linux_config &#123;</span><br><span class="line">        disable_password_authentication = <span class="literal">true</span></span><br><span class="line">        ssh_keys &#123;</span><br><span class="line">            path     = <span class="string">&quot;/home/<span class="variable">$&#123;var.admin_username&#125;</span>/.ssh/authorized_keys&quot;</span></span><br><span class="line">            key_data = <span class="string">&quot;<span class="variable">$&#123;var.ssh_public_key_data&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    boot_diagnostics &#123;</span><br><span class="line">        enabled = <span class="string">&quot;true&quot;</span></span><br><span class="line">        storage_uri = <span class="string">&quot;<span class="variable">$&#123;azurerm_storage_account.mystorageaccount.primary_blob_endpoint&#125;</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Automation&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个部署过程大概需要10分钟左右完成。</p>
<h3 id="3-2-部署单节点-MongoDB-Server-4-2-0"><a href="#3-2-部署单节点-MongoDB-Server-4-2-0" class="headerlink" title="3.2 部署单节点 MongoDB Server 4.2.0"></a>3.2 部署单节点 MongoDB Server 4.2.0</h3><h4 id="3-2-1-配置-CentOS-7-7-MongoDB-4-x-Yum-源"><a href="#3-2-1-配置-CentOS-7-7-MongoDB-4-x-Yum-源" class="headerlink" title="3.2.1 配置 CentOS 7.7 MongoDB 4.x Yum 源"></a>3.2.1 配置 CentOS 7.7 MongoDB 4.x Yum 源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /etc/yum.repos.d/</span><br><span class="line">$ vi mongodb.repo </span><br><span class="line">[mongodb-org-4.2]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=https://repo.mongodb.org/yum/redhat/<span class="variable">$releasever</span>/mongodb-org/4.2/x86_64/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://www.mongodb.org/static/pgp/server-4.2.asc</span><br></pre></td></tr></table></figure>
<p>保存退出，Yum 源配置完成。</p>
<h4 id="3-2-2-安装单节点-MongoDB-Server-4-2-0"><a href="#3-2-2-安装单节点-MongoDB-Server-4-2-0" class="headerlink" title="3.2.2 安装单节点 MongoDB Server 4.2.0"></a>3.2.2 安装单节点 MongoDB Server 4.2.0</h4><p>安装 MongoDB Server 4.2.0：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y mongodb-org-4.2.0 mongodb-org-server-4.2.0 mongodb-org-shell-4.2.0 mongodb-org-mongos-4.2.0 mongodb-org-tools-4.2.0</span><br></pre></td></tr></table></figure>

<p>检查安装包及版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -qa |grep mongodb</span><br><span class="line">mongodb-org-tools-4.2.0-1.el7.x86_64</span><br><span class="line">mongodb-org-mongos-4.2.0-1.el7.x86_64</span><br><span class="line">mongodb-org-shell-4.2.0-1.el7.x86_64</span><br><span class="line">mongodb-org-4.2.0-1.el7.x86_64</span><br><span class="line">mongodb-org-server-4.2.0-1.el7.x86_64</span><br></pre></td></tr></table></figure>

<p>修改 MongoDB Server 配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ vi /etc/mongod.conf</span><br><span class="line"><span class="comment"># mongod.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for documentation of all options, see:</span></span><br><span class="line"><span class="comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">  path: /var/log/mongodb/mongod.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line">storage:</span><br><span class="line">  dbPath: /var/lib/mongo</span><br><span class="line">  journal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line"><span class="comment">#  engine:</span></span><br><span class="line"><span class="comment">#  wiredTiger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line">processManagement:</span><br><span class="line">  fork: <span class="literal">true</span>  <span class="comment"># fork and run in background</span></span><br><span class="line">  pidFilePath: /var/run/mongodb/mongod.pid  <span class="comment"># location of pidfile</span></span><br><span class="line">  timeZoneInfo: /usr/share/zoneinfo</span><br><span class="line"></span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 0.0.0.0  <span class="comment"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line">replication:</span><br><span class="line">  oplogSizeMB: <span class="string">&quot;20480&quot;</span></span><br><span class="line">  replSetName: repconfig </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动 MongoDB Sever 服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mongod &amp;&amp; systemctl <span class="built_in">enable</span> mongod</span><br></pre></td></tr></table></figure>

<p>MongoDB 初始化：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ mongo --port 27017</span><br><span class="line">&gt; repconfig = &#123;    _id : <span class="string">&quot;repconfig&quot;</span>,     members : [         &#123;_id : 0, host : <span class="string">&quot;10.11.0.4:27017&quot;</span> , priority: 1 &#125;     ] &#125;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;repconfig&quot;</span>,</span><br><span class="line">        <span class="string">&quot;members&quot;</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">&quot;_id&quot;</span> : 0,</span><br><span class="line">                        <span class="string">&quot;host&quot;</span> : <span class="string">&quot;10.11.0.4:27017&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;priority&quot;</span> : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br><span class="line">&gt; rs.initiate(repconfig);</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;ok&quot;</span> : 1,</span><br><span class="line">        <span class="string">&quot;<span class="variable">$clusterTime</span>&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;clusterTime&quot;</span> : Timestamp(1579339466, 1),</span><br><span class="line">                <span class="string">&quot;signature&quot;</span> : &#123;</span><br><span class="line">                        <span class="string">&quot;hash&quot;</span> : BinData(0,<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>),</span><br><span class="line">                        <span class="string">&quot;keyId&quot;</span> : NumberLong(0)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;operationTime&quot;</span> : Timestamp(1579339466, 1)</span><br><span class="line">&#125;</span><br><span class="line">repconfig:SECONDARY&gt; </span><br><span class="line">repconfig:PRIMARY&gt;</span><br></pre></td></tr></table></figure>

<p>初始化结束后，可以通过 Mongo Shell rs.status() 来查 Replica 信息。</p>
<h3 id="3-3-通过-Python-调用-Azure-Monitor-Restful-API-来监控-Mongodb-Server-4-2-0"><a href="#3-3-通过-Python-调用-Azure-Monitor-Restful-API-来监控-Mongodb-Server-4-2-0" class="headerlink" title="3.3 通过 Python 调用 Azure Monitor Restful API 来监控 Mongodb Server 4.2.0"></a>3.3 通过 Python 调用 Azure Monitor Restful API 来监控 Mongodb Server 4.2.0</h3><h4 id="3-3-1-创建-Azure-Log-Analysis-Workspace"><a href="#3-3-1-创建-Azure-Log-Analysis-Workspace" class="headerlink" title="3.3.1 创建 Azure Log Analysis Workspace"></a>3.3.1 创建 Azure Log Analysis Workspace</h4><p>具体操作过程不再赘述，通过 Portal 或者 Cli 等方式 Step by Step 点击创建即可，如图：</p>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2020-01-18-AzureMonitorRestfulAPI/LA-Creation.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2020-01-18-AzureMonitorRestfulAPI/LA-Creation.jpg&quot;</a> “height:800px” width&#x3D;”600px” div align&#x3D;center&#x2F;&gt;</p>
<p>创建好了需要的几个信息，如图：</p>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2020-01-18-AzureMonitorRestfulAPI/LA-Info.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2020-01-18-AzureMonitorRestfulAPI/LA-Info.jpg&quot;</a> “height:800px” width&#x3D;”800px” div align&#x3D;center&#x2F;&gt;</p>
<p>“WORKSPACE ID” 为脚本中的 customer_id，”PRIMARY KEY” 为脚本中的 shared_key。</p>
<h4 id="3-3-2-Python-调用-Azure-Monitor-Restful-API-向-Azure-Log-Analysis-Workspace-传送数据"><a href="#3-3-2-Python-调用-Azure-Monitor-Restful-API-向-Azure-Log-Analysis-Workspace-传送数据" class="headerlink" title="3.3.2 Python 调用 Azure Monitor Restful API 向 Azure Log Analysis Workspace 传送数据"></a>3.3.2 Python 调用 Azure Monitor Restful API 向 Azure Log Analysis Workspace 传送数据</h4><p>Azure Monitor Restful API 不做赘述，具体可以参考<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/azure-monitor/platform/data-collector-api">这里</a>。本实验先通过 pymongo 收集 MongoDB Metrics，然后送到 Azure Log Analysis Workspace 中，先安装 pymongo：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install python-pip y</span><br><span class="line">$ pip install pymongo requests </span><br></pre></td></tr></table></figure>
<p>具体的 Python 脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Date: 01/18/2020</span></span><br><span class="line"><span class="string">Author: Xinsheng Wang</span></span><br><span class="line"><span class="string">Description: A custom script to get MongoDB metrics and send data to Azure Monitor </span></span><br><span class="line"><span class="string">Requires: MongoClient in python</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> calendar <span class="keyword">import</span> timegm</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> gmtime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient, errors</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> exit</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> glob <span class="keyword">import</span> glob</span><br><span class="line"></span><br><span class="line"><span class="comment"># Update the customer ID to your Log Analytics workspace ID</span></span><br><span class="line">customer_id = <span class="string">&#x27;86df0cbc-076c-4483-8a32-c59c6550a771&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For the shared key, use either the primary or the secondary Connected Sources client authentication key   </span></span><br><span class="line">shared_key = <span class="string">&quot;b3uLsEOXBFBqTiAHDGp9boTeKR6v86f/9cLPWWsWUvs+LcjBIqjDp9CDJL+7vxlKDDRxqXIf1jjjKcZbdV0H/Q==&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The log type is the name of the event that is being submitted</span></span><br><span class="line">log_type = <span class="string">&#x27;MongoDBMonitorLog&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MongoDB</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;main script class&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># pylint: disable=too-many-instance-attributes</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_temporary_files</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;delete temporary files&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> glob(<span class="string">&#x27;/tmp/mongometrics000*&#x27;</span>):</span><br><span class="line">            os.remove(file)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.mongo_host = <span class="string">&quot;10.11.0.4&quot;</span></span><br><span class="line">        self.mongo_port = <span class="number">27017</span></span><br><span class="line">        self.mongo_db = [<span class="string">&quot;admin&quot;</span>, ]</span><br><span class="line">        self.mongo_user = <span class="literal">None</span></span><br><span class="line">        self.mongo_password = <span class="literal">None</span></span><br><span class="line">        self.__conn = <span class="literal">None</span></span><br><span class="line">        self.__dbnames = <span class="literal">None</span></span><br><span class="line">        self.__metrics = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Connect to MongoDB&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.__conn <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> self.mongo_user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    self.__conn = MongoClient(<span class="string">&#x27;mongodb://%s:%s&#x27;</span> %</span><br><span class="line">                                              (self.mongo_host,</span><br><span class="line">                                               self.mongo_port))</span><br><span class="line">                <span class="keyword">except</span> errors.PyMongoError <span class="keyword">as</span> py_mongo_error:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;Error in MongoDB connection: %s&#x27;</span> %</span><br><span class="line">                          <span class="built_in">str</span>(py_mongo_error))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    self.__conn = MongoClient(<span class="string">&#x27;mongodb://%s:%s@%s:%s&#x27;</span> %</span><br><span class="line">                                              (self.mongo_user,</span><br><span class="line">                                               self.mongo_password,</span><br><span class="line">                                               self.mongo_host,</span><br><span class="line">                                               self.mongo_port))</span><br><span class="line">                <span class="keyword">except</span> errors.PyMongoError <span class="keyword">as</span> py_mongo_error:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;Error in MongoDB connection: %s&#x27;</span> %</span><br><span class="line">                          <span class="built_in">str</span>(py_mongo_error))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_metrics</span>(<span class="params">self, k, v</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;add each metric to the metrics list&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">global</span> body</span><br><span class="line">        dict_metrics = &#123;&#125;</span><br><span class="line">        dict_metrics[<span class="string">&quot;key&quot;</span>] = k</span><br><span class="line">        dict_metrics[<span class="string">&quot;value&quot;</span>] = v</span><br><span class="line">        self.__metrics.append(dict_metrics)</span><br><span class="line">        dic = json.dumps(dict_metrics, sort_keys=<span class="literal">True</span>, indent=<span class="number">4</span>, separators=(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;:&#x27;</span>)).replace(<span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;&#125;,&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        f = <span class="built_in">open</span>(<span class="string">&#x27;/tmp/mongometrics0001.txt&#x27;</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        f.write(dic)</span><br><span class="line">        f.close</span><br><span class="line">        </span><br><span class="line">        os.system(<span class="string">&quot;cat /tmp/mongometrics0001.txt |sed &#x27;$s/\&#125;\,/\&#125;\]/g;1s/&#123;/[&#123;/&#x27; &gt; /tmp/mongometrics0002.txt&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/tmp/mongometrics0002.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> src:</span><br><span class="line">            body = src.read()</span><br><span class="line">            <span class="built_in">print</span>(body)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_db_names</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;get a list of DB names&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.__conn <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.connect()</span><br><span class="line">        db_handler = self.__conn[self.mongo_db[<span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line">        master = db_handler.command(<span class="string">&#x27;isMaster&#x27;</span>)[<span class="string">&#x27;ismaster&#x27;</span>]</span><br><span class="line">        dict_metrics = &#123;&#125;</span><br><span class="line">        dict_metrics[<span class="string">&#x27;key&#x27;</span>] = <span class="string">&#x27;mongodb.ismaster&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> master:</span><br><span class="line">            dict_metrics[<span class="string">&#x27;value&#x27;</span>] = <span class="number">1</span></span><br><span class="line">            db_names = self.__conn.database_names()</span><br><span class="line">            self.__dbnames = db_names</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            dict_metrics[<span class="string">&#x27;value&#x27;</span>] = <span class="number">0</span></span><br><span class="line">        self.__metrics.append(dict_metrics)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_mongo_db_lld</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;print DB list in json format, to be used for mongo db discovery&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.__dbnames <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            db_names = self.get_db_names()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            db_names = self.__dbnames</span><br><span class="line">        dict_metrics = &#123;&#125;</span><br><span class="line">        db_list = []</span><br><span class="line">        dict_metrics[<span class="string">&#x27;key&#x27;</span>] = <span class="string">&#x27;mongodb.discovery&#x27;</span></span><br><span class="line">        dict_metrics[<span class="string">&#x27;value&#x27;</span>] = &#123;<span class="string">&quot;data&quot;</span>: db_list&#125;</span><br><span class="line">        <span class="keyword">if</span> db_names <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">for</span> db_name <span class="keyword">in</span> db_names:</span><br><span class="line">                dict_lld_metric = &#123;&#125;</span><br><span class="line">                dict_lld_metric[<span class="string">&#x27;&#123;#MONGODBNAME&#125;&#x27;</span>] = db_name</span><br><span class="line">                db_list.append(dict_lld_metric)</span><br><span class="line">            dict_metrics[<span class="string">&#x27;value&#x27;</span>] = <span class="string">&#x27;&#123;&quot;data&quot;: &#x27;</span> + json.dumps(db_list) + <span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line">        self.__metrics.insert(<span class="number">0</span>, dict_metrics)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_oplog</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;get replica set oplog information&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.__conn <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.connect()</span><br><span class="line">        db_handler = self.__conn[<span class="string">&#x27;local&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        coll = db_handler.oplog.rs</span><br><span class="line"></span><br><span class="line">        op_first = (coll.find().sort(<span class="string">&#x27;$natural&#x27;</span>, <span class="number">1</span>).limit(<span class="number">1</span>))</span><br><span class="line">        op_last = (coll.find().sort(<span class="string">&#x27;$natural&#x27;</span>, -<span class="number">1</span>).limit(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># if host is not a member of replica set, without this check we will</span></span><br><span class="line">        <span class="comment"># raise StopIteration as guided in</span></span><br><span class="line">        <span class="comment"># http://api.mongodb.com/python/current/api/pymongo/cursor.html</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> op_first.count() &gt; <span class="number">0</span> <span class="keyword">and</span> op_last.count() &gt; <span class="number">0</span>:</span><br><span class="line">            op_fst = (op_first.<span class="built_in">next</span>())[<span class="string">&#x27;ts&#x27;</span>].time</span><br><span class="line">            op_last_st = op_last[<span class="number">0</span>][<span class="string">&#x27;ts&#x27;</span>]</span><br><span class="line">            op_lst = (op_last.<span class="built_in">next</span>())[<span class="string">&#x27;ts&#x27;</span>].time</span><br><span class="line"></span><br><span class="line">            status = <span class="built_in">round</span>(<span class="built_in">float</span>(op_lst - op_fst), <span class="number">1</span>)</span><br><span class="line">            self.add_metrics(<span class="string">&#x27;mongodb.oplog&#x27;</span>, status)</span><br><span class="line"></span><br><span class="line">            current_time = timegm(gmtime())</span><br><span class="line">            oplog = <span class="built_in">int</span>(((<span class="built_in">str</span>(op_last_st).split(<span class="string">&#x27;(&#x27;</span>))[<span class="number">1</span>].split(<span class="string">&#x27;,&#x27;</span>))[<span class="number">0</span>])</span><br><span class="line">            self.add_metrics(<span class="string">&#x27;mongodb.oplog-sync&#x27;</span>, (current_time - oplog))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_maintenance</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;get replica set maintenance info&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.__conn <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.connect()</span><br><span class="line">        db_handler = self.__conn</span><br><span class="line"></span><br><span class="line">        fsync_locked = <span class="built_in">int</span>(db_handler.is_locked)</span><br><span class="line">        self.add_metrics(<span class="string">&#x27;mongodb.fsync-locked&#x27;</span>, fsync_locked)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            config = db_handler.admin.command(<span class="string">&quot;replSetGetConfig&quot;</span>, <span class="number">1</span>)</span><br><span class="line">            connstring = (self.mongo_host + <span class="string">&#x27;:&#x27;</span> + <span class="built_in">str</span>(self.mongo_port))</span><br><span class="line">            connstrings = <span class="built_in">list</span>()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(config[<span class="string">&#x27;config&#x27;</span>][<span class="string">&#x27;members&#x27;</span>])):</span><br><span class="line">                host = config[<span class="string">&#x27;config&#x27;</span>][<span class="string">&#x27;members&#x27;</span>][i][<span class="string">&#x27;host&#x27;</span>]</span><br><span class="line">                connstrings.append(host)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> connstring <span class="keyword">in</span> host:</span><br><span class="line">                    priority = config[<span class="string">&#x27;config&#x27;</span>][<span class="string">&#x27;members&#x27;</span>][i][<span class="string">&#x27;priority&#x27;</span>]</span><br><span class="line">                    hidden = <span class="built_in">int</span>(config[<span class="string">&#x27;config&#x27;</span>][<span class="string">&#x27;members&#x27;</span>][i][<span class="string">&#x27;hidden&#x27;</span>])</span><br><span class="line"></span><br><span class="line">            self.add_metrics(<span class="string">&#x27;mongodb.priority&#x27;</span>, priority)</span><br><span class="line">            self.add_metrics(<span class="string">&#x27;mongodb.hidden&#x27;</span>, hidden)</span><br><span class="line">        <span class="keyword">except</span> errors.PyMongoError:</span><br><span class="line">            <span class="built_in">print</span> (<span class="string">&#x27;Error while fetching replica set configuration.&#x27;</span></span><br><span class="line">                   <span class="string">&#x27;Not a member of replica set?&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> UnboundLocalError:</span><br><span class="line">            <span class="built_in">print</span> (<span class="string">&#x27;Cannot use this mongo host: must be one of &#x27;</span> + <span class="string">&#x27;,&#x27;</span>.join(connstrings))</span><br><span class="line">            exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_server_status_metrics</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;get server status&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.__conn <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.connect()</span><br><span class="line">        db_handler = self.__conn[self.mongo_db[<span class="number">0</span>]]</span><br><span class="line">        ss = db_handler.command(<span class="string">&#x27;serverStatus&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># db info</span></span><br><span class="line">        self.add_metrics(<span class="string">&#x27;mongodb.version&#x27;</span>, ss[<span class="string">&#x27;version&#x27;</span>])</span><br><span class="line">        self.add_metrics(<span class="string">&#x27;mongodb.storageEngine&#x27;</span>, ss[<span class="string">&#x27;storageEngine&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line">        self.add_metrics(<span class="string">&#x27;mongodb.uptime&#x27;</span>, <span class="built_in">int</span>(ss[<span class="string">&#x27;uptime&#x27;</span>]))</span><br><span class="line">        self.add_metrics(<span class="string">&#x27;mongodb.okstatus&#x27;</span>, <span class="built_in">int</span>(ss[<span class="string">&#x27;ok&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># asserts</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> ss[<span class="string">&#x27;asserts&#x27;</span>].items():</span><br><span class="line">            self.add_metrics(<span class="string">&#x27;mongodb.asserts.&#x27;</span> + k, v)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># operations</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> ss[<span class="string">&#x27;opcounters&#x27;</span>].items():</span><br><span class="line">            self.add_metrics(<span class="string">&#x27;mongodb.operation.&#x27;</span> + k, v)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># connections</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> ss[<span class="string">&#x27;connections&#x27;</span>].items():</span><br><span class="line">            self.add_metrics(<span class="string">&#x27;mongodb.connection.&#x27;</span> + k, v)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># extra info</span></span><br><span class="line">        self.add_metrics(<span class="string">&#x27;mongodb.page.faults&#x27;</span>,</span><br><span class="line">                         ss[<span class="string">&#x27;extra_info&#x27;</span>][<span class="string">&#x27;page_faults&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment">#wired tiger</span></span><br><span class="line">        <span class="keyword">if</span> ss[<span class="string">&#x27;storageEngine&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] == <span class="string">&#x27;wiredTiger&#x27;</span>:</span><br><span class="line">            self.add_metrics(<span class="string">&#x27;mongodb.used-cache&#x27;</span>,</span><br><span class="line">                             ss[<span class="string">&#x27;wiredTiger&#x27;</span>][<span class="string">&#x27;cache&#x27;</span>]</span><br><span class="line">                             [<span class="string">&quot;bytes currently in the cache&quot;</span>])</span><br><span class="line">            self.add_metrics(<span class="string">&#x27;mongodb.total-cache&#x27;</span>,</span><br><span class="line">                             ss[<span class="string">&#x27;wiredTiger&#x27;</span>][<span class="string">&#x27;cache&#x27;</span>]</span><br><span class="line">                             [<span class="string">&quot;maximum bytes configured&quot;</span>])</span><br><span class="line">            self.add_metrics(<span class="string">&#x27;mongodb.dirty-cache&#x27;</span>,</span><br><span class="line">                             ss[<span class="string">&#x27;wiredTiger&#x27;</span>][<span class="string">&#x27;cache&#x27;</span>]</span><br><span class="line">                             [<span class="string">&quot;tracked dirty bytes in the cache&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># global lock</span></span><br><span class="line">        lock_total_time = ss[<span class="string">&#x27;globalLock&#x27;</span>][<span class="string">&#x27;totalTime&#x27;</span>]</span><br><span class="line">        self.add_metrics(<span class="string">&#x27;mongodb.globalLock.totalTime&#x27;</span>, lock_total_time)</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> ss[<span class="string">&#x27;globalLock&#x27;</span>][<span class="string">&#x27;currentQueue&#x27;</span>].items():</span><br><span class="line">            self.add_metrics(<span class="string">&#x27;mongodb.globalLock.currentQueue.&#x27;</span> + k, v)</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> ss[<span class="string">&#x27;globalLock&#x27;</span>][<span class="string">&#x27;activeClients&#x27;</span>].items():</span><br><span class="line">            self.add_metrics(<span class="string">&#x27;mongodb.globalLock.activeClients.&#x27;</span> + k, v)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_db_stats_metrics</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;get DB stats for each DB&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.__conn <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.connect()</span><br><span class="line">        <span class="keyword">if</span> self.__dbnames <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.get_db_names()</span><br><span class="line">        <span class="keyword">if</span> self.__dbnames <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">for</span> mongo_db <span class="keyword">in</span> self.__dbnames:</span><br><span class="line">                db_handler = self.__conn[mongo_db]</span><br><span class="line">                dbs = db_handler.command(<span class="string">&#x27;dbstats&#x27;</span>)</span><br><span class="line">                <span class="keyword">for</span> k, v <span class="keyword">in</span> dbs.items():</span><br><span class="line">                    <span class="keyword">if</span> k <span class="keyword">in</span> [<span class="string">&#x27;storageSize&#x27;</span>, <span class="string">&#x27;ok&#x27;</span>, <span class="string">&#x27;avgObjSize&#x27;</span>, <span class="string">&#x27;indexes&#x27;</span>,</span><br><span class="line">                             <span class="string">&#x27;objects&#x27;</span>, <span class="string">&#x27;collections&#x27;</span>, <span class="string">&#x27;fileSize&#x27;</span>,</span><br><span class="line">                             <span class="string">&#x27;numExtents&#x27;</span>, <span class="string">&#x27;dataSize&#x27;</span>, <span class="string">&#x27;indexSize&#x27;</span>,</span><br><span class="line">                             <span class="string">&#x27;nsSizeMB&#x27;</span>]:</span><br><span class="line">                        self.add_metrics(<span class="string">&#x27;mongodb.stats.&#x27;</span> + k +</span><br><span class="line">                                         <span class="string">&#x27;[&#x27;</span> + mongo_db + <span class="string">&#x27;]&#x27;</span>, <span class="built_in">int</span>(v))</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;close connection to mongo&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.__conn <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.__conn.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Build the API signature</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_signature</span>(<span class="params">customer_id, shared_key, date, content_length, method, content_type, resource</span>):</span><br><span class="line">    x_headers = <span class="string">&#x27;x-ms-date:&#x27;</span> + date</span><br><span class="line">    string_to_hash = method + <span class="string">&quot;\n&quot;</span> + <span class="built_in">str</span>(content_length) + <span class="string">&quot;\n&quot;</span> + content_type + <span class="string">&quot;\n&quot;</span> + x_headers + <span class="string">&quot;\n&quot;</span> + resource</span><br><span class="line">    bytes_to_hash = <span class="built_in">bytes</span>(string_to_hash).encode(<span class="string">&#x27;utf-8&#x27;</span>)  </span><br><span class="line">    decoded_key = base64.b64decode(shared_key)</span><br><span class="line">    encoded_hash = base64.b64encode(hmac.new(decoded_key, bytes_to_hash, digestmod=hashlib.sha256).digest())</span><br><span class="line">    authorization = <span class="string">&quot;SharedKey &#123;&#125;:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(customer_id,encoded_hash)</span><br><span class="line">    <span class="keyword">return</span> authorization</span><br><span class="line"></span><br><span class="line"><span class="comment"># Build and send a request to the POST API</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mongodb_azuremonitor_loganalysis_post_data</span>(<span class="params">customer_id, shared_key, body, log_type</span>):</span><br><span class="line">    method = <span class="string">&#x27;POST&#x27;</span></span><br><span class="line">    content_type = <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">    resource = <span class="string">&#x27;/api/logs&#x27;</span></span><br><span class="line">    rfc1123date = datetime.datetime.utcnow().strftime(<span class="string">&#x27;%a, %d %b %Y %H:%M:%S GMT&#x27;</span>)</span><br><span class="line">    content_length = <span class="built_in">len</span>(body)</span><br><span class="line">    signature = build_signature(customer_id, shared_key, rfc1123date, content_length, method, content_type, resource)</span><br><span class="line">    uri = <span class="string">&#x27;https://&#x27;</span> + customer_id + <span class="string">&#x27;.ods.opinsights.azure.com&#x27;</span> + resource + <span class="string">&#x27;?api-version=2016-04-01&#x27;</span></span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;content-type&#x27;</span>: content_type,</span><br><span class="line">        <span class="string">&#x27;Authorization&#x27;</span>: signature,</span><br><span class="line">        <span class="string">&#x27;Log-Type&#x27;</span>: log_type,</span><br><span class="line">        <span class="string">&#x27;x-ms-date&#x27;</span>: rfc1123date</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    response = requests.post(uri,data=body, headers=headers)</span><br><span class="line">    <span class="keyword">if</span> (response.status_code &gt;= <span class="number">200</span> <span class="keyword">and</span> response.status_code &lt;= <span class="number">299</span>):</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;Accepted&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;Response code: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(response.status_code)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    mongodb = MongoDB()</span><br><span class="line">    mongodb.delete_temporary_files()</span><br><span class="line">    mongodb.get_db_names()</span><br><span class="line">    mongodb.get_mongo_db_lld()</span><br><span class="line">    mongodb.get_oplog()</span><br><span class="line">    mongodb.get_maintenance()</span><br><span class="line">    mongodb.get_server_status_metrics()</span><br><span class="line">    mongodb.get_db_stats_metrics()</span><br><span class="line">    mongodb.close()</span><br><span class="line">    mongodb_azuremonitor_loganalysis_post_data(customer_id, shared_key, body, log_type)</span><br></pre></td></tr></table></figure>
<p>注意相应的 customer_id 和 shared_key 替换成图中的 key，log_type 为收集到 Log Analysis Workspace 的 namespace 名字。保存脚本名字为 AzureMonitor_LogAnalysis_MongodbMetrics.py，执行脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python AzureMonitor_LogAnalysis_MongodbMetrics.py</span><br></pre></td></tr></table></figure>
<p>通过 print 可以打印一些交互式信息，观察数据是否已经送到 Azure Log Analysis Workspace。</p>
<h4 id="3-3-3-利用-Kusto-查询-MongoDB-Custom-Logs"><a href="#3-3-3-利用-Kusto-查询-MongoDB-Custom-Logs" class="headerlink" title="3.3.3 利用 Kusto 查询 MongoDB Custom Logs"></a>3.3.3 利用 Kusto 查询 MongoDB Custom Logs</h4><p>在 Azure Portal 查看并通过 KQL 查询 MongoDB 的数据：</p>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2020-01-18-AzureMonitorRestfulAPI/Azure-Monitor-Restful-API-MongoDB.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2020-01-18-AzureMonitorRestfulAPI/Azure-Monitor-Restful-API-MongoDB.jpg&quot;</a> “height:800px” width&#x3D;”800px” div align&#x3D;center&#x2F;&gt;</p>
<p>如图可见，数据已经成功送到了 Azure Log Analysis Workspace，后续可以写更复杂的 Kusto 来做相关的查询，并可以考虑结合调度或者 Linux Crontab 等服务做定时的数据拉取和告警了。</p>
<p>&amp;nbsp;</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>测试至此，Azure Monitor Restful API 监控 MongoDB 的示例完成了，希望能够给想要通过 Azure Monitor 做二次开发的同学们一些参考。但本文还有一些可以优化之处，比如 Python 脚本没有考虑更多的 Log Output 以及执行失败时候的 Retry 逻辑，在实际生产中，为了严谨，还是希望大家要充分考虑逻辑在上线，不过这些功能有待大家自己添加了。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://theodorew.github.io/wxsblog.github.io/2020/01/18/2020-01-18-AzureMonitorRestfulAPI/" data-id="claq92fmh00069nxz6t2hea1q" class="article-share-link" data-share="baidu" data-title="集成 Microsoft Azure Monitor Restful API 来监控 MongoDB">Share</a>
      

      

      
        <a class="article-reward-link">Reward</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Microsoft-Azure/" rel="tag">Microsoft Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/MongoDB/" rel="tag">MongoDB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Monitor/" rel="tag">Monitor</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2019-12-09-AzureDMS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/wxsblog.github.io/2019/12/09/2019-12-09-AzureDMS/" class="article-date">
  <time datetime="2019-12-08T17:37:52.000Z" itemprop="datePublished">2019-12-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/">Microsoft Azure</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Database/">Database</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Database/MySQL/">MySQL</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Database/MySQL/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/wxsblog.github.io/2019/12/09/2019-12-09-AzureDMS/">Azure Database Migration Service — 数据库迁移到 Microsoft Azure 平台的好帮手</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>在复杂多云的环境下，数据库迁移成为了一个既常见又头疼的问题，所以又快又好并保证数据一致性的数据库迁移服务就显得非常必要了。基于这点的考量，Microsoft Azure 也发布了自己的数据迁移服务 Azure Database Migration Service 来帮助想把各类数据库迁移到 Azure 的客户解决数据库迁移的后顾之忧。</p>
<h2 id="2-Azure-Database-Migration-Service-介绍"><a href="#2-Azure-Database-Migration-Service-介绍" class="headerlink" title="2. Azure Database Migration Service 介绍"></a>2. Azure Database Migration Service 介绍</h2><p>Azure Migration Service 是完全托管的服务，旨在实现从多个数据库源无缝迁移到 Azure 并只让应用程序的停机时间最短。该服务集成了一些现有工具和服务的功能从而为客户提供高度可用的综合解决方案，例如使用数据迁移助手生成评估报告，这些报告可以提供建议并能够指导执行迁移之前完成所需的更改。该过程利用了 Microsoft 的最佳实践，因此客户可以在启动迁移项目后便高枕无忧。数据库迁移的过程原理如下图所示：</p>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Arch.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Arch.jpg&quot;</a> “height:800px” width&#x3D;”800px” div align&#x3D;center&#x2F;&gt;</p>
<p>从上至下来看，在 <strong>Pre-migration</strong> 阶段评估工作量并做 Schema 的映射，继而开始做接近同步的异步  <strong>Migration</strong>，最后可以通过 <strong>Cutover</strong> 来做应用程序的迁移。除此之外，为了让大家能够更好的学习该服务，Microsoft 也非常良心的提供了学习的素材，不仅包括<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/dms/">官方文档</a>，还有很多<a target="_blank" rel="noopener" href="https://azure.microsoft.com/en-us/resources/videos/how-to-use-the-azure-database-migration-guide/">视频材料</a>可以参考。为了便捷，本文以下内容都使用 Azure Database Migration Service 的简称 Azure DMS，好了话不多说，我们直接来实战操作吧！</p>
<h2 id="3-Aliyun-RDS-MySQL-迁移至-Azure-Mooncake-MySQL-PaaS-验证"><a href="#3-Aliyun-RDS-MySQL-迁移至-Azure-Mooncake-MySQL-PaaS-验证" class="headerlink" title="3. Aliyun RDS MySQL 迁移至 Azure Mooncake MySQL PaaS 验证"></a>3. Aliyun RDS MySQL 迁移至 Azure Mooncake MySQL PaaS 验证</h2><h3 id="3-1-实验场景以及前期准备"><a href="#3-1-实验场景以及前期准备" class="headerlink" title="3.1 实验场景以及前期准备"></a>3.1 实验场景以及前期准备</h3><p>为了尽可能的模拟真实生产，本文模拟从中国 Aliyun RDS MySQL 到 Azure Mooncake MySQL PaaS，Mooncake 为中国区 Azure 的代号。具体的 MySQL 版本为5.7，具体信息如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ⅰ. Aliyun RDS MySQL -&gt; Azure Mooncake MySQL PaaS (中国区)</span><br></pre></td></tr></table></figure>
<p>在进行实验之前，需要正确安装 Terraform、MySQL Client 等软件包，详细步骤请参考相应文档，本文不进行赘述。具体的客户端连接 MySQL Server 的操作过程在 WSL2-Ubuntu-18.04 以及 Windows 10 的 Navicat 12 客户端上进行。</p>
<h3 id="3-2-Aliyun-RDS-MySQL-迁移到-Azure-Mooncake-MySQL-PaaS-中国区"><a href="#3-2-Aliyun-RDS-MySQL-迁移到-Azure-Mooncake-MySQL-PaaS-中国区" class="headerlink" title="3.2 Aliyun RDS MySQL 迁移到 Azure Mooncake MySQL PaaS (中国区)"></a>3.2 Aliyun RDS MySQL 迁移到 Azure Mooncake MySQL PaaS (中国区)</h3><h4 id="3-2-1-Azure-Mooncake-资源创建初始化"><a href="#3-2-1-Azure-Mooncake-资源创建初始化" class="headerlink" title="3.2.1 Azure Mooncake 资源创建初始化"></a>3.2.1 Azure Mooncake 资源创建初始化</h4><p>首先，通过 Terraform 自动化部署 MySQL Generel Purpose 2core 实例，需要注意的是在中国区 Azure 创建资源的时候需要指定 environment 为 china，具体的 .tf 文件内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configure the Microsoft Azure Provider</span></span><br><span class="line">provider <span class="string">&quot;azurerm&quot;</span> &#123;</span><br><span class="line">    subscription_id = <span class="string">&quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</span></span><br><span class="line">    client_id       = <span class="string">&quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</span></span><br><span class="line">    client_secret   = <span class="string">&quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</span></span><br><span class="line">    tenant_id       = <span class="string">&quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</span></span><br><span class="line">    environment     = <span class="string">&quot;china&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a resource group if it doesn’t exist</span></span><br><span class="line">resource <span class="string">&quot;azurerm_resource_group&quot;</span> <span class="string">&quot;myterraformgroup&quot;</span> &#123;</span><br><span class="line">    name     = <span class="string">&quot;azcndmsrg0001&quot;</span></span><br><span class="line">    location = <span class="string">&quot;chinaeast2&quot;</span></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Automation&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create virtual network</span></span><br><span class="line">resource <span class="string">&quot;azurerm_virtual_network&quot;</span> <span class="string">&quot;myterraformnetwork&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;azcndmsvnet0001&quot;</span></span><br><span class="line">    address_space       = [<span class="string">&quot;10.91.0.0/16&quot;</span>]</span><br><span class="line">    location            = <span class="string">&quot;chinaeast2&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Automation&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create Network Security Group and rule</span></span><br><span class="line">resource <span class="string">&quot;azurerm_network_security_group&quot;</span> <span class="string">&quot;publicnsg&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;public-nsg&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;chinaeast2&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;SSH&quot;</span></span><br><span class="line">        priority                   = 1001</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;22&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;RDP&quot;</span></span><br><span class="line">        priority                   = 1002</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;3389&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Automation&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_network_security_group&quot;</span> <span class="string">&quot;opnsg&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;op-nsg&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;chinaeast2&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;SSH&quot;</span></span><br><span class="line">        priority                   = 1001</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;22&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;RDP&quot;</span></span><br><span class="line">        priority                   = 1002</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;3389&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Automation&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create subnet</span></span><br><span class="line">resource <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;publicsubnet&quot;</span> &#123;</span><br><span class="line">    name                 = <span class="string">&quot;public0001&quot;</span></span><br><span class="line">    resource_group_name  = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    virtual_network_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_virtual_network.myterraformnetwork.name&#125;</span>&quot;</span></span><br><span class="line">    address_prefix       = <span class="string">&quot;10.91.0.0/23&quot;</span></span><br><span class="line">    network_security_group_id = <span class="string">&quot;<span class="variable">$&#123;azurerm_network_security_group.publicnsg.id&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;opsubnet&quot;</span> &#123;</span><br><span class="line">    name                 = <span class="string">&quot;op0001&quot;</span></span><br><span class="line">    resource_group_name  = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    virtual_network_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_virtual_network.myterraformnetwork.name&#125;</span>&quot;</span></span><br><span class="line">    address_prefix       = <span class="string">&quot;10.91.2.0/23&quot;</span></span><br><span class="line">    network_security_group_id = <span class="string">&quot;<span class="variable">$&#123;azurerm_network_security_group.opnsg.id&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create Azure Database for MySQL </span></span><br><span class="line">resource <span class="string">&quot;azurerm_mysql_server&quot;</span> <span class="string">&quot;mysql0001&quot;</span> &#123;</span><br><span class="line">  name                = <span class="string">&quot;mysql0001&quot;</span></span><br><span class="line">  location            = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">  resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">  sku &#123;</span><br><span class="line">    name     = <span class="string">&quot;GP_Gen5_2&quot;</span></span><br><span class="line">    capacity = 2</span><br><span class="line">    tier     = <span class="string">&quot;GeneralPurpose&quot;</span></span><br><span class="line">    family   = <span class="string">&quot;Gen5&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  storage_profile &#123;</span><br><span class="line">    storage_mb            = 20480</span><br><span class="line">    backup_retention_days = 7</span><br><span class="line">    geo_redundant_backup  = <span class="string">&quot;Disabled&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  administrator_login          = <span class="string">&quot;msadmin&quot;</span></span><br><span class="line">  administrator_login_password = <span class="string">&quot;Microsoft2019!&quot;</span></span><br><span class="line">  version                      = <span class="string">&quot;5.7&quot;</span></span><br><span class="line">  ssl_enforcement              = <span class="string">&quot;Enabled&quot;</span></span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个部署过程大概10分钟左右，整个初始化过程会创建资源组、Vnet、NSG、Azure MySQL PaaS 实例等。信息如下：<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-MySQL.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-MySQL.jpg&quot;</a> “height:800px” width&#x3D;”800px” div align&#x3D;center&#x2F;&gt;</p>
<p>需要注意的是，Azure MySQL PaaS 没有启用 SSL。</p>
<h4 id="3-2-2-创建-Aliyun-RDS-MySQL-实例"><a href="#3-2-2-创建-Aliyun-RDS-MySQL-实例" class="headerlink" title="3.2.2 创建 Aliyun RDS MySQL 实例"></a>3.2.2 创建 Aliyun RDS MySQL 实例</h4><p>创建 Aliyun RDS MySQL 实例的过程不予赘述，通过 Portal 一步一步点击即可，本文主要阐述功能性验证，所以部署的实例类型为 MySQL 5.7 基础版 1Core2G 的 mysql.n2.small.1 实例，并启用公网地址。<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Aliyun-RDS-MySQL.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Aliyun-RDS-MySQL.jpg&quot;</a> “height:800px” width&#x3D;”800px” div align&#x3D;center&#x2F;&gt;</p>
<p>创建好之后的需要设置一下白名单以便能够使 Azure DMS 和 Aliyun RDS MySQL 通过公网调用，Azure China Service IP Range 可以在<a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/download/details.aspx?id=57062">这里</a>下载，然后把这些网段加到白名单中即可，避免了直接写0.0.0.0&#x2F;0。</p>
<h4 id="3-2-3-导入示例数据库到-Aliyun-RDS-MySQL-实例"><a href="#3-2-3-导入示例数据库到-Aliyun-RDS-MySQL-实例" class="headerlink" title="3.2.3 导入示例数据库到 Aliyun RDS MySQL 实例"></a>3.2.3 导入示例数据库到 Aliyun RDS MySQL 实例</h4><p>本文采用 MySQL 官方提供的 employees 数据库，可以参考具体的<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/employee/en/">官网地址</a>和 <a target="_blank" rel="noopener" href="https://github.com/datacharmer/test_db">Github地址</a>。该实例数据库包含了300,000 员工及收入信息，数据大概100MB+，数据量已经足够进行测试。employees 库中，表之间的调用关系如下图所示：</p>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Employees.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Employees.jpg&quot;</a> “height:600px” width&#x3D;”600px” div align&#x3D;center&#x2F;&gt;</p>
<p>下面我们开始进行实验，首先通过 Linux MySQL Client 连接至 Aliyun RDS MySQL 实例安装并导入数据库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/datacharmer/test_db.git</span><br><span class="line">$ <span class="built_in">cd</span> test_db/</span><br><span class="line">$ mysql -u<span class="string">&#x27;msadmin&#x27;</span> -p<span class="string">&#x27;Microsoft2019!&#x27;</span> -h<span class="string">&#x27;rm-uf626yx145z16o277so.mysql.rds.aliyuncs.com&#x27;</span> &lt; employees.sql</span><br></pre></td></tr></table></figure>
<p>通过 SQL 查看具体的表容量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select table_schema as <span class="string">&#x27;数据库&#x27;</span>, <span class="built_in">sum</span>(table_rows) as <span class="string">&#x27;记录数&#x27;</span>, <span class="built_in">sum</span>(<span class="built_in">truncate</span>(data_length/1024/1024, 2)) as <span class="string">&#x27;数据容量(MB)&#x27;</span>, <span class="built_in">sum</span>(<span class="built_in">truncate</span>(index_length/1024/1024, 2)) as <span class="string">&#x27;索引容量(MB)&#x27;</span> from information_schema.tables group by table_schema order by <span class="built_in">sum</span>(data_length) desc, <span class="built_in">sum</span>(index_length) desc;</span><br><span class="line">+--------------------+-----------+------------------+------------------+</span><br><span class="line">| 数据库             | 记录数    | 数据容量(MB)     | 索引容量(MB)     |</span><br><span class="line">+--------------------+-----------+------------------+------------------+</span><br><span class="line">| employees          |   3911631 |           141.22 |             5.53 |</span><br><span class="line">| mysql              |    126112 |             5.41 |             0.07 |</span><br><span class="line">| information_schema |      NULL |             0.10 |             0.00 |</span><br><span class="line">| sys                |         0 |             0.01 |             0.00 |</span><br><span class="line">| performance_schema |     11701 |             0.00 |             0.00 |</span><br><span class="line">+--------------------+-----------+------------------+------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.22 sec)</span><br></pre></td></tr></table></figure>
<p>安装完可以进行验证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -u<span class="string">&#x27;msadmin&#x27;</span> -p<span class="string">&#x27;Microsoft2019!&#x27;</span> -h<span class="string">&#x27;rm-uf626yx145z16o277so.mysql.rds.aliyuncs.com&#x27;</span> -t &lt; test_employees_md5.sql </span><br><span class="line">+----------------------+</span><br><span class="line">| INFO                 |</span><br><span class="line">+----------------------+</span><br><span class="line">| TESTING INSTALLATION |</span><br><span class="line">+----------------------+</span><br><span class="line">+--------------+------------------+----------------------------------+</span><br><span class="line">| table_name   | expected_records | expected_crc                     |</span><br><span class="line">+--------------+------------------+----------------------------------+</span><br><span class="line">| departments  |                9 | d1af5e170d2d1591d776d5638d71fc5f |</span><br><span class="line">| dept_emp     |           331603 | ccf6fe516f990bdaa49713fc478701b7 |</span><br><span class="line">| dept_manager |               24 | 8720e2f0853ac9096b689c14664f847e |</span><br><span class="line">| employees    |           300024 | 4ec56ab5ba37218d187cf6ab09ce1aa1 |</span><br><span class="line">| salaries     |          2844047 | fd220654e95aea1b169624ffe3fca934 |</span><br><span class="line">| titles       |           443308 | bfa016c472df68e70a03facafa1bc0a8 |</span><br><span class="line">+--------------+------------------+----------------------------------+</span><br><span class="line">+--------------+------------------+----------------------------------+</span><br><span class="line">| table_name   | found_records    | found_crc                        |</span><br><span class="line">+--------------+------------------+----------------------------------+</span><br><span class="line">| departments  |                9 | d1af5e170d2d1591d776d5638d71fc5f |</span><br><span class="line">| dept_emp     |           331603 | ccf6fe516f990bdaa49713fc478701b7 |</span><br><span class="line">| dept_manager |               24 | 8720e2f0853ac9096b689c14664f847e |</span><br><span class="line">| employees    |           300024 | 4ec56ab5ba37218d187cf6ab09ce1aa1 |</span><br><span class="line">| salaries     |          2844047 | fd220654e95aea1b169624ffe3fca934 |</span><br><span class="line">| titles       |           443308 | bfa016c472df68e70a03facafa1bc0a8 |</span><br><span class="line">+--------------+------------------+----------------------------------+</span><br><span class="line">+--------------+---------------+-----------+</span><br><span class="line">| table_name   | records_match | crc_match |</span><br><span class="line">+--------------+---------------+-----------+</span><br><span class="line">| departments  | OK            | ok        |</span><br><span class="line">| dept_emp     | OK            | ok        |</span><br><span class="line">| dept_manager | OK            | ok        |</span><br><span class="line">| employees    | OK            | ok        |</span><br><span class="line">| salaries     | OK            | ok        |</span><br><span class="line">| titles       | OK            | ok        |</span><br><span class="line">+--------------+---------------+-----------+</span><br><span class="line">+------------------+</span><br><span class="line">| computation_time |</span><br><span class="line">+------------------+</span><br><span class="line">| 00:00:21         |</span><br><span class="line">+------------------+</span><br><span class="line">+---------+--------+</span><br><span class="line">| summary | result |</span><br><span class="line">+---------+--------+</span><br><span class="line">| CRC     | OK     |</span><br><span class="line">| count   | OK     |</span><br><span class="line">+---------+--------+</span><br></pre></td></tr></table></figure>

<h4 id="3-2-4-创建-Azure-DMS-实例"><a href="#3-2-4-创建-Azure-DMS-实例" class="headerlink" title="3.2.4 创建 Azure DMS 实例"></a>3.2.4 创建 Azure DMS 实例</h4><p>登陆到 <a target="_blank" rel="noopener" href="https://portal.azure.cn/">Azure China Portal</a>，选择 <strong>All services -&gt; Azure Database Migration Services -&gt; 点击 Add</strong>：<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Instance.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Instance.jpg&quot;</a> “height:400px” width&#x3D;”800px” div align&#x3D;center&#x2F;&gt;</p>
<p>注意，Azure DMS 有 Standard 和 Premium 两个 SKU 可以选择，具体的性能指标和价格可以看<a target="_blank" rel="noopener" href="https://www.azure.cn/zh-cn/pricing/details/database-migration">这里</a>。本实验选择 Premium 的主要原因是 Premium SKU 支持 Online 的迁移。<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Project.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Project.jpg&quot;</a> “height:800px” width&#x3D;”800px” div align&#x3D;center&#x2F;&gt;</p>
<h4 id="3-2-5-在目标-Azure-MySQL-PaaS-上创建-Schema"><a href="#3-2-5-在目标-Azure-MySQL-PaaS-上创建-Schema" class="headerlink" title="3.2.5 在目标 Azure MySQL PaaS 上创建 Schema"></a>3.2.5 在目标 Azure MySQL PaaS 上创建 Schema</h4><p>通过 mysqldump 配合 –no-data 从 Aliyun RDS MySQL 导出 Schema SQL 并导入到 Azure MySQL PaaS 中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mysqldump -u<span class="string">&#x27;msadmin&#x27;</span> -p<span class="string">&#x27;Microsoft2019!&#x27;</span> -h<span class="string">&#x27;rm-uf626yx145z16o277so.mysql.rds.aliyuncs.com&#x27;</span> --databases <span class="string">&#x27;employees&#x27;</span> --no-data &gt; sourcedata.sql</span><br><span class="line">$ sed -e <span class="string">&#x27;s/DEFINER[ ]*=[ ]*[^*]*\*/\*/ &#x27;</span> sourcedata.sql &gt; sourcedatanew.sql</span><br><span class="line">$ awk <span class="string">&#x27;&#123; if (index($0,&quot;GTID_PURGED&quot;)) &#123; getline; while (length($0) &gt; 0) &#123; getline; &#125; &#125; else &#123; print $0 &#125; &#125;&#x27;</span> sourcedatanew.sql | grep -iv <span class="string">&#x27;set @@&#x27;</span> &gt; sourcedata.sql</span><br><span class="line">$ mysql -u<span class="string">&#x27;msadmin@mysql0001&#x27;</span> -p<span class="string">&#x27;Microsoft2019!&#x27;</span> -h<span class="string">&#x27;mysql0001.mysql.database.chinacloudapi.cn&#x27;</span> &lt; sourcedata.sql</span><br></pre></td></tr></table></figure>
<p>导入之后需要删除 Azure MySQL PaaS employees 库里的 Foreign Key(s)，查询外键的 SQL 如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ mysql&gt; SELECT SchemaName, GROUP_CONCAT(DropQuery SEPARATOR <span class="string">&#x27;;\n&#x27;</span>) as DropQuery, GROUP_CONCAT(AddQuery SEPARATOR <span class="string">&#x27;;\n&#x27;</span>) as AddQuery</span><br><span class="line">    -&gt; FROM</span><br><span class="line">    -&gt; (SELECT </span><br><span class="line">    -&gt; KCU.REFERENCED_TABLE_SCHEMA as SchemaName, KCU.TABLE_NAME, KCU.COLUMN_NAME,</span><br><span class="line">    -&gt; CONCAT(<span class="string">&#x27;ALTER TABLE &#x27;</span>, KCU.TABLE_NAME, <span class="string">&#x27; DROP FOREIGN KEY &#x27;</span>, KCU.CONSTRAINT_NAME) AS DropQuery,</span><br><span class="line">    -&gt;     CONCAT(<span class="string">&#x27;ALTER TABLE &#x27;</span>, KCU.TABLE_NAME, <span class="string">&#x27; ADD CONSTRAINT &#x27;</span>, KCU.CONSTRAINT_NAME, <span class="string">&#x27; FOREIGN KEY (`&#x27;</span>, KCU.COLUMN_NAME, <span class="string">&#x27;`) REFERENCES `&#x27;</span>, KCU.REFERENCED_TABLE_NAME, <span class="string">&#x27;` (`&#x27;</span>, KCU.REFERENCED_COLUMN_NAME, <span class="string">&#x27;`) ON UPDATE &#x27;</span>,RC.UPDATE_RULE, <span class="string">&#x27; ON DELETE &#x27;</span>,RC.DELETE_RULE) AS AddQuery</span><br><span class="line">    -&gt; FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE KCU, information_schema.REFERENTIAL_CONSTRAINTS RC</span><br><span class="line">    -&gt; WHERE</span><br><span class="line">    -&gt;   KCU.CONSTRAINT_NAME = RC.CONSTRAINT_NAME</span><br><span class="line">    -&gt;   AND KCU.REFERENCED_TABLE_SCHEMA = RC.UNIQUE_CONSTRAINT_SCHEMA) Queries</span><br><span class="line">    -&gt;   GROUP BY SchemaName;</span><br></pre></td></tr></table></figure>
<p>选择出结果中关于 Drop 的语句并执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use employees;</span><br><span class="line">mysql&gt; ALTER TABLE dept_emp DROP FOREIGN KEY dept_emp_ibfk_1;</span><br><span class="line">mysql&gt; ALTER TABLE dept_emp DROP FOREIGN KEY dept_emp_ibfk_2;</span><br><span class="line">mysql&gt; ALTER TABLE dept_manager DROP FOREIGN KEY dept_manager_ibfk_1;</span><br><span class="line">mysql&gt; ALTER TABLE dept_manager DROP FOREIGN KEY dept_manager_ibfk_2;</span><br><span class="line">mysql&gt; ALTER TABLE salaries DROP FOREIGN KEY salaries_ibfk_1;</span><br><span class="line">mysql&gt; ALTER TABLE titles DROP FOREIGN KEY titles_ibfk_1;</span><br></pre></td></tr></table></figure>
<p>至此，Schema 在 Azure MySQL PaaS 上迁移完毕。</p>
<h4 id="3-2-5-创建-Migration-Project-并做-Online-Migration"><a href="#3-2-5-创建-Migration-Project-并做-Online-Migration" class="headerlink" title="3.2.5 创建 Migration Project 并做 Online Migration"></a>3.2.5 创建 Migration Project 并做 Online Migration</h4><p>创建过程按照 Migration Wizards 一步一步操作即可，注意需要在 Azure MySQL PaaS 上配置允许 Azure DMS 的访问，Source Database 类型选择 MySQL 或者 Amazon RDS MySQL 都可以。</p>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Source-Aliyun.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Source-Aliyun.jpg&quot;</a> “height:600px” width&#x3D;”600px” div align&#x3D;center&#x2F;&gt;<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Target-Azure.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Target-Azure.jpg&quot;</a> “height:600px” width&#x3D;”600px” div align&#x3D;center&#x2F;&gt;<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Select-Database.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Select-Database.jpg&quot;</a> “height:600px” width&#x3D;”600px” div align&#x3D;center&#x2F;&gt;</p>
<p>配置好之后，直接 Run Migration 就可以开始做迁移了，迁移结束后的状态如图所示。值得注意的是，由于选择的迁移类型是 Online 的，所以迁移结束后，DMS 还处于 Running 状态。如果此时需要停止，可以进行 Cutover。</p>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Migration.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Migration.jpg&quot;</a> “height:800px” width&#x3D;”800px” div align&#x3D;center&#x2F;&gt;</p>
<p>离线迁移做完，现在我们模拟在 Aliyun RDS MySQL 的实时写入并在 Azure MySQL PaaS 上查看异步同步的数据来模拟 Online 迁移。具体写入 employees 库的 employees 表，插入主键 emp_no 范围在 10 ~ 153 这 144 条记录，为了避免冲突，可以考虑先在插入之前用 SQL Query 确认一下是否有插入的字段。插入脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> time <span class="keyword">in</span> $(<span class="built_in">seq</span> 10 153)</span><br><span class="line">&gt; <span class="keyword">do</span></span><br><span class="line">&gt; mysql -u<span class="string">&#x27;msadmin&#x27;</span> -p<span class="string">&#x27;Microsoft2019!&#x27;</span> -h<span class="string">&#x27;rm-uf626yx145z16o277so.mysql.rds.aliyuncs.com&#x27;</span> -e <span class="string">&quot;INSERT INTO employees.employees (emp_no, first_name, last_name) VALUES (&#x27;<span class="variable">$time</span>&#x27;, &#x27;Xinsheng<span class="variable">$time</span>&#x27;, &#x27;Wang<span class="variable">$time</span>&#x27;);&quot;</span></span><br><span class="line">&gt; <span class="built_in">sleep</span> 1</span><br><span class="line">&gt; <span class="keyword">done</span> </span><br></pre></td></tr></table></figure>
<p>为了方便更直观的查看结果，该结果使用 Navicat 12 连接数据库，具体插入同步结果如下：<br><strong>Aliyun RDS MySQL</strong><br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Aliyun-RDS-MySQL-Insert.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Aliyun-RDS-MySQL-Insert.jpg&quot;</a> “height:600px” width&#x3D;”600px” div align&#x3D;center&#x2F;&gt;</p>
<p><strong>Azure MySQL PaaS</strong><br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-MySQL-PaaS-Insert.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-MySQL-PaaS-Insert.jpg&quot;</a> “height:600px” width&#x3D;”600px” div align&#x3D;center&#x2F;&gt;</p>
<p><strong>144条记录同步确认</strong><br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Sync.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-DMS-Sync.jpg&quot;</a> “height:800px” width&#x3D;”800px” div align&#x3D;center&#x2F;&gt;</p>
<p>通过 Azure DMS 可以看出来异步同步的记录数量，同时查询数据库也可以做双重验证。<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-MySQL-PaaS-DoubleCheck.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-12-09-AzureDMS/Azure-MySQL-PaaS-DoubleCheck.jpg&quot;</a> “height:600px” width&#x3D;”600px” div align&#x3D;center&#x2F;&gt;</p>
<p>除此之外，Azure DMS 也能够根据写入的速度、频率及数据量大小来评估出来应用程序在做 Cutover 的时候的停机时间，这也是非常的人性化了。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>至此，跨云平台的 MySQL PaaS 迁移已经完成了，通过 Azure DMS 可以做到 Online 的数据库迁移至 Azure 并且能够给出校验结果。但是本文还有一些可以优化的场景，比如说 Azure DMS 的迁移可以通过 VPN 链路，VPN 通过两朵云的 VPN Gateway 打通即可，亲测可行，篇幅有限就不放在这篇博客了，留给大家自己测试吧。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://theodorew.github.io/wxsblog.github.io/2019/12/09/2019-12-09-AzureDMS/" data-id="claq92fmh00059nxza7a6ek01" class="article-share-link" data-share="baidu" data-title="Azure Database Migration Service — 数据库迁移到 Microsoft Azure 平台的好帮手">Share</a>
      

      

      
        <a class="article-reward-link">Reward</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Database/" rel="tag">Database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Microsoft-Azure/" rel="tag">Microsoft Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/MySQL/" rel="tag">MySQL</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2019-11-18-FlinkonAKS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/wxsblog.github.io/2019/11/17/2019-11-18-FlinkonAKS/" class="article-date">
  <time datetime="2019-11-17T02:23:32.000Z" itemprop="datePublished">2019-11-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/">Microsoft Azure</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/">Kubernetes</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/">Bigdata</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/Flink/">Flink</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/Flink/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/wxsblog.github.io/2019/11/17/2019-11-18-FlinkonAKS/">新一代大数据计算框架 Flink 与 Microsoft Azure Kubernetes 集成来做流批计算</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p><a href="https://theodorew.github.io/wxsblog.github.io/2019/01/18/2019-10-13-SparkonAKS/">上一篇</a>，我们验证测试了 Apache Spark 和 Azure Kubernetes Service 的集成，包括通过 Cluster Mode 依托 AKS 集群运行 Spark 作业以及和 Azure Blob Storage 集成来做计算存储的解耦分离。和传统的资源调度框架 Hadoop Yarn 相比， 使用 Azure Kubernetes Service 提高了部署速度和效率，提高灵活性并一定程度降低了运维管理成本。Spark 在强大的社区支撑下，技术的成熟度是在几大大数据计算框架中最高也是最全面的。但是除了 Spark，在大数据计算框架中还有一颗冉冉升起的新星，It is Apache Flink。本文我们来聊聊 Apache Flink 以及如何与 Azure Kubernetes Service 集成来做流批计算。</p>
<h2 id="2-Apahce-Flink-介绍"><a href="#2-Apahce-Flink-介绍" class="headerlink" title="2. Apahce Flink 介绍"></a>2. Apahce Flink 介绍</h2><p>Apache Flink 是一个分布式大数据处理引擎，可对有限数据流和无限数据流进行有状态或无状态的计算，能够部署在各种集群环境，对各种规模大小的数据进行快速计算。<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink.jpg&quot;</a> “height:1000px” width&#x3D;”1000px” div align&#x3D;center&#x2F;&gt;<br>（from: <a target="_blank" rel="noopener" href="https://flink.apache.org/">https://flink.apache.org/</a>)</p>
<p>Flink 的代码主要是由 Java 语言实现的，部分代码是 Scala，提供主流的 Java 及 Scala API，并且从 1.0 版本开始也提供 Python API 即 Pyflink。对 Flink 而言，其所要处理的主要场景就是 Streaming 流数据，Batch 批数据只是流数据的一个时间维度上的特例而已，所以 Flink 是一款真正的流批统一的计算引擎，这种设计思路对于某些业务场景可以提高代码的复用率，所以这也是 Flink 被很多大厂接受并广泛使用的原因之一。下面我们来看看 Flink 的内部架构：</p>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flinkarch.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flinkarch.jpg&quot;</a> “height:600px” width&#x3D;”600px” div align&#x3D;center&#x2F;&gt;</p>
<p>从下至上来看：<br><strong>部署：</strong> Flink 支持本地运行（IDE 中直接运行程序）、能在独立集群（Standalone 模式）或者在被 YARN、Mesos、K8s 管理的集群上运行，也能部署在云上。<br><strong>运行：</strong>Flink 的核心是分布式流式数据引擎，意味着数据以一次一个事件的形式被处理。<br><strong>API：</strong>DataStream、DataSet、Table、SQL API。<br><strong>扩展库：</strong>Flink 还包括用于 CEP（复杂事件处理）、机器学习、图形处理等场景。</p>
<p>本文仅调研 Flink on Azure Kubernetes 并做流批场景的技术可行性验证，对于其他部署模式不展开讨论，有兴趣的同学可以自行研究。</p>
<h2 id="3-Flink-on-AKS-实现"><a href="#3-Flink-on-AKS-实现" class="headerlink" title="3. Flink on AKS 实现"></a>3. Flink on AKS 实现</h2><p>本实验需要正确安装 Azure Cli、Terraform，Kubectl、Docker 等软件包，详细步骤请参考相应文档，本文不进行赘述。具体的操作过程在 AKS Vnet 的一台内网服务器上进行，该服务器作为 Flink 集群的跳板机使用。</p>
<h3 id="3-1-创建-AKS-集群、ACR-及跳板机"><a href="#3-1-创建-AKS-集群、ACR-及跳板机" class="headerlink" title="3.1 创建 AKS 集群、ACR 及跳板机"></a>3.1 创建 AKS 集群、ACR 及跳板机</h3><p>为了提高效率，本文直接使用 Terraform 来做自动化一键部署，Terraform 的介绍不做赘述，同学们自行搜索吧。废话少说，直接上 Code，具体 Terraform Azure 的用法可以参考<a target="_blank" rel="noopener" href="https://www.terraform.io/docs/providers/azurerm/index.html">这里</a>。本文按照 Terraform 的最佳实践结构设计，由于 variables.tf 包含一些个人 Azure 账号信息，所以本文只展现主要的 azure-aks.tf 文件，内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configure the Microsoft Azure Provider</span></span><br><span class="line">provider <span class="string">&quot;azurerm&quot;</span> &#123;</span><br><span class="line">    subscription_id = <span class="string">&quot;<span class="variable">$&#123;var.subscription_id&#125;</span>&quot;</span></span><br><span class="line">    client_id       = <span class="string">&quot;<span class="variable">$&#123;var.client_id&#125;</span>&quot;</span></span><br><span class="line">    client_secret   = <span class="string">&quot;<span class="variable">$&#123;var.client_secret&#125;</span>&quot;</span></span><br><span class="line">    tenant_id       = <span class="string">&quot;<span class="variable">$&#123;var.tenant_id&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a resource group if it doesn’t exist</span></span><br><span class="line">resource <span class="string">&quot;azurerm_resource_group&quot;</span> <span class="string">&quot;myterraformgroup&quot;</span> &#123;</span><br><span class="line">    name     = <span class="string">&quot;<span class="variable">$&#123;var.resource_group_name&#125;</span>&quot;</span></span><br><span class="line">    location = <span class="string">&quot;<span class="variable">$&#123;var.location&#125;</span>&quot;</span></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create virtual network</span></span><br><span class="line">resource <span class="string">&quot;azurerm_virtual_network&quot;</span> <span class="string">&quot;myterraformnetwork&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;<span class="variable">$&#123;var.vnet_name&#125;</span>&quot;</span></span><br><span class="line">    address_space       = <span class="string">&quot;<span class="variable">$&#123;var.vnet_address_space&#125;</span>&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create Network Security Group and rule</span></span><br><span class="line">resource <span class="string">&quot;azurerm_network_security_group&quot;</span> <span class="string">&quot;public_nsg&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;<span class="variable">$&#123;var.public_nsg&#125;</span>&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;SSH&quot;</span></span><br><span class="line">        priority                   = 1001</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;22&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_network_security_group&quot;</span> <span class="string">&quot;op_nsg&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;<span class="variable">$&#123;var.op_nsg&#125;</span>&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;SSH&quot;</span></span><br><span class="line">        priority                   = 1001</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;22&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_network_security_group&quot;</span> <span class="string">&quot;aks_nsg&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;<span class="variable">$&#123;var.aks_nsg&#125;</span>&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;SSH&quot;</span></span><br><span class="line">        priority                   = 1001</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;22&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;AKSWebUI&quot;</span></span><br><span class="line">        priority                   = 1002</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;8081&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create subnet</span></span><br><span class="line">resource <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;public_subnet&quot;</span> &#123;</span><br><span class="line">    name                 = <span class="string">&quot;<span class="variable">$&#123;var.public_subnet&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name  = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    virtual_network_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_virtual_network.myterraformnetwork.name&#125;</span>&quot;</span></span><br><span class="line">    address_prefix       = <span class="string">&quot;<span class="variable">$&#123;var.public_subnet_address_prefix&#125;</span>&quot;</span></span><br><span class="line">    network_security_group_id = <span class="string">&quot;<span class="variable">$&#123;azurerm_network_security_group.public_nsg.id&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;op_subnet&quot;</span> &#123;</span><br><span class="line">    name                 = <span class="string">&quot;<span class="variable">$&#123;var.op_subnet&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name  = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    virtual_network_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_virtual_network.myterraformnetwork.name&#125;</span>&quot;</span></span><br><span class="line">    address_prefix       = <span class="string">&quot;<span class="variable">$&#123;var.op_subnet_address_prefix&#125;</span>&quot;</span></span><br><span class="line">    network_security_group_id = <span class="string">&quot;<span class="variable">$&#123;azurerm_network_security_group.public_nsg.id&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;aks_subnet&quot;</span> &#123;</span><br><span class="line">    name                 = <span class="string">&quot;<span class="variable">$&#123;var.aks_subnet&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name  = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    virtual_network_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_virtual_network.myterraformnetwork.name&#125;</span>&quot;</span></span><br><span class="line">    address_prefix       = <span class="string">&quot;<span class="variable">$&#123;var.aks_subnet_address_prefix&#125;</span>&quot;</span></span><br><span class="line">    network_security_group_id = <span class="string">&quot;<span class="variable">$&#123;azurerm_network_security_group.aks_nsg.id&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create Azure Kubernetes Service Cluster</span></span><br><span class="line">resource <span class="string">&quot;azurerm_log_analytics_workspace&quot;</span> <span class="string">&quot;myterraform_log_analytics_workspace&quot;</span> &#123;</span><br><span class="line">    <span class="comment"># The WorkSpace name has to be unique across the whole of azure, not just the current subscription/tenant.</span></span><br><span class="line">    name                = <span class="string">&quot;<span class="variable">$&#123;var.log_analytics_workspace_name&#125;</span>&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    sku                 = <span class="string">&quot;<span class="variable">$&#123;var.log_analytics_workspace_sku&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_log_analytics_solution&quot;</span> <span class="string">&quot;myterraform_log_analytics_solution&quot;</span> &#123;</span><br><span class="line">    solution_name         = <span class="string">&quot;ContainerInsights&quot;</span></span><br><span class="line">    location              = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name   = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    workspace_resource_id = <span class="string">&quot;<span class="variable">$&#123;azurerm_log_analytics_workspace.myterraform_log_analytics_workspace.id&#125;</span>&quot;</span></span><br><span class="line">    workspace_name        = <span class="string">&quot;<span class="variable">$&#123;azurerm_log_analytics_workspace.myterraform_log_analytics_workspace.name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    plan &#123;</span><br><span class="line">        publisher = <span class="string">&quot;Microsoft&quot;</span></span><br><span class="line">        product   = <span class="string">&quot;OMSGallery/ContainerInsights&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_kubernetes_cluster&quot;</span> <span class="string">&quot;myterraform_kubernetes_cluster&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;<span class="variable">$&#123;var.azure_kubernetes_service_cluster_name&#125;</span>&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    dns_prefix          = <span class="string">&quot;<span class="variable">$&#123;var.azure_kubernetes_service_dns_prefix&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    kubernetes_version = <span class="string">&quot;<span class="variable">$&#123;var.azure_kubernetes_service_cluster_version&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    linux_profile &#123;</span><br><span class="line">        admin_username = <span class="string">&quot;<span class="variable">$&#123;var.admin_username&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        ssh_key &#123;</span><br><span class="line">            key_data = <span class="string">&quot;<span class="variable">$&#123;var.ssh_public_key_data&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    agent_pool_profile &#123;</span><br><span class="line">        name            = <span class="string">&quot;agentpool&quot;</span></span><br><span class="line">        count           = <span class="string">&quot;<span class="variable">$&#123;var.agent_count&#125;</span>&quot;</span></span><br><span class="line">        vm_size         = <span class="string">&quot;Standard_D4s_v3&quot;</span></span><br><span class="line">        os_type         = <span class="string">&quot;Linux&quot;</span></span><br><span class="line">        os_disk_size_gb = 30</span><br><span class="line">        vnet_subnet_id  = <span class="string">&quot;<span class="variable">$&#123;azurerm_subnet.aks_subnet.id&#125;</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    network_profile &#123;</span><br><span class="line">        network_plugin = <span class="string">&quot;azure&quot;</span></span><br><span class="line">        network_policy = <span class="string">&quot;azure&quot;</span></span><br><span class="line">        dns_service_ip = <span class="string">&quot;10.0.0.10&quot;</span></span><br><span class="line">        docker_bridge_cidr = <span class="string">&quot;172.17.0.1/16&quot;</span></span><br><span class="line">        service_cidr = <span class="string">&quot;10.0.0.0/16&quot;</span></span><br><span class="line">        load_balancer_sku = <span class="string">&quot;standard&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    role_based_access_control &#123;</span><br><span class="line">        enabled = <span class="string">&quot;true&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addon_profile &#123;</span><br><span class="line">        oms_agent &#123;</span><br><span class="line">            enabled                    = <span class="string">&quot;true&quot;</span></span><br><span class="line">            log_analytics_workspace_id = <span class="string">&quot;<span class="variable">$&#123;azurerm_log_analytics_workspace.myterraform_log_analytics_workspace.id&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    service_principal &#123;</span><br><span class="line">        client_id       = <span class="string">&quot;<span class="variable">$&#123;var.client_id&#125;</span>&quot;</span></span><br><span class="line">        client_secret   = <span class="string">&quot;<span class="variable">$&#123;var.client_secret&#125;</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        Environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create Azure Container Registry</span></span><br><span class="line">resource <span class="string">&quot;azurerm_container_registry&quot;</span> <span class="string">&quot;myterraform_container_registry&quot;</span> &#123;</span><br><span class="line">  name                     = <span class="string">&quot;<span class="variable">$&#123;var.azure_container_registry_name&#125;</span>&quot;</span></span><br><span class="line">  resource_group_name      = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">  location                 = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">  sku                      = <span class="string">&quot;Premium&quot;</span></span><br><span class="line">  admin_enabled            = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create AKS JumperVM</span></span><br><span class="line">resource <span class="string">&quot;azurerm_public_ip&quot;</span> <span class="string">&quot;aks_jumpervm0001_pip&quot;</span> &#123;</span><br><span class="line">    name                         = <span class="string">&quot;<span class="variable">$&#123;var.aks_jumpervm_name&#125;</span>&quot;</span></span><br><span class="line">    location                     = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name          = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    allocation_method            = <span class="string">&quot;Static&quot;</span></span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_network_interface&quot;</span> <span class="string">&quot;aks_jumpervm0001_nic&quot;</span> &#123;</span><br><span class="line">    name                        = <span class="string">&quot;<span class="variable">$&#123;var.aks_jumpervm_nic_name&#125;</span>&quot;</span></span><br><span class="line">    location                    = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name         = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    ip_configuration &#123;</span><br><span class="line">        name                          = <span class="string">&quot;<span class="variable">$&#123;var.aks_jumpervm_nic_name&#125;</span>&quot;</span></span><br><span class="line">        subnet_id                     = <span class="string">&quot;<span class="variable">$&#123;azurerm_subnet.aks_subnet.id&#125;</span>&quot;</span></span><br><span class="line">        private_ip_address_allocation = <span class="string">&quot;Dynamic&quot;</span></span><br><span class="line">        public_ip_address_id          = <span class="string">&quot;<span class="variable">$&#123;azurerm_public_ip.aks_jumpervm0001_pip.id&#125;</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create virtual machine</span></span><br><span class="line">resource <span class="string">&quot;azurerm_virtual_machine&quot;</span> <span class="string">&quot;aksjumpervm0001&quot;</span> &#123;</span><br><span class="line">    name                  = <span class="string">&quot;<span class="variable">$&#123;var.aks_jumpervm_name&#125;</span>&quot;</span></span><br><span class="line">    location              = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name   = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    network_interface_ids = [<span class="string">&quot;<span class="variable">$&#123;azurerm_network_interface.aks_jumpervm0001_nic.id&#125;</span>&quot;</span>]</span><br><span class="line">    vm_size               = <span class="string">&quot;Standard_D2s_v3&quot;</span></span><br><span class="line"></span><br><span class="line">    storage_os_disk &#123;</span><br><span class="line">        name              = <span class="string">&quot;<span class="variable">$&#123;var.aks_jumpervm_name&#125;</span>OsDisk&quot;</span></span><br><span class="line">        caching           = <span class="string">&quot;ReadWrite&quot;</span></span><br><span class="line">        create_option     = <span class="string">&quot;FromImage&quot;</span></span><br><span class="line">        managed_disk_type = <span class="string">&quot;Standard_LRS&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    storage_image_reference &#123;</span><br><span class="line">        <span class="built_in">id</span> = <span class="string">&quot;/subscriptions/xxxx-xxxx-xxxx-xxxx-xxxx/resourceGroups/xxxx-xxxx/providers/Microsoft.Compute/images/xxxx&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    os_profile &#123;</span><br><span class="line">        computer_name  = <span class="string">&quot;<span class="variable">$&#123;var.aks_jumpervm_name&#125;</span>&quot;</span></span><br><span class="line">        admin_username = <span class="string">&quot;azureuser&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    os_profile_linux_config &#123;</span><br><span class="line">        disable_password_authentication = <span class="literal">true</span></span><br><span class="line">        ssh_keys &#123;</span><br><span class="line">            path     = <span class="string">&quot;/home/azureuser/.ssh/authorized_keys&quot;</span></span><br><span class="line">            key_data = <span class="string">&quot;<span class="variable">$&#123;var.ssh_public_key_data&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有资源会在 10 分钟以内部署完成。</p>
<h3 id="3-2-获取-AKS-Credential-并查看-AKS-Cluster-信息："><a href="#3-2-获取-AKS-Credential-并查看-AKS-Cluster-信息：" class="headerlink" title="3.2 获取 AKS Credential 并查看 AKS Cluster 信息："></a>3.2 获取 AKS Credential 并查看 AKS Cluster 信息：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az aks get-credentials --resource-group aksrg001 --name akscluster001</span><br></pre></td></tr></table></figure>
<p>集群节点信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get node</span><br><span class="line">NAME                       STATUS   ROLES   AGE   VERSION</span><br><span class="line">aks-agentpool-26667448-0   Ready    agent   17m   v1.14.8</span><br><span class="line">aks-agentpool-26667448-1   Ready    agent   16m   v1.14.8</span><br><span class="line">aks-agentpool-26667448-2   Ready    agent   16m   v1.14.8</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Docker-Login-登陆-ACR-Azure-Container-Registry"><a href="#3-3-Docker-Login-登陆-ACR-Azure-Container-Registry" class="headerlink" title="3.3 Docker Login 登陆 ACR (Azure Container Registry)"></a>3.3 Docker Login 登陆 ACR (Azure Container Registry)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login aksacr001.azurecr.io</span><br></pre></td></tr></table></figure>

<h3 id="3-4-Flink-Streaming-on-AKS"><a href="#3-4-Flink-Streaming-on-AKS" class="headerlink" title="3.4 Flink Streaming on AKS"></a>3.4 Flink Streaming on AKS</h3><h4 id="3-4-1-Streaming-任务示例"><a href="#3-4-1-Streaming-任务示例" class="headerlink" title="3.4.1 Streaming 任务示例"></a>3.4.1 Streaming 任务示例</h4><p>该任务会从某个端口中读取文本，分割为单词，并且每 5 秒钟打印一次每个单词出现的次数。以下代码是从 <a target="_blank" rel="noopener" href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/datastream_api.html#example-program">Flink 官方文档</a> 上获取来的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.FlatMapFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.Time;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WindowWordCount</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; dataStream = env</span><br><span class="line">                .socketTextStream(<span class="string">&quot;10.11.4.4&quot;</span>, <span class="number">9999</span>)</span><br><span class="line">                .flatMap(<span class="keyword">new</span> <span class="title class_">Splitter</span>())</span><br><span class="line">                .keyBy(<span class="number">0</span>)</span><br><span class="line">                .timeWindow(Time.seconds(<span class="number">5</span>))</span><br><span class="line">                .sum(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        dataStream.print();</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">&quot;Window WordCount&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Splitter</span> <span class="keyword">implements</span> <span class="title class_">FlatMapFunction</span>&lt;String, Tuple2&lt;String, Integer&gt;&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap</span><span class="params">(String sentence, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">for</span> (String word: sentence.split(<span class="string">&quot; &quot;</span>)) &#123;</span><br><span class="line">                out.collect(<span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;String, Integer&gt;(word, <span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来执行 mvn clean package 命令，打包好的 Jar 文件路径为 target&#x2F;flink-on-kubernetes-1.0.0-SNAPSHOT-jar-with-dependencies.jar。</p>
<h4 id="3-4-2-构建自定义-Flink-Docker-镜像并推送至-ACR"><a href="#3-4-2-构建自定义-Flink-Docker-镜像并推送至-ACR" class="headerlink" title="3.4.2 构建自定义 Flink Docker 镜像并推送至 ACR"></a>3.4.2 构建自定义 Flink Docker 镜像并推送至 ACR</h4><p>Flink 在 <a target="_blank" rel="noopener" href="https://hub.docker.com/_/flink">DockerHub</a> 上提供了一个官方的容器镜像，我们可以以该镜像为基础，构建独立的 Flink 镜像，主要就是将自定义 Jar 包打到镜像里面去。此外，新版 Flink 已将 Hadoop 依赖从官方发行版中剥离，因此我们在打镜像时也需要包含进去。官方的 <a target="_blank" rel="noopener" href="https://github.com/docker-flink/docker-flink/blob/master/1.9/scala_2.12-debian/Dockerfile">Dockerfile</a> 主要做了将 OpenJDK 1.8 作为 JDK 环境，下载并安装 Flink 至 &#x2F;opt&#x2F;flink，同时添加 flink 用户和组等。我们在此基础上构建自定义 Flink 镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FROM flink:1.9.1-scala_2.12</span><br><span class="line"></span><br><span class="line">ARG hadoop_jar</span><br><span class="line">ARG job_jar</span><br><span class="line"></span><br><span class="line">ENV FLINK_CONF=<span class="variable">$FLINK_HOME</span>/conf/flink-conf.yaml</span><br><span class="line"></span><br><span class="line">RUN <span class="built_in">set</span> -x &amp;&amp; \</span><br><span class="line">  sed -i -e <span class="string">&quot;s/jobmanager\.heap\.size:.*/jobmanager.heap.size: 128m/g&quot;</span> <span class="variable">$FLINK_CONF</span> &amp;&amp; \</span><br><span class="line">  sed -i -e <span class="string">&quot;s/taskmanager\.heap\.size:.*/taskmanager.heap.size: 256m/g&quot;</span> <span class="variable">$FLINK_CONF</span></span><br><span class="line"></span><br><span class="line">COPY --<span class="built_in">chown</span>=flink:flink <span class="variable">$hadoop_jar</span> <span class="variable">$job_jar</span> <span class="variable">$FLINK_HOME</span>/lib/</span><br><span class="line"></span><br><span class="line">USER flink</span><br></pre></td></tr></table></figure>
<p>注：hadoop_jar 从<a target="_blank" rel="noopener" href="https://repo.maven.apache.org/maven2/org/apache/flink/flink-shaded-hadoop-2-uber/2.8.3-7.0/flink-shaded-hadoop-2-uber-2.8.3-7.0.jar">这里</a>下载；job_jar 为刚刚编译打包好的 flink-on-kubernetes-1.0.0-SNAPSHOT-jar-with-dependencies.jar。下载好后做编译：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /path/to/Dockerfile</span><br><span class="line">$ <span class="built_in">cp</span> /path/to/flink-shaded-hadoop-2-uber-2.8.3-7.0.jar hadoop.jar</span><br><span class="line">$ <span class="built_in">cp</span> /path/to/flink-on-kubernetes-1.0.0-SNAPSHOT-jar-with-dependencies.jar job.jar</span><br><span class="line">$ docker build --build-arg hadoop_jar=hadoop.jar --build-arg job_jar=job.jar --tag flink-on-kubernetes:1.0.0 .</span><br></pre></td></tr></table></figure>
<p>查看镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker image <span class="built_in">ls</span></span><br><span class="line">REPOSITORY            TAG                 IMAGE ID            CREATED              SIZE</span><br><span class="line">flink-on-kubernetes   1.0.0               25a02549b943        8 seconds ago        575MB</span><br></pre></td></tr></table></figure>
<p>镜像推送至 ACR：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag flink-on-kubernetes:1.0.0 aksacr001.azurecr.io/flink-on-kubernetes:v1</span><br><span class="line">docker push aksacr001.azurecr.io/flink-on-kubernetes:v1</span><br></pre></td></tr></table></figure>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink_acr.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink_acr.jpg&quot;</a> “height:1000px” width&#x3D;”1000px” div align&#x3D;center&#x2F;&gt;</p>
<h4 id="3-4-3-构建-Flink-Streaming-JobManager-和-Service"><a href="#3-4-3-构建-Flink-Streaming-JobManager-和-Service" class="headerlink" title="3.4.3 构建 Flink Streaming JobManager 和 Service"></a>3.4.3 构建 Flink Streaming JobManager 和 Service</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ vi flink-streaming-on-aks-jobmanager.yml</span><br><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="variable">$&#123;JOB&#125;</span>-jobmanager</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: flink</span><br><span class="line">        instance: <span class="variable">$&#123;JOB&#125;</span>-jobmanager</span><br><span class="line">    spec:</span><br><span class="line">      restartPolicy: OnFailure</span><br><span class="line">      containers:</span><br><span class="line">      - name: jobmanager</span><br><span class="line">        image: aksacr001.azurecr.io/flink-on-kubernetes:v1</span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">&quot;/opt/flink/bin/standalone-job.sh&quot;</span>]</span><br><span class="line">        args: [<span class="string">&quot;start-foreground&quot;</span>,</span><br><span class="line">               <span class="string">&quot;-Djobmanager.rpc.address=<span class="variable">$&#123;JOB&#125;</span>-jobmanager&quot;</span>,</span><br><span class="line">               <span class="string">&quot;-Dparallelism.default=1&quot;</span>,</span><br><span class="line">               <span class="string">&quot;-Dblob.server.port=6124&quot;</span>,</span><br><span class="line">               <span class="string">&quot;-Dqueryable-state.server.ports=6125&quot;</span>]</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6123</span><br><span class="line">          name: rpc</span><br><span class="line">        - containerPort: 6124</span><br><span class="line">          name: blob</span><br><span class="line">        - containerPort: 6125</span><br><span class="line">          name: query</span><br><span class="line">        - containerPort: 8081</span><br><span class="line">          name: ui</span><br></pre></td></tr></table></figure>
<p>使用 kubectl 命令创建对象，并查看状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> JOB=flink-streaming-on-aks</span><br><span class="line">$ envsubst &lt;flink-streaming-on-aks-jobmanager.yml | kubectl apply -f -</span><br><span class="line">$ kubectl get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">flink-streaming-on-aks-jobmanager-xhkkc   1/1     Running   0          48s</span><br></pre></td></tr></table></figure>
<p>接着创建一个 Service 来将 JobManager 的端口开放出来，以便 TaskManager 做服务注册和调用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ vi flink-streaming-on-aks-service.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="variable">$&#123;JOB&#125;</span>-jobmanager</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: flink</span><br><span class="line">    instance: <span class="variable">$&#123;JOB&#125;</span>-jobmanager</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: rpc</span><br><span class="line">    port: 6123</span><br><span class="line">  - name: blob</span><br><span class="line">    port: 6124</span><br><span class="line">  - name: query</span><br><span class="line">    port: 6125</span><br><span class="line">  - name: ui</span><br><span class="line">    port: 8081</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ envsubst &lt;flink-streaming-on-aks-service.yml | kubectl apply -f -</span><br><span class="line">$ kubectl get svc flink-streaming-on-aks-jobmanager</span><br><span class="line">NAME                                TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)                                                       AGE</span><br><span class="line">flink-streaming-on-aks-jobmanager   NodePort   10.0.25.24   &lt;none&gt;        6123:32291/TCP,6124:30580/TCP,6125:30458/TCP,8081:30855/TCP   46s</span><br></pre></td></tr></table></figure>

<h4 id="3-4-4-构建-Flink-Streaming-TaskManager"><a href="#3-4-4-构建-Flink-Streaming-TaskManager" class="headerlink" title="3.4.4 构建 Flink Streaming TaskManager"></a>3.4.4 构建 Flink Streaming TaskManager</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ vi flink-streaming-on-aks-taskmanager.yml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="variable">$&#123;JOB&#125;</span>-taskmanager</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: flink</span><br><span class="line">      instance: <span class="variable">$&#123;JOB&#125;</span>-taskmanager</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: flink</span><br><span class="line">        instance: <span class="variable">$&#123;JOB&#125;</span>-taskmanager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: taskmanager</span><br><span class="line">        image: aksacr001.azurecr.io/flink-on-kubernetes:v1</span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">&quot;/opt/flink/bin/taskmanager.sh&quot;</span>]</span><br><span class="line">        args: [<span class="string">&quot;start-foreground&quot;</span>, <span class="string">&quot;-Djobmanager.rpc.address=<span class="variable">$&#123;JOB&#125;</span>-jobmanager&quot;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ envsubst &lt;flink-streaming-on-aks-taskmanager.yml | kubectl apply -f -</span><br><span class="line">$ kubectl get pods</span><br><span class="line">NAME                                                 READY   STATUS              RESTARTS   AGE</span><br><span class="line">flink-streaming-on-aks-jobmanager-xhkkc              1/1     Running             0          19m</span><br><span class="line">flink-streaming-on-aks-taskmanager-b9df9657d-2vnrt   0/1     Running   0          5s</span><br><span class="line">flink-streaming-on-aks-taskmanager-b9df9657d-5nx95   0/1     Running   0          6s</span><br><span class="line">flink-streaming-on-aks-taskmanager-b9df9657d-g2p7w   0/1     Running   0          5s</span><br></pre></td></tr></table></figure>
<p>目前启动了 JobManager 和 TaskManager 的 AKS Pods 作为整个 Streaming 流计算任务的计算资源，下面进行实时计算任务测试。Flink WebUI如下：<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink_streaming_ui.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink_streaming_ui.jpg&quot;</a> “height:1000px” width&#x3D;”1000px” div align&#x3D;center&#x2F;&gt;<br>Flink JobManager 的 WebUI 可以清晰看到 Job 以及整个 Flink Job 的 Pipeline，包括所有的 Log 和 GC 的情况也有显示。</p>
<h4 id="3-4-5-Flink-Streaming-Job-运行和结果"><a href="#3-4-5-Flink-Streaming-Job-运行和结果" class="headerlink" title="3.4.5 Flink Streaming Job 运行和结果"></a>3.4.5 Flink Streaming Job 运行和结果</h4><p>还记得 3.6.1 的 Java 代码吗？ 此时我们需要通过 nc 命令打开 9999 端口，然后输入 messages (输出系统日志来模拟) ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ nc -lk 9999</span><br><span class="line">Sep 18 05:17:16 localhost journal: Runtime journal is using 8.0M (max allowed 398.2M, trying to leave 597.3M free of 3.8G available → current <span class="built_in">limit</span> 398.2M).</span><br><span class="line"></span><br><span class="line">Sep 18 05:17:16 localhost kernel: Initializing cgroup subsys cpuset</span><br><span class="line">Sep 18 05:17:16 localhost kernel: Initializing cgroup subsys cpu</span><br><span class="line">Sep 18 05:17:16 localhost kernel: Initializing cgroup subsys cpuacct</span><br><span class="line"></span><br><span class="line">Sep 18 05:17:16 localhost kernel: BIOS-e820: [mem 0x0000000000000000-0x000000000009fbff] usable</span><br><span class="line">Sep 18 05:17:16 localhost kernel: BIOS-e820: [mem 0x000000000009fc00-0x000000000009ffff] reserved</span><br><span class="line">Sep 18 05:17:16 localhost kernel: BIOS-e820: [mem 0x00000000000e0000-0x00000000000fffff] reserved</span><br><span class="line">Sep 18 05:17:16 localhost kernel: BIOS-e820: [mem 0x0000000000100000-0x000000003ffeffff] usable</span><br><span class="line"></span><br><span class="line">Sep 18 05:17:16 localhost kernel: DMI: Microsoft Corporation Virtual Machine/Virtual Machine, BIOS 090007  06/02/2017</span><br><span class="line">Sep 18 05:17:16 localhost kernel: Hypervisor detected: Microsoft HyperV</span><br><span class="line">Sep 18 05:17:16 localhost kernel: HyperV: features 0x2e7f, hints 0x44c2c</span><br><span class="line">Sep 18 05:17:16 localhost kernel: Hyper-V Host Build:14393-10.0-0-0.299</span><br><span class="line">Sep 18 05:17:16 localhost kernel: HyperV: LAPIC Timer Frequency: 0x30d40</span><br></pre></td></tr></table></figure>
<p>Flink Streaming Job 实时结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs -f -l instance=<span class="variable">$JOB</span>-taskmanager</span><br><span class="line">(,4)</span><br><span class="line">(Sep,1)</span><br><span class="line">(398.2M).,1)</span><br><span class="line">(<span class="built_in">limit</span>,1)</span><br><span class="line">(current,1)</span><br><span class="line">(→,1)</span><br><span class="line">(available,1)</span><br><span class="line">(3.8G,1)</span><br><span class="line">(of,1)</span><br><span class="line">(free,1)</span><br><span class="line">(597.3M,1)</span><br><span class="line">(leave,1)</span><br><span class="line">(to,1)</span><br><span class="line">(trying,1)</span><br><span class="line">(398.2M,,1)</span><br><span class="line">(allowed,1)</span><br><span class="line">((max,1)</span><br><span class="line">(8.0M,1)</span><br><span class="line">(using,1)</span><br><span class="line">(is,1)</span><br><span class="line">(journal,1)</span><br><span class="line">(Runtime,1)</span><br><span class="line">(journal:,1)</span><br><span class="line">(localhost,1)</span><br><span class="line">(05:17:16,1)</span><br><span class="line">(18,1)</span><br><span class="line">(,2)</span><br><span class="line">(cpuacct,1)</span><br><span class="line">(cpu,1)</span><br><span class="line">(cpuset,1)</span><br><span class="line">(subsys,3)</span><br><span class="line">(cgroup,3)</span><br><span class="line">(Initializing,3)</span><br><span class="line">(kernel:,3)</span><br><span class="line">(localhost,3)</span><br><span class="line">(05:17:16,3)</span><br><span class="line">(18,3)</span><br><span class="line">(Sep,3)</span><br><span class="line">(Sep,4)</span><br><span class="line">(0x0000000000100000-0x000000003ffeffff],1)</span><br><span class="line">(0x00000000000e0000-0x00000000000fffff],1)</span><br><span class="line">(reserved,2)</span><br><span class="line">(0x000000000009fc00-0x000000000009ffff],1)</span><br><span class="line">(usable,2)</span><br><span class="line">(0x0000000000000000-0x000000000009fbff],1)</span><br><span class="line">([mem,4)</span><br><span class="line">(BIOS-e820:,4)</span><br><span class="line">(kernel:,4)</span><br><span class="line">(localhost,4)</span><br><span class="line">(05:17:16,4)</span><br><span class="line">(18,4)</span><br><span class="line">(,1)</span><br><span class="line">(Sep,5)</span><br><span class="line">(0x30d40,1)</span><br><span class="line">(Frequency:,1)</span><br><span class="line">(Timer,1)</span><br><span class="line">(LAPIC,1)</span><br><span class="line">(Build:14393-10.0-0-0.299,1)</span><br><span class="line">(Host,1)</span><br><span class="line">(Hyper-V,1)</span><br><span class="line">(0x44c2c,1)</span><br><span class="line">(hints,1)</span><br><span class="line">(0x2e7f,,1)</span><br><span class="line">(features,1)</span><br><span class="line">(HyperV:,2)</span><br><span class="line">(HyperV,1)</span><br><span class="line">(detected:,1)</span><br><span class="line">(Hypervisor,1)</span><br><span class="line">... 后面结果省略了 ...</span><br></pre></td></tr></table></figure>
<p>随着实时任务不断的输入追加，整个 Flink Streaming Job 都处于 Running 状态，永远都不会停下来。</p>
<h3 id="3-5-Flink-Batch-on-AKS"><a href="#3-5-Flink-Batch-on-AKS" class="headerlink" title="3.5 Flink Batch on AKS"></a>3.5 Flink Batch on AKS</h3><p>玩完 Streaming 流计算，我们再来看看批处理任务。其实批处理任务和流计算任务本属一家，只是时间维度上的特例，所以这也是 Flink 对流批任务处理的思想的统一。下面我们也运行同样的 WordCount 批处理任务来玩玩 Flink Batch on AKS。</p>
<h4 id="3-5-1-下载-Flink-二进制文件"><a href="#3-5-1-下载-Flink-二进制文件" class="headerlink" title="3.5.1 下载 Flink 二进制文件"></a>3.5.1 下载 Flink 二进制文件</h4><p>从 <a target="_blank" rel="noopener" href="https://www.apache.org/dyn/closer.lua/flink/flink-1.9.1/flink-1.9.1-bin-scala_2.12.tgz">Flink 官网</a> 选择合适的版本下载，本例中使用 1.9.1 版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://www-us.apache.org/dist/flink/flink-1.9.1/flink-1.9.1-bin-scala_2.12.tgz</span><br><span class="line">tar -zvxf flink-1.9.1-bin-scala_2.12.tgz</span><br></pre></td></tr></table></figure>
<h4 id="3-5-1-编写-ConfigMap-Yaml-文件"><a href="#3-5-1-编写-ConfigMap-Yaml-文件" class="headerlink" title="3.5.1 编写 ConfigMap Yaml 文件"></a>3.5.1 编写 ConfigMap Yaml 文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ vi flink-batch-on-aks-configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: flink-batch-on-aks-configmap</span><br><span class="line">  labels:</span><br><span class="line">    app: flink</span><br><span class="line">data:</span><br><span class="line">  flink-conf.yaml: |+</span><br><span class="line">    jobmanager.rpc.address: flink-jobmanager</span><br><span class="line">    taskmanager.numberOfTaskSlots: 1</span><br><span class="line">    blob.server.port: 6124</span><br><span class="line">    jobmanager.rpc.port: 6123</span><br><span class="line">    taskmanager.rpc.port: 6122</span><br><span class="line">    jobmanager.heap.size: 1024m</span><br><span class="line">    taskmanager.heap.size: 1024m</span><br><span class="line">  log4j.properties: |+</span><br><span class="line">    log4j.rootLogger=INFO, file</span><br><span class="line">    log4j.logger.akka=INFO</span><br><span class="line">    log4j.logger.org.apache.kafka=INFO</span><br><span class="line">    log4j.logger.org.apache.hadoop=INFO</span><br><span class="line">    log4j.logger.org.apache.zookeeper=INFO</span><br><span class="line">    log4j.appender.file=org.apache.log4j.FileAppender</span><br><span class="line">    log4j.appender.file.file=<span class="variable">$&#123;log.file&#125;</span></span><br><span class="line">    log4j.appender.file.layout=org.apache.log4j.PatternLayout</span><br><span class="line">    log4j.appender.file.layout.ConversionPattern=%d&#123;yyyy-MM-<span class="built_in">dd</span> HH:mm:ss,SSS&#125; %-5p %-60c %x - %m%n</span><br><span class="line">    log4j.logger.org.apache.flink.shaded.akka.org.jboss.netty.channel.DefaultChannelPipeline=ERROR, file</span><br></pre></td></tr></table></figure>
<p>创建并查看 ConfigMap：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f flink-batch-on-aks-configmap.yaml</span><br><span class="line">$ kubectl get cm</span><br><span class="line">NAME                           DATA   AGE</span><br><span class="line">flink-batch-on-aks-configmap   2      25s</span><br></pre></td></tr></table></figure>
<h4 id="3-5-2-编写-JobManager-Yaml-文件"><a href="#3-5-2-编写-JobManager-Yaml-文件" class="headerlink" title="3.5.2 编写 JobManager Yaml 文件"></a>3.5.2 编写 JobManager Yaml 文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ vi flink-batch-on-aks-jobmanager.yaml </span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: flink-batch-on-aks-jobmanager</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: flink</span><br><span class="line">        component: jobmanager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: jobmanager</span><br><span class="line">        image: aksacr001.azurecr.io/flink-on-kubernetes:v1</span><br><span class="line">        workingDir: /opt/flink</span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;<span class="variable">$FLINK_HOME</span>/bin/jobmanager.sh start;\</span></span><br><span class="line"><span class="string">          while :;</span></span><br><span class="line"><span class="string">          do</span></span><br><span class="line"><span class="string">            if [[ -f <span class="subst">$(find log -name &#x27;*jobmanager*.log&#x27; -print -quit)</span> ]];</span></span><br><span class="line"><span class="string">              then tail -f -n +1 log/*jobmanager*.log;</span></span><br><span class="line"><span class="string">            fi;</span></span><br><span class="line"><span class="string">          done&quot;</span>]</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6123</span><br><span class="line">          name: rpc</span><br><span class="line">        - containerPort: 6124</span><br><span class="line">          name: blob</span><br><span class="line">        - containerPort: 8081</span><br><span class="line">          name: ui</span><br><span class="line">        livenessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 6123</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 60</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: flink-config-volume</span><br><span class="line">          mountPath: /opt/flink/conf</span><br><span class="line">      volumes:</span><br><span class="line">      - name: flink-config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: flink-batch-on-aks-configmap</span><br><span class="line">          items:</span><br><span class="line">          - key: flink-conf.yaml</span><br><span class="line">            path: flink-conf.yaml</span><br><span class="line">          - key: log4j.properties</span><br><span class="line">            path: log4j.properties</span><br></pre></td></tr></table></figure>
<p>创建并查看 JobManager :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f flink-batch-on-aks-jobmanager.yaml</span><br><span class="line">$ kubectl get pods</span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">flink-batch-on-aks-jobmanager-7ddb5cf4bc-nh7b8   1/1     Running   0          7s</span><br></pre></td></tr></table></figure>
<h4 id="3-5-3-编写-TaskManager-Yaml-文件"><a href="#3-5-3-编写-TaskManager-Yaml-文件" class="headerlink" title="3.5.3 编写 TaskManager Yaml 文件"></a>3.5.3 编写 TaskManager Yaml 文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ vi flink-batch-on-aks-taskmanager.yml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: flink-batch-on-aks-taskmanager</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: flink</span><br><span class="line">        component: taskmanager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: taskmanager</span><br><span class="line">        image: aksacr001.azurecr.io/flink-on-kubernetes:v1</span><br><span class="line">        workingDir: /opt/flink</span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;<span class="variable">$FLINK_HOME</span>/bin/taskmanager.sh start; \</span></span><br><span class="line"><span class="string">          while :;</span></span><br><span class="line"><span class="string">          do</span></span><br><span class="line"><span class="string">            if [[ -f <span class="subst">$(find log -name &#x27;*taskmanager*.log&#x27; -print -quit)</span> ]];</span></span><br><span class="line"><span class="string">              then tail -f -n +1 log/*taskmanager*.log;</span></span><br><span class="line"><span class="string">            fi;</span></span><br><span class="line"><span class="string">          done&quot;</span>]</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6122</span><br><span class="line">          name: rpc</span><br><span class="line">        livenessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 6122</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 60</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: flink-config-volume</span><br><span class="line">          mountPath: /opt/flink/conf/</span><br><span class="line">      volumes:</span><br><span class="line">      - name: flink-config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: flink-batch-on-aks-configmap</span><br><span class="line">          items:</span><br><span class="line">          - key: flink-conf.yaml</span><br><span class="line">            path: flink-conf.yaml</span><br><span class="line">          - key: log4j.properties</span><br><span class="line">            path: log4j.properties </span><br></pre></td></tr></table></figure>
<p>创建并查看 TaskManager：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f flink-batch-on-aks-taskmanager.yaml</span><br><span class="line">$ kubectl get pods</span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">flink-batch-on-aks-jobmanager-7ddb5cf4bc-nh7b8   1/1     Running   0          2m28s</span><br><span class="line">flink-batch-on-aks-taskmanager-cdc4498b9-6pctv   1/1     Running   0          11s</span><br><span class="line">flink-batch-on-aks-taskmanager-cdc4498b9-kbkdf   1/1     Running   0          11s</span><br></pre></td></tr></table></figure>
<h4 id="3-5-4-编写-JobManager-Service-Yaml-文件"><a href="#3-5-4-编写-JobManager-Service-Yaml-文件" class="headerlink" title="3.5.4 编写 JobManager Service Yaml 文件"></a>3.5.4 编写 JobManager Service Yaml 文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ vi flink-batch-on-aks-jobmanager-service.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: flink-batch-on-aks-jobmanager</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - name: rpc</span><br><span class="line">    port: 6123</span><br><span class="line">  - name: blob</span><br><span class="line">    port: 6124</span><br><span class="line">  - name: ui</span><br><span class="line">    port: 8081</span><br><span class="line">  selector:</span><br><span class="line">    app: flink</span><br><span class="line">    component: jobmanager</span><br></pre></td></tr></table></figure>
<p>创建并查看 TaskManager Service :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f flink-batch-on-aks-jobmanager-service.yaml </span><br><span class="line">$ kubectl get svc</span><br><span class="line">NAME                            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">flink-batch-on-aks-jobmanager   ClusterIP   10.0.23.214   &lt;none&gt;        6123/TCP,6124/TCP,8081/TCP   7s</span><br></pre></td></tr></table></figure>
<h4 id="3-5-5-启动-Flink-UI-："><a href="#3-5-5-启动-Flink-UI-：" class="headerlink" title="3.5.5 启动 Flink UI ："></a>3.5.5 启动 Flink UI ：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl port-forward flink-batch-on-aks-jobmanager-7ddb5cf4bc-nh7b8 --address 0.0.0.0 8081:8081</span><br></pre></td></tr></table></figure>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink_batch_ui.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink_batch_ui.jpg&quot;</a> “height:1000px” width&#x3D;”1000px” div align&#x3D;center&#x2F;&gt;</p>
<h4 id="3-5-6-提交-Flink-Batch-Job-到-AKS-集群-："><a href="#3-5-6-提交-Flink-Batch-Job-到-AKS-集群-：" class="headerlink" title="3.5.6 提交 Flink Batch Job 到 AKS 集群 ："></a>3.5.6 提交 Flink Batch Job 到 AKS 集群 ：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/flink run -m 10.11.4.4:8081 ./examples/streaming/WordCount.jar --input ./input.txt</span><br><span class="line">Starting execution of program</span><br><span class="line">Printing result to stdout. Use --output to specify output path.</span><br><span class="line">Program execution finished</span><br><span class="line">Job with JobID 7a9037a6c6573a6a7f01f36e6e9d7382 has finished.</span><br><span class="line">Job Runtime: 138 ms</span><br></pre></td></tr></table></figure>
<p>可以通过 Flink Batch UI 查看计算结果。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>Flink 的思想是把一切任务都看作流来实现流批的计算。本文举例了 2 个场景，验证了在 AKS 上如何运行 Flink Streaming &amp; Batch 作业，希望能够给大家一些参考。但是本文也有很多其他场景并未考虑到，比如：JobManager HA、External Checkpoints (可以和 Azure Blob Storage集成)、动态的任务扩容、与 Eventhub 或 Kafka 的集成等等，这些场景留待大家自己发现和实践了。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://theodorew.github.io/wxsblog.github.io/2019/11/17/2019-11-18-FlinkonAKS/" data-id="claq92fmg00049nxz7w1s2epd" class="article-share-link" data-share="baidu" data-title="新一代大数据计算框架 Flink 与 Microsoft Azure Kubernetes 集成来做流批计算">Share</a>
      

      

      
        <a class="article-reward-link">Reward</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Bigdata/" rel="tag">Bigdata</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Flink/" rel="tag">Flink</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Kubernetes/" rel="tag">Kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Microsoft-Azure/" rel="tag">Microsoft Azure</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2019-10-13-SparkonAKS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/wxsblog.github.io/2019/10/13/2019-10-13-SparkonAKS/" class="article-date">
  <time datetime="2019-10-13T02:23:32.000Z" itemprop="datePublished">2019-10-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/">Microsoft Azure</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/">Kubernetes</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/">Bigdata</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/wxsblog.github.io/2019/10/13/2019-10-13-SparkonAKS/">强强联合! 利用 Microsoft Azure AKS 集群集成 Apache Spark 来做大数据计算</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-Azure-Kubernetes-Service-及-Apache-Spark-简介"><a href="#1-Azure-Kubernetes-Service-及-Apache-Spark-简介" class="headerlink" title="1. Azure Kubernetes Service 及 Apache Spark 简介"></a>1. Azure Kubernetes Service 及 Apache Spark 简介</h2><p>伴随着 Kubernetes 技术的日渐成熟和社区生态的蓬勃发展, 越来越多的客户都将自己很多的应用程序迁移到容器服务上, 以便能够设计出更加快速、便捷、更高可靠的应用架构. 为了提高 Kubernetes 集群的部署速度以及降低其运维成本, Microsoft Azure 推出了托管的 Kubernetes 服务 —— Azure Kubernetes Service (AKS).  AKS 带来了诸多优点, 如高可用的控制平面、Calico 等网络插件集成、Azure 服务无缝对接、与开源版本 Kubernetes 同步匹配、平滑迁移及无感知升级等。</p>
<p>在大数据处理与分析领域, 从技术的成熟度、稳定度以及社区活度程度来看, Apache Spark 是目前最流行的计算框架并在实际生产中处于重要地位并广泛使用. Apache Spark 支持 Standalone、Mesos 以及 YARN 等集群资源管理调度平台, 其中以 YARN 在实际生产中使用最为广泛, YARN 就是我们熟知的 Hadoop 平台的资源调度框架. 在计算存储不分离的架构下, 集群每个节点也会作为 Datanode 即采用 HDFS 分布式文件系统来进行数据存储. 但是随着数据量的爆炸式增长以及数据湖概念的日益普及, 计算与存储分离也逐渐成为了刚需. 为此, Microsoft Azure 也推出了满足以上需求的托管式 Hadoop 服务 —— Azure HDInsight 以及 Databricks. HDInsight 是 HDP 版本 Hadoop 在 Azure 云上的托管服务, Databricks 是著名 Spark 创始人完全基于 Apache Spark 并针对 Microsoft Azure 云服务平台进行优化的 Spark 托管服务.</p>
<p>目前最火热的两个技术已经可以结合并迸发出了新的火花, 2.3.0 版本以上的 Apache Spark 已经提供了对 Kubernetes 平台的支持与集成, 使我们能够利用原生的 Kubernetes 来进行集群计算资源的分配与管理 Spark 计算作业. 在该模式下, Spark Driver 和 Executor 都通过 Kubernetes Pods 来运行, 并且也可通过指定 Node Selector 将计算作业运行于特定节点之上 (例如: 带有GPU的实例类型等).<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-10-13-SparkonAKS/k8s-cluster-mode.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-10-13-SparkonAKS/k8s-cluster-mode.jpg&quot;</a> “height:600px” width&#x3D;”600px” div align&#x3D;center&#x2F;&gt;<br>（from: <a target="_blank" rel="noopener" href="https://spark.apache.org/">https://spark.apache.org</a>).</p>
<h2 id="2-Apache-Spark-on-AKS-实现"><a href="#2-Apache-Spark-on-AKS-实现" class="headerlink" title="2. Apache Spark on AKS 实现"></a>2. Apache Spark on AKS 实现</h2><p>本实验需要正确安装 azcli, kubectl 等命令行工具, 详细步骤请参考相应文档, 本文不再赘述. 具体的操作过程在 AKS Vnet 的一台内网服务器的 root 家目录下进行, 该服务器作为 Spark 集群的 Gateway 客户端.</p>
<h3 id="2-1-创建-AKS-集群"><a href="#2-1-创建-AKS-集群" class="headerlink" title="2.1 创建 AKS 集群"></a>2.1 创建 AKS 集群</h3><h4 id="2-1-1-创建资源组"><a href="#2-1-1-创建资源组" class="headerlink" title="2.1.1 创建资源组"></a>2.1.1 创建资源组</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az group create --name akssparkrg --location southeastasia</span><br></pre></td></tr></table></figure>
<h4 id="2-1-2-创建-3-节点-AKS-集群"><a href="#2-1-2-创建-3-节点-AKS-集群" class="headerlink" title="2.1.2 创建 3 节点 AKS 集群"></a>2.1.2 创建 3 节点 AKS 集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">az aks create --resource-group akssparkrg \</span><br><span class="line">--name aksspark0001 \</span><br><span class="line">--kubernetes-version 1.14.7 \</span><br><span class="line">--node-count 3 \</span><br><span class="line">--node-vm-size Standard_DS2_v3 \</span><br><span class="line">--enable-addons monitoring \</span><br><span class="line">--admin-username akssparkuser \</span><br><span class="line">--ssh-key-value ~/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure>
<p>集群创建时间在20分钟左右.</p>
<h4 id="2-1-3-获取-AKS-Credential"><a href="#2-1-3-获取-AKS-Credential" class="headerlink" title="2.1.3 获取 AKS Credential:"></a>2.1.3 获取 AKS Credential:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az aks get-credentials --resource-group akssparkrg --name aksspark0001</span><br></pre></td></tr></table></figure>

<h3 id="2-2-在-AKS-集群中创建-Spark-服务帐户并绑定权限"><a href="#2-2-在-AKS-集群中创建-Spark-服务帐户并绑定权限" class="headerlink" title="2.2 在 AKS 集群中创建 Spark 服务帐户并绑定权限"></a>2.2 在 AKS 集群中创建 Spark 服务帐户并绑定权限</h3><h4 id="2-2-1-创建-Spark-服务账号"><a href="#2-2-1-创建-Spark-服务账号" class="headerlink" title="2.2.1 创建 Spark 服务账号"></a>2.2.1 创建 Spark 服务账号</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount spark</span><br></pre></td></tr></table></figure>
<h4 id="2-2-2-权限绑定"><a href="#2-2-2-权限绑定" class="headerlink" title="2.2.2 权限绑定"></a>2.2.2 权限绑定</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding spark-role \</span><br><span class="line">--clusterrole=edit \</span><br><span class="line">--serviceaccount=default:spark \</span><br><span class="line">--namespace=default</span><br></pre></td></tr></table></figure>

<h3 id="2-3-下载-Spark-二进制文件"><a href="#2-3-下载-Spark-二进制文件" class="headerlink" title="2.3 下载 Spark 二进制文件"></a>2.3 下载 Spark 二进制文件</h3><p>从 <a target="_blank" rel="noopener" href="http://spark.apache.org/downloads.html">Spark官网</a> 选择合适的版本下载, 本例中使用 2.4.4 版本 ( 需要高于2.3.0 ).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://www-eu.apache.org/dist/spark/spark-2.4.4/spark-2.4.4-bin-hadoop2.7.tgz</span><br><span class="line">tar -zvxf spark-2.4.4-bin-hadoop2.7.tgz</span><br></pre></td></tr></table></figure>

<h3 id="2-4-确认-Spark-Jar-和-Kubernetes-的版本兼容性"><a href="#2-4-确认-Spark-Jar-和-Kubernetes-的版本兼容性" class="headerlink" title="2.4 确认 Spark Jar 和 Kubernetes 的版本兼容性"></a>2.4 确认 Spark Jar 和 Kubernetes 的版本兼容性</h3><p>Spark 采用了 <a target="_blank" rel="noopener" href="https://github.com/fabric8io/kubernetes-client">fabric8.io</a> 的 Kubernetes &amp; OpenShift Java Client 客户端连接 API Server 来进行资源调度和分配, 需要先确认 Spark 2.4.4 自带的 kubernetes-client-*.jar 版本与 AKS 集群版本是否兼容. Spark 2.4.4 自带的 Kubernetes-client 版本为 4.1.2 ( kubernetes-client-4.1.2.jar ), AKS集群版本为 1.14.7, 存在版本不兼容问题，需要更高版本 jar 包. 具体的版本对应关系如下表所示:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">|                           | Kubernetes 1.4.9 | Kubernetes 1.6.0 | Kubernetes 1.7.0  | Kubernetes 1.9.0  | Kubernetes 1.10.0 | Kubernetes 1.11.0 | Kubernetes 1.12.0 | Kubernetes 1.14.2 | Kubernetes 1.15.3 |</span><br><span class="line">|---------------------------|------------------|------------------|-------------------|-------------------|-------------------|-------------------|-------------------|-------------------|-------------------|</span><br><span class="line">| kubernetes-client 1.3.92  | +                | +                | -                 | -                 | -                 | -                 | -                 | -                 | -                 |</span><br><span class="line">| kubernetes-client 3.0.3   | -                | -                | ✓                 | -                 | -                 | -                 | -                 | -                 | -                 |</span><br><span class="line">| kubernetes-client 3.0.10  | -                | ✓                | ✓                 | ✓                 | -                 | -                 | -                 | -                 | -                 |</span><br><span class="line">| kubernetes-client 3.0.11  | -                | ✓                | ✓                 | ✓                 | -                 | -                 | -                 | -                 | -                 |</span><br><span class="line">| kubernetes-client 3.1.12  | -                | ✓                | ✓                 | ✓                 | -                 | -                 | -                 | -                 | -                 |</span><br><span class="line">| kubernetes-client 3.2.0   | -                | ✓                | ✓                 | ✓                 | -                 | -                 | -                 | -                 | -                 |</span><br><span class="line">| kubernetes-client 4.0.0   | -                | ✓                | ✓                 | ✓                 | -                 | -                 | -                 | -                 | -                 |</span><br><span class="line">| kubernetes-client 4.1.0   | -                | ✓                | ✓                 | ✓                 | -                 | -                 | -                 | -                 | -                 |</span><br><span class="line">| kubernetes-client 4.1.1   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | -                 | -                 |</span><br><span class="line">| kubernetes-client 4.1.2   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | -                 | -                 |</span><br><span class="line">| kubernetes-client 4.1.3   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | -                 | -                 |</span><br><span class="line">| kubernetes-client 4.2.0   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | -                 | -                 |</span><br><span class="line">| kubernetes-client 4.2.1   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | -                 | -                 |</span><br><span class="line">| kubernetes-client 4.2.2   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | -                 | -                 |</span><br><span class="line">| kubernetes-client 4.3.0   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | ✓                 | -                 |</span><br><span class="line">| kubernetes-client 4.3.1   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | ✓                 | -                 |</span><br><span class="line">| kubernetes-client 4.4.0   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | ✓                 | -                 |</span><br><span class="line">| kubernetes-client 4.4.1   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | ✓                 | -                 |</span><br><span class="line">| kubernetes-client 4.4.2   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | ✓                 | -                 |</span><br><span class="line">| kubernetes-client 4.5.0   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | ✓                 | -                 |</span><br><span class="line">| kubernetes-client 4.5.1   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | ✓                 | -                 |</span><br><span class="line">| kubernetes-client 4.5.2   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | ✓                 | -                 |</span><br><span class="line">| kubernetes-client 4.6.0   | -                | -                | -                 | ✓                 | ✓                 | ✓                 | ✓                 | ✓                 | ✓                 |</span><br></pre></td></tr></table></figure>
<p>本文我们直接使用能够与 Kubernetes 1.14.7 版本兼容的 kubernetes-client 4.6.0.jar, 通过 <a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/io.fabric8/kubernetes-client">这里</a> 下载, 下载后替换 spark-2.4.4-bin-hadoop2.7&#x2F;jars 目录下的 kubernetes-client-4.1.2.jar 即可.</p>
<h3 id="2-5-创建-ACR-Azure-Container-Registry-并与-AKS-集成"><a href="#2-5-创建-ACR-Azure-Container-Registry-并与-AKS-集成" class="headerlink" title="2.5 创建 ACR (Azure Container Registry) 并与 AKS 集成"></a>2.5 创建 ACR (Azure Container Registry) 并与 AKS 集成</h3><h4 id="2-5-1-创建-ACR"><a href="#2-5-1-创建-ACR" class="headerlink" title="2.5.1 创建 ACR"></a>2.5.1 创建 ACR</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az acr create -n akssparkacr0001 -g akssparkrg --sku basic</span><br></pre></td></tr></table></figure>
<p><strong>记录 ACR Resource ID:</strong><br>&#x2F;subscriptions&#x2F;53a326cc-f961-4540-8701-2bfd1003242b&#x2F;resourceGroups&#x2F;akssparkrg&#x2F;providers&#x2F;Microsoft.ContainerRegistry&#x2F;registries&#x2F;akssparkacr0001</p>
<h4 id="2-5-2-ACR-与-AKS-集群集成"><a href="#2-5-2-ACR-与-AKS-集群集成" class="headerlink" title="2.5.2 ACR 与 AKS 集群集成"></a>2.5.2 ACR 与 AKS 集群集成</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">az aks update -n aksspark0001 -g akssparkrg --attach-acr akssparkacr0001</span><br><span class="line">az aks update -n aksspark0001 -g akssparkrg --attach-acr /subscriptions/53a326cc-f961-4540-8701-2bfd1003242b/resourceGroups/akssparkrg/providers/Microsoft.ContainerRegistry/registries/akssparkacr0001</span><br></pre></td></tr></table></figure>
<h4 id="2-5-3-登录-ACR"><a href="#2-5-3-登录-ACR" class="headerlink" title="2.5.3 登录 ACR"></a>2.5.3 登录 ACR</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az acr login -n akssparkacr0001</span><br></pre></td></tr></table></figure>

<h3 id="2-6-构建-Spark-镜像"><a href="#2-6-构建-Spark-镜像" class="headerlink" title="2.6 构建 Spark 镜像"></a>2.6 构建 Spark 镜像</h3><h4 id="2-6-1-构建并推送镜像至-ACR"><a href="#2-6-1-构建并推送镜像至-ACR" class="headerlink" title="2.6.1 构建并推送镜像至 ACR"></a>2.6.1 构建并推送镜像至 ACR</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">REGISTRY_NAME=akssparkacr0001.azurecr.io</span><br><span class="line">REGISTRY_TAG=v1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行脚本构建 Spark 镜像</span></span><br><span class="line">./bin/docker-image-tool.sh -r <span class="variable">$REGISTRY_NAME</span> -t <span class="variable">$REGISTRY_TAG</span> build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送镜像</span></span><br><span class="line">./bin/docker-image-tool.sh -r <span class="variable">$REGISTRY_NAME</span> -t <span class="variable">$REGISTRY_TAG</span> push</span><br></pre></td></tr></table></figure>
<h4 id="2-6-2-Azure-查看docker-image"><a href="#2-6-2-Azure-查看docker-image" class="headerlink" title="2.6.2 Azure 查看docker image:"></a>2.6.2 Azure 查看docker image:</h4><p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-10-13-SparkonAKS/ACR.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-10-13-SparkonAKS/ACR.jpg&quot;</a> “height:1000px” width&#x3D;”1000px” div align&#x3D;center&#x2F;&gt;<br>通过 docker image list 也可以看, 自动构建了 Spark 原生, Spark-R 以及 Pyspark 的容器镜像.<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-10-13-SparkonAKS/DockerImage.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-10-13-SparkonAKS/DockerImage.jpg&quot;</a> “height:1000px” width&#x3D;”1000px” div align&#x3D;center&#x2F;&gt;</p>
<h3 id="2-7-运行作业-SparkPi"><a href="#2-7-运行作业-SparkPi" class="headerlink" title="2.7 运行作业 SparkPi"></a>2.7 运行作业 SparkPi</h3><p>Spark 作业两种方式来运行, Cluster 和 Client 模式. 两种模式的主要区别简单概括就是 Spark Job Driver 是在本地节点还是集群节点上. 在实际生产过程中, 通常会将 spark-submit 的作业提交方式服务化, 通过外部服务调用将作业提交到集群上运行, 最典型的就是 Apache Livy. 本文采取通过命令行 spark-submit 将 SparkPi 作业提交到集群上计算的方式.</p>
<h4 id="2-7-1-创建-Storage-Account-并将-spark-examples-2-11-2-4-4-jar-上传至-Azure-Blob"><a href="#2-7-1-创建-Storage-Account-并将-spark-examples-2-11-2-4-4-jar-上传至-Azure-Blob" class="headerlink" title="2.7.1 创建 Storage Account 并将 spark-examples_2.11-2.4.4.jar 上传至 Azure Blob"></a>2.7.1 创建 Storage Account 并将 spark-examples_2.11-2.4.4.jar 上传至 Azure Blob</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 变量定义, storage account name</span></span><br><span class="line">RESOURCE_GROUP=akssparkrg</span><br><span class="line">STORAGE_ACCT=akssparksa0001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 storage account</span></span><br><span class="line">az group create --name <span class="variable">$RESOURCE_GROUP</span> --location southeastasia</span><br><span class="line">az storage account create --resource-group <span class="variable">$RESOURCE_GROUP</span> --name <span class="variable">$STORAGE_ACCT</span> --sku Standard_LRS</span><br><span class="line"><span class="built_in">export</span> AZURE_STORAGE_CONNECTION_STRING=`az storage account show-connection-string --resource-group <span class="variable">$RESOURCE_GROUP</span> --name <span class="variable">$STORAGE_ACCT</span> -o tsv`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定上传 jar</span></span><br><span class="line">CONTAINER_NAME=akssparkjars</span><br><span class="line">BLOB_NAME=spark-examples_2.11-2.4.4.jar</span><br><span class="line">FILE_TO_UPLOAD=/root/aksspark/spark-2.4.4-bin-hadoop2.7/examples/jars/spark-examples_2.11-2.4.4.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 blob container</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Creating the container...&quot;</span></span><br><span class="line">az storage container create --name <span class="variable">$CONTAINER_NAME</span></span><br><span class="line">az storage container set-permission --name <span class="variable">$CONTAINER_NAME</span> --public-access blob</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传 jar</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Uploading the file...&quot;</span></span><br><span class="line">az storage blob upload --container-name <span class="variable">$CONTAINER_NAME</span> --file <span class="variable">$FILE_TO_UPLOAD</span> --name <span class="variable">$BLOB_NAME</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 jar url </span></span><br><span class="line">JARURL=$(az storage blob url --container-name <span class="variable">$CONTAINER_NAME</span> --name <span class="variable">$BLOB_NAME</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;&quot;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="2-7-2-运行-SparkPi"><a href="#2-7-2-运行-SparkPi" class="headerlink" title="2.7.2 运行 SparkPi"></a>2.7.2 运行 SparkPi</h4><p>通过 spark-submit 提交 SparkPi 作业</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> spark-2.4.4-bin-hadoop2.7</span><br><span class="line">./bin/spark-submit \</span><br><span class="line">  --master k8s://https://aksspark00-akssparkrg-53a326-07f35845.hcp.southeastasia.azmk8s.io:443 \ <span class="comment"># AKS 集群地址</span></span><br><span class="line">  --deploy-mode cluster \ <span class="comment"># 集群模式</span></span><br><span class="line">  --name spark-pi \</span><br><span class="line">  --class org.apache.spark.examples.SparkPi \</span><br><span class="line">  --conf spark.executor.instances=3 \ <span class="comment"># 申请 3 个 Executor</span></span><br><span class="line">  --conf spark.kubernetes.container.image=akssparkacr0001.azurecr.io/spark:v1 \ <span class="comment"># Docker Image 地址</span></span><br><span class="line">  --conf spark.kubernetes.authenticate.driver.serviceAccountName=spark \ <span class="comment"># 指定创建的 Service Account spark</span></span><br><span class="line">  https://akssparksa0001.blob.core.windows.net/akssparkjars/spark-examples_2.11-2.4.4.jar <span class="comment"># Jar</span></span><br></pre></td></tr></table></figure>
<p>  spark-submit 的具体参数可以参考 <a target="_blank" rel="noopener" href="http://spark.apache.org/docs/latest/running-on-kubernetes.html">Spark on Kubernetes官网</a>, 不过官方文档只有默认参数配置. 如果需要看所有参数的可选值, 可以考虑去看 GitHub 上 <a target="_blank" rel="noopener" href="https://github.com/apache/spark/blob/master/resource-managers/kubernetes/core/src/main/scala/org/apache/spark/deploy/k8s/Config.scala">Spark 源代码</a>.</p>
<h4 id="2-7-3-查看运行结果"><a href="#2-7-3-查看运行结果" class="headerlink" title="2.7.3 查看运行结果"></a>2.7.3 查看运行结果</h4><p>查看 Spark Job Driver 和对应的 Executor Pods</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@AKSSpark spark-2.4.4-bin-hadoop2.7]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">spark-pi-1571055145415-driver   1/1     Running   0          25s</span><br><span class="line">spark-pi-1571055145415-exec-1   1/1     Running   0          15s</span><br><span class="line">spark-pi-1571055145415-exec-2   1/1     Running   0          15s</span><br><span class="line">spark-pi-1571055145415-exec-3   0/1     Pending   0          15s</span><br></pre></td></tr></table></figure>
<p>运行作业时. 还可以访问 Spark UI. kubectl port-forward 命令提供对 Spark Job UI 的访问权限.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl port-forward spark-pi-1571055145415-driver 4040:4040</span><br></pre></td></tr></table></figure>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-10-13-SparkonAKS/Spark.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-10-13-SparkonAKS/Spark.jpg&quot;</a> “height:1000px” width&#x3D;”1000px” div align&#x3D;center&#x2F;&gt;<br>获取作业结果和日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@AKSSpark spark-2.4.4-bin-hadoop2.7]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                                       READY   STATUS      RESTARTS   AGE</span><br><span class="line">spark-pi-1571055145415-driver              0/1     Completed   0          53s</span><br></pre></td></tr></table></figure>
<p>使用 kubectl logs 来获取 Spark 作业的 Log</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs spark-pi-1571055145415-driver</span><br></pre></td></tr></table></figure>
<p>日志中，可以看到 Spark 作业的结果，即 Pi 的值.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Pi is roughly 3.1412957064785325</span><br></pre></td></tr></table></figure>

<h3 id="2-8-使用-Spark-Shell-进行交互式分析-Azure-Blob-数据"><a href="#2-8-使用-Spark-Shell-进行交互式分析-Azure-Blob-数据" class="headerlink" title="2.8 使用 Spark Shell 进行交互式分析 Azure Blob 数据"></a>2.8 使用 Spark Shell 进行交互式分析 Azure Blob 数据</h3><p>在很多需要调试的场景中, 都会通过命令行的交互式界面来进行调试. 对于 Spark 来说, 有 Spark Shell、Spark-R、Pyspark 三种命令行, 分别针对 Scala, R 以及 Python. 下面我们通过Spark Shell 来分析 Azure Blob 的数据.</p>
<h4 id="2-8-1-Docker-Image-新打包-v2-版本"><a href="#2-8-1-Docker-Image-新打包-v2-版本" class="headerlink" title="2.8.1 Docker Image 新打包 v2 版本"></a>2.8.1 Docker Image 新打包 v2 版本</h4><p>Spark 通过 wasbs:&#x2F;&#x2F;{container-name}@{storage-account-name}.blob.core.windows.net 访问 Azure Blob, 这需要在 Spark Jar 中加载 azure-storage.jar 和 hadoop-azure.jar, 这些 Jar 需要打在 Docker Image 里面, 然后上传至 ACR.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> spark-2.4.4-bin-hadoop2.7/jars</span><br><span class="line">wget http://central.maven.org/maven2/com/microsoft/azure/azure-storage/2.2.0/azure-storage-2.2.0.jar</span><br><span class="line">wget http://central.maven.org/maven2/org/apache/hadoop/hadoop-azure/2.7.3/hadoop-azure-2.7.3.jar</span><br></pre></td></tr></table></figure>
<p>然后重复 2.6 节的操作, 指定版本号为 v2, 打包好后推送到 ACR 上, 具体的 Image 地址为 akssparkacr0001.azurecr.io&#x2F;spark:v2.</p>
<h4 id="2-8-2-使用-Spark-Shell-交互式分析-Azure-Blob-中的数据"><a href="#2-8-2-使用-Spark-Shell-交互式分析-Azure-Blob-中的数据" class="headerlink" title="2.8.2 使用 Spark Shell 交互式分析 Azure Blob 中的数据"></a>2.8.2 使用 Spark Shell 交互式分析 Azure Blob 中的数据</h4><p>运行 Spark Shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> spark-2.4.4-bin-hadoop2.7</span><br><span class="line">./bin/spark-shell \</span><br><span class="line">  --master k8s://https://aksspark00-akssparkrg-53a326-07f35845.hcp.southeastasia.azmk8s.io:443 \</span><br><span class="line">  --name spark-shell \</span><br><span class="line">  --deploy-mode client \</span><br><span class="line">  --conf spark.executor.instances=3 \</span><br><span class="line">  --conf spark.kubernetes.executor.limit.cores=1 \</span><br><span class="line">  --conf spark.kubernetes.container.image=akssparkacr0001.azurecr.io/spark:v3</span><br></pre></td></tr></table></figure>
<p>进入 Spark Shell Scala 命令行交互界面<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-10-13-SparkonAKS/SparkShell.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-10-13-SparkonAKS/SparkShell.jpg&quot;</a> “height:1000px” width&#x3D;”1000px” div align&#x3D;center&#x2F;&gt;</p>
<p>Scala 验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; sc.parallelize(1 to 100000).count</span><br><span class="line">res10: Long = 100000</span><br></pre></td></tr></table></figure>
<p>具体的分析的文件为示例 csv, 名为 diamonds.csv, 并已经提前上传到 Azure Blob Container 名为 sparkshell 中.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Azure Blob Storage Account 认证</span></span><br><span class="line">scala&gt; spark.conf.set(</span><br><span class="line">     |     <span class="string">&quot;fs.azure.account.key.akssparksa0001.blob.core.windows.net&quot;</span>,</span><br><span class="line">     |     <span class="string">&quot;gWfl5JezYzXs1ub572KZDAWTR9buVb/pb/dHj/iqsKV07fQKSl+JzUqcLWgx4Qr7xQTVPBSVsXhO6Aja/torAw==&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载 blob 文件</span></span><br><span class="line">scala&gt; val diamonds = spark.read.format(<span class="string">&quot;csv&quot;</span>).option(<span class="string">&quot;header&quot;</span>, <span class="string">&quot;true&quot;</span>).option(<span class="string">&quot;inferSchema&quot;</span>, <span class="string">&quot;true&quot;</span>).load(<span class="string">&quot;wasbs://sparkshell@akssparksa0001.blob.core.windows.net/diamonds.csv&quot;</span>)</span><br><span class="line">diamonds: org.apache.spark.sql.DataFrame = [_c0: int, carat: double ... 9 more fields]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示字段类型</span></span><br><span class="line">scala&gt; diamonds.printSchema()</span><br><span class="line">root</span><br><span class="line"> |-- _c0: <span class="built_in">integer</span> (nullable = <span class="literal">true</span>)</span><br><span class="line"> |-- carat: double (nullable = <span class="literal">true</span>)</span><br><span class="line"> |-- <span class="built_in">cut</span>: string (nullable = <span class="literal">true</span>)</span><br><span class="line"> |-- color: string (nullable = <span class="literal">true</span>)</span><br><span class="line"> |-- clarity: string (nullable = <span class="literal">true</span>)</span><br><span class="line"> |-- depth: double (nullable = <span class="literal">true</span>)</span><br><span class="line"> |-- table: double (nullable = <span class="literal">true</span>)</span><br><span class="line"> |-- price: <span class="built_in">integer</span> (nullable = <span class="literal">true</span>)</span><br><span class="line"> |-- x: double (nullable = <span class="literal">true</span>)</span><br><span class="line"> |-- y: double (nullable = <span class="literal">true</span>)</span><br><span class="line"> |-- z: double (nullable = <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"> <span class="comment"># 显示前 10 行数据</span></span><br><span class="line">scala&gt; diamonds.show(10)</span><br><span class="line">+---+-----+---------+-----+-------+-----+-----+-----+----+----+----+            </span><br><span class="line">|_c0|carat|      <span class="built_in">cut</span>|color|clarity|depth|table|price|   x|   y|   z|</span><br><span class="line">+---+-----+---------+-----+-------+-----+-----+-----+----+----+----+</span><br><span class="line">|  1| 0.23|    Ideal|    E|    SI2| 61.5| 55.0|  326|3.95|3.98|2.43|</span><br><span class="line">|  2| 0.21|  Premium|    E|    SI1| 59.8| 61.0|  326|3.89|3.84|2.31|</span><br><span class="line">|  3| 0.23|     Good|    E|    VS1| 56.9| 65.0|  327|4.05|4.07|2.31|</span><br><span class="line">|  4| 0.29|  Premium|    I|    VS2| 62.4| 58.0|  334| 4.2|4.23|2.63|</span><br><span class="line">|  5| 0.31|     Good|    J|    SI2| 63.3| 58.0|  335|4.34|4.35|2.75|</span><br><span class="line">|  6| 0.24|Very Good|    J|   VVS2| 62.8| 57.0|  336|3.94|3.96|2.48|</span><br><span class="line">|  7| 0.24|Very Good|    I|   VVS1| 62.3| 57.0|  336|3.95|3.98|2.47|</span><br><span class="line">|  8| 0.26|Very Good|    H|    SI1| 61.9| 55.0|  337|4.07|4.11|2.53|</span><br><span class="line">|  9| 0.22|     Fair|    E|    VS2| 65.1| 61.0|  337|3.87|3.78|2.49|</span><br><span class="line">| 10| 0.23|Very Good|    H|    VS1| 59.4| 61.0|  338| 4.0|4.05|2.39|</span><br><span class="line">+---+-----+---------+-----+-------+-----+-----+-----+----+----+----+</span><br><span class="line">only showing top 10 rows</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取前 10 行并写入新文件</span></span><br><span class="line">scala&gt; diamonds.limit(10).write.format(<span class="string">&quot;csv&quot;</span>).save(<span class="string">&quot;wasbs://sparkshell@akssparksa0001.blob.core.windows.net/1.csv&quot;</span>)</span><br><span class="line">scala&gt; spark.read.csv(<span class="string">&quot;wasbs://sparkshell@akssparksa0001.blob.core.windows.net/1.csv&quot;</span>).show()</span><br><span class="line">+---+----+---------+---+----+----+----+---+----+----+----+</span><br><span class="line">|_c0| _c1|      _c2|_c3| _c4| _c5| _c6|_c7| _c8| _c9|_c10|</span><br><span class="line">+---+----+---------+---+----+----+----+---+----+----+----+</span><br><span class="line">|  1|0.23|    Ideal|  E| SI2|61.5|55.0|326|3.95|3.98|2.43|</span><br><span class="line">|  2|0.21|  Premium|  E| SI1|59.8|61.0|326|3.89|3.84|2.31|</span><br><span class="line">|  3|0.23|     Good|  E| VS1|56.9|65.0|327|4.05|4.07|2.31|</span><br><span class="line">|  4|0.29|  Premium|  I| VS2|62.4|58.0|334| 4.2|4.23|2.63|</span><br><span class="line">|  5|0.31|     Good|  J| SI2|63.3|58.0|335|4.34|4.35|2.75|</span><br><span class="line">|  6|0.24|Very Good|  J|VVS2|62.8|57.0|336|3.94|3.96|2.48|</span><br><span class="line">|  7|0.24|Very Good|  I|VVS1|62.3|57.0|336|3.95|3.98|2.47|</span><br><span class="line">|  8|0.26|Very Good|  H| SI1|61.9|55.0|337|4.07|4.11|2.53|</span><br><span class="line">|  9|0.22|     Fair|  E| VS2|65.1|61.0|337|3.87|3.78|2.49|</span><br><span class="line">| 10|0.23|Very Good|  H| VS1|59.4|61.0|338| 4.0|4.05|2.39|</span><br><span class="line">+---+----+---------+---+----+----+----+---+----+----+----+</span><br></pre></td></tr></table></figure>
<p>另外, 跨 Azure Blob Container 的文件读写也可以.</p>
<h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h2><p>通过以上的几个步骤, 可以实现在 Azure Kubernetes Service 集群上运行 Spark 作业的平台部署. 与传统的 YARN 来做资源管理调度相比较而言更为轻量快捷, 同时可以与 Azure Blob 做集成, 数据存储在 Azure Blob 中进行分析, 既可以保证数据高可靠性也能够实现计算与存储的分离从而提高灵活性.</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://theodorew.github.io/wxsblog.github.io/2019/10/13/2019-10-13-SparkonAKS/" data-id="claq92fmf00019nxz4oxf7mwl" class="article-share-link" data-share="baidu" data-title="强强联合! 利用 Microsoft Azure AKS 集群集成 Apache Spark 来做大数据计算">Share</a>
      

      

      
        <a class="article-reward-link">Reward</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Bigdata/" rel="tag">Bigdata</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Kubernetes/" rel="tag">Kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Microsoft-Azure/" rel="tag">Microsoft Azure</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2019-01-18-WSL" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/wxsblog.github.io/2019/01/18/2019-01-18-WSL/" class="article-date">
  <time datetime="2019-01-18T02:23:32.000Z" itemprop="datePublished">2019-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/wxsblog.github.io/categories/Linux/">Linux</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Linux/Windows-10/">Windows 10</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Linux/Windows-10/WSL/">WSL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/wxsblog.github.io/2019/01/18/2019-01-18-WSL/">Win10强大的WSL(Windows Subsystem for Linux)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>Hello，大家好！第一篇正式的博客，我们先来说说WSL。WSL可以让开发者在 Windows 10 下通过Bash Shell 运行原生的 Ubuntu 用户态二进制程序，工程师们不用再苦恼所用的 Windows 平台上没有合适的 Linux 工具和库了。对于 Linux 的重度用户来说，福音来了。之所以第一篇技术博客介绍 WSL，也是因为我未来技术博客中的实验环境都会以此为基础。那还等什么，让我们来动手实战一下，感受一下 WSL 的强大吧 ！<br><br></p>
<h2 id="2-WSL简介和原理"><a href="#2-WSL简介和原理" class="headerlink" title="2. WSL简介和原理"></a>2. WSL简介和原理</h2><p>WSL 相关代码早在 2016 年 1 月下旬便被微软悄悄内置进了 Windows 10 Build 14251 预览版中，此后微软的开发人员制订了 lxcore.sys 与 lxss.sys 这两个新的子系统文件，让其成为 Windows 程序员开发 Linux 应用程序的桥梁。WSL 是由 Windows 内核团队与 Canonical 合作设计和开发的，可以让 Windows 10 下的开发者们在拥有 Windows 中那些强力支持之外，还能使用 Linux 下丰富的开发环境与工具而不用启动另外的操作系统或者使用虚拟机。这绝对是一个“来自开发者，服务开发者”的 Windows 10 特色，它的目的是让开发者们每天的开发工作都变得顺畅而便捷。我们先来看一下 WSL 的架构和原理图：<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-01-18-WSL/ubuntu-on-windows-how-it-works.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-01-18-WSL/ubuntu-on-windows-how-it-works.jpg&quot;</a> “height:600px” width&#x3D;”600px” &#x2F;&gt;<br>WSL 对于 Windows 系统来说属于用户态程序，通过虚拟文件系统接口，以 DriveFs 文件系统挂载到 Windows 从而提供和 Windows 的互操作能力。  lxss.sys 和 lxcore.sys 这两个驱动负责模拟 Linux 内核并实时拦截系统调用。相应的驱动会将 Linux 内核调用映射为对应的 Windows 内核调用。根据从微软内部的压力测试工具据来看，WSL 的性能表现非常接近用相同硬件直接运行 Linux 的性能，几乎可以获得同等的 CPU、内存和 I&#x2F;O 性能，这证明 WSL 在性能方面的表现很出色。<br><br></p>
<h2 id="3-WSL配置"><a href="#3-WSL配置" class="headerlink" title="3. WSL配置"></a>3. WSL配置</h2><h3 id="3-1-启用-WSL-Feature"><a href="#3-1-启用-WSL-Feature" class="headerlink" title="3.1 启用 WSL Feature"></a>3.1 启用 WSL Feature</h3><p>顺序：Windows 设置 -&gt; 应用和功能 -&gt; 右侧的程序和功能 -&gt; 启动或关闭windows功能 -&gt; 勾选适用于 Linux 的 Windows 子系统</p>
<!-- <img src="WSL-feature.jpg" "height:400px" width="450px" /> -->
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-01-18-WSL/WSL-feature.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-01-18-WSL/WSL-feature.jpg&quot;</a> “height:400px” width&#x3D;”450px” &#x2F;&gt;</p>
<h3 id="3-2-安装-WSL"><a href="#3-2-安装-WSL" class="headerlink" title="3.2 安装 WSL"></a>3.2 安装 WSL</h3><p>Microsoft store 提供了很多 Linux 发行版本可供选择，用户可以根据自己的爱好和习惯去选择自己喜欢的 Linux 发行版本。本文选择 Ubuntu 进行安装，点击启动，第一次会进行初始化安装。<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-01-18-WSL/Linux-search.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-01-18-WSL/Linux-search.jpg&quot;</a> “height:600px” width&#x3D;”600px” &#x2F;&gt;<br>初始化安装完成，需要设置帐号密码 ，此处可以根据用户习惯去设置，直接使用 root 或者配置其他用户 sudo 免密切换 root，本文选择使用 sudo 模式。<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-01-18-WSL/ubuntu-initial-configuration.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-01-18-WSL/ubuntu-initial-configuration.jpg&quot;</a> “height:600px” width&#x3D;”600px” &#x2F;&gt;</p>
<h3 id="3-3-配置-WSL"><a href="#3-3-配置-WSL" class="headerlink" title="3.3 配置 WSL"></a>3.3 配置 WSL</h3><p>具体的使用方式和 Ubuntu Linux 一样，可以选择启动Ubuntu Bash Terminal来使用，或者可以将 Bash 放到后台，通过 Termius SSH 远程连接到 Ubuntu，本文即采用该模式。</p>
<h5 id="3-3-1-配置sudo免密登陆"><a href="#3-3-1-配置sudo免密登陆" class="headerlink" title="3.3.1 配置sudo免密登陆"></a>3.3.1 配置sudo免密登陆</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo su -</span><br><span class="line">[sudo] password <span class="keyword">for</span> adminuser:     <span class="comment">##### input password once #####</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;adminuser ALL=(ALL) NOPASSWD: ALL&quot;</span> &gt;&gt; /etc/sudoers</span><br></pre></td></tr></table></figure>
<h5 id="3-3-2-重装openssh并启动"><a href="#3-3-2-重装openssh并启动" class="headerlink" title="3.3.2 重装openssh并启动"></a>3.3.2 重装openssh并启动</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get remove openssh-server</span><br><span class="line">$ apt-get update     <span class="comment">##### 默认源 ubuntu canonical, 如果无法访问，可以根据网络状况自行修改或者科学上网 #####</span></span><br><span class="line">$ apt-get install openssh-server</span><br><span class="line">$ vi /etc/ssh/sshd_config</span><br><span class="line">  修改 PasswordAuthentication no 为 PasswordAuthentication <span class="built_in">yes</span></span><br><span class="line">  :wq 保存退出</span><br><span class="line">$ service ssh --full-restart</span><br></pre></td></tr></table></figure>
<h5 id="3-3-3-通过Termius远程连接"><a href="#3-3-3-通过Termius远程连接" class="headerlink" title="3.3.3 通过Termius远程连接"></a>3.3.3 通过Termius远程连接</h5><p>Termius 是 Windows 10 上远程连接 Linux 的终端工具，Microsoft store 可以下载，UI、功能性都不错，可以一用。如果大家有自己喜爱的工具，也可以选择喜欢的工具。<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-01-18-WSL/Termius.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-01-18-WSL/Termius.jpg&quot;</a> “height:800px” width&#x3D;”800px” &#x2F;&gt;</p>
<h3 id="3-4-Bash放到后台，SSH服务开机启动"><a href="#3-4-Bash放到后台，SSH服务开机启动" class="headerlink" title="3.4 Bash放到后台，SSH服务开机启动"></a>3.4 Bash放到后台，SSH服务开机启动</h3><p>现在有一个问题，每次 Windows 关机开机之后都需要手动启动 Bash.exe，然后 start ssh service 才可以远程连接使用。每次都需要这样做一次，很繁琐。下面就来介绍一下 SSH 服务如何开机启动吧~ </p>
<h5 id="3-4-1-sudo免密登陆"><a href="#3-4-1-sudo免密登陆" class="headerlink" title="3.4.1 sudo免密登陆"></a>3.4.1 sudo免密登陆</h5><p>根据目前的操作系统的用户，先配置免密登陆，具体参考 3.3.1。</p>
<h5 id="3-4-1-通过VB-script开机启动SSH"><a href="#3-4-1-通过VB-script开机启动SSH" class="headerlink" title="3.4.1 通过VB script开机启动SSH"></a>3.4.1 通过VB script开机启动SSH</h5><p>写一个 VB 通过调用 Bash.exe 启动 SSH 服务的脚本，例如 startssh.vbs：</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> ws=wscript.<span class="built_in">createobject</span>(<span class="string">&quot;wscript.shell&quot;</span>)</span><br><span class="line">ws.run <span class="string">&quot;C:\Windows\System32\bash.exe&quot;</span>,<span class="number">0</span></span><br><span class="line">ws.run <span class="string">&quot;C:\Windows\System32\bash.exe  -c &#x27;sudo /usr/sbin/service ssh start&#x27;&quot;</span>,<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>然后将startssh.vbs放到如下目录(<strong>需要管理员权限</strong>)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%AppData%\Microsoft\Windows\Start Menu\Programs\Startup</span><br></pre></td></tr></table></figure>

<p>开机启动配置完毕。<br><br></p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>总体上，WSL的配置就结束了。现在可以在此基础上去配置所需要的开发或者其他组件了，其实WSL也可以像虚拟机一样去备份、回滚等等，很多的其他的功能或玩法，有待大家自己开发了~</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://theodorew.github.io/wxsblog.github.io/2019/01/18/2019-01-18-WSL/" data-id="claq92fmc00009nxzabf18d4n" class="article-share-link" data-share="baidu" data-title="Win10强大的WSL(Windows Subsystem for Linux)">Share</a>
      

      

      
        <a class="article-reward-link">Reward</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/WSL/" rel="tag">WSL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Windows-10/" rel="tag">Windows 10</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/wxsblog.github.io/">&amp;laquo; Prev</a><a class="page-number" href="/wxsblog.github.io/">1</a><span class="page-number current">2</span>
  </nav>
</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Linux/">Linux</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Linux/Windows-10/">Windows 10</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Linux/Windows-10/WSL/">WSL</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/">Microsoft Azure</a><span class="category-list-count">14</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Database/">Database</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Database/MySQL/">MySQL</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Database/MySQL/Linux/">Linux</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Databricks/">Databricks</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Databricks/Bigdata/">Bigdata</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Databricks/Bigdata/Linux/">Linux</a><span class="category-list-count">4</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Github/">Github</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Github/CDN/">CDN</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Github/CDN/Linux/">Linux</a><span class="category-list-count">2</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/">Kubernetes</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/">Bigdata</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/Flink/">Flink</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/Flink/Linux/">Linux</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/Linux/">Linux</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/">Monitor</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/MongoDB/">MongoDB</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/MongoDB/Linux/">Linux</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/SNMP/">SNMP</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/SNMP/Linux/">Linux</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/SNMP/Linux/Fortigate/">Fortigate</a><span class="category-list-count">1</span></li></ul></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/infrastructure/">infrastructure</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/infrastructure/Linux/">Linux</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/infrastructure/Linux/Automation/">Automation</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/infrastructure/Linux/DataBase/">DataBase</a><span class="category-list-count">1</span></li></ul></li></ul></li></ul></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Automation/" rel="tag">Automation</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Bigdata/" rel="tag">Bigdata</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/CDN/" rel="tag">CDN</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/DataBase/" rel="tag">DataBase</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Database/" rel="tag">Database</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Databricks/" rel="tag">Databricks</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Flink/" rel="tag">Flink</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Fortigate/" rel="tag">Fortigate</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Github/" rel="tag">Github</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Kubernetes/" rel="tag">Kubernetes</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Microsoft-Azure/" rel="tag">Microsoft Azure</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/MongoDB/" rel="tag">MongoDB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Monitor/" rel="tag">Monitor</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/MySQL/" rel="tag">MySQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/SNMP/" rel="tag">SNMP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/WSL/" rel="tag">WSL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Windows-10/" rel="tag">Windows 10</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/infrastructure/" rel="tag">infrastructure</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/wxsblog.github.io/tags/Automation/" style="font-size: 11.67px;">Automation</a> <a href="/wxsblog.github.io/tags/Bigdata/" style="font-size: 16.67px;">Bigdata</a> <a href="/wxsblog.github.io/tags/CDN/" style="font-size: 11.67px;">CDN</a> <a href="/wxsblog.github.io/tags/DataBase/" style="font-size: 10px;">DataBase</a> <a href="/wxsblog.github.io/tags/Database/" style="font-size: 10px;">Database</a> <a href="/wxsblog.github.io/tags/Databricks/" style="font-size: 15px;">Databricks</a> <a href="/wxsblog.github.io/tags/Flink/" style="font-size: 10px;">Flink</a> <a href="/wxsblog.github.io/tags/Fortigate/" style="font-size: 10px;">Fortigate</a> <a href="/wxsblog.github.io/tags/Github/" style="font-size: 11.67px;">Github</a> <a href="/wxsblog.github.io/tags/Kubernetes/" style="font-size: 11.67px;">Kubernetes</a> <a href="/wxsblog.github.io/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/wxsblog.github.io/tags/Microsoft-Azure/" style="font-size: 18.33px;">Microsoft Azure</a> <a href="/wxsblog.github.io/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/wxsblog.github.io/tags/Monitor/" style="font-size: 11.67px;">Monitor</a> <a href="/wxsblog.github.io/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/wxsblog.github.io/tags/SNMP/" style="font-size: 10px;">SNMP</a> <a href="/wxsblog.github.io/tags/WSL/" style="font-size: 10px;">WSL</a> <a href="/wxsblog.github.io/tags/Windows-10/" style="font-size: 10px;">Windows 10</a> <a href="/wxsblog.github.io/tags/infrastructure/" style="font-size: 13.33px;">infrastructure</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2022/11/">November 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2021/07/">July 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2020/12/">December 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2020/11/">November 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2020/09/">September 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2020/01/">January 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2019/12/">December 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2019/11/">November 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2019/10/">October 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2019/01/">January 2019</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/wxsblog.github.io/2022/11/11/2022-11-11-AzureMySQLFlexibleServerNetworking/">Azure MySQL Flexible Server 内网 DNS 集成方案blog</a>
          </li>
        
          <li>
            <a href="/wxsblog.github.io/2021/07/26/2021-07-26-AzureImageBuilderCLSIGI/">Azure Image Builder（二）之自动化构建自定义托管镜像 CentOS 7.7 并集成 Azure Shared Image Gallery 做全球分发</a>
          </li>
        
          <li>
            <a href="/wxsblog.github.io/2021/07/25/2021-07-25-AzureImageBuilderCLMI/">Azure Image Builder（一）之自动化构建自定义托管镜像 CentOS 7.7</a>
          </li>
        
          <li>
            <a href="/wxsblog.github.io/2021/03/17/2021-03-17-AzureDatabricksMonitor/">Azure Databricks 系列 Blog（四）之通过 Azure Monitor 做集群监控</a>
          </li>
        
          <li>
            <a href="/wxsblog.github.io/2020/12/17/2020-12-17-AzureDatabricksSparkSQLonDeltaLake/">Azure Databricks 系列 Blog（三）之 SparkSQL on Delta Lake</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://arvinxiang.com" target="_blank">主题作者</a>
          </li>
        
          <li>
            <a href="http://reqianduan.com" target="_blank">热前端</a>
          </li>
        
          <li>
            <a href="http://yuancheng.work" target="_blank">远程.work</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Xinsheng Wang<br>
 
      <span id="busuanzi_container_site_pv">
      本站总访问量<span id="busuanzi_value_site_pv"></span>次
      </span>
      <span id="busuanzi_container_site_uv">
      本站访客数<span id="busuanzi_value_site_uv"></span>人次
      </span>

      <br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>

  </div>
  <nav id="mobile-nav">
  
    <a href="/wxsblog.github.io/" class="mobile-nav-link">Home</a>
  
    <a href="/wxsblog.github.io/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/wxsblog.github.io/img/scrollup.png"/></a>
</div>

<!-- totop end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/wxsblog.github.io/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>





<script src="/wxsblog.github.io/js/script.js"></script>


</div>
</body>
</html>
