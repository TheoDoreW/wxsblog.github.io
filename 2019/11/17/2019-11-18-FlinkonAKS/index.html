
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>新一代大数据计算框架 Flink 与 Microsoft Azure Kubernetes 集成来做流批计算 | 茶包哥的迷你仓</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="1. 前言上一篇，我们验证测试了 Apache Spark 和 Azure Kubernetes Service 的集成，包括通过 Cluster Mode 依托 AKS 集群运行 Spark 作业以及和 Azure Blob Storage 集成来做计算存储的解耦分离。和传统的资源调度框架 Hadoop Yarn 相比， 使用 Azure Kubernetes Service 提高了部署速度和效">
<meta property="og:type" content="article">
<meta property="og:title" content="新一代大数据计算框架 Flink 与 Microsoft Azure Kubernetes 集成来做流批计算">
<meta property="og:url" content="https://theodorew.github.io/wxsblog.github.io/2019/11/17/2019-11-18-FlinkonAKS/index.html">
<meta property="og:site_name" content="茶包哥的迷你仓">
<meta property="og:description" content="1. 前言上一篇，我们验证测试了 Apache Spark 和 Azure Kubernetes Service 的集成，包括通过 Cluster Mode 依托 AKS 集群运行 Spark 作业以及和 Azure Blob Storage 集成来做计算存储的解耦分离。和传统的资源调度框架 Hadoop Yarn 相比， 使用 Azure Kubernetes Service 提高了部署速度和效">
<meta property="og:locale">
<meta property="article:published_time" content="2019-11-17T02:23:32.000Z">
<meta property="article:modified_time" content="2020-09-02T16:35:37.000Z">
<meta property="article:author" content="Xinsheng Wang">
<meta property="article:tag" content="Microsoft Azure">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Bigdata">
<meta property="article:tag" content="Flink">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="茶包哥的迷你仓" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/wxsblog.github.io/css/style.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 6.0.0"></head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/wxsblog.github.io/" id="logo">茶包哥的迷你仓</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/wxsblog.github.io/">Home</a>
        
          <a class="main-nav-link" href="/wxsblog.github.io/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="theodorew.github.io/wxsblog.github.io">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main"><article id="post-2019-11-18-FlinkonAKS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/wxsblog.github.io/2019/11/17/2019-11-18-FlinkonAKS/" class="article-date">
  <time datetime="2019-11-17T02:23:32.000Z" itemprop="datePublished">2019-11-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/">Microsoft Azure</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/">Kubernetes</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/">Bigdata</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/Flink/">Flink</a>►<a class="article-category-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/Flink/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      新一代大数据计算框架 Flink 与 Microsoft Azure Kubernetes 集成来做流批计算
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p><a href="https://theodorew.github.io/wxsblog.github.io/2019/01/18/2019-10-13-SparkonAKS/">上一篇</a>，我们验证测试了 Apache Spark 和 Azure Kubernetes Service 的集成，包括通过 Cluster Mode 依托 AKS 集群运行 Spark 作业以及和 Azure Blob Storage 集成来做计算存储的解耦分离。和传统的资源调度框架 Hadoop Yarn 相比， 使用 Azure Kubernetes Service 提高了部署速度和效率，提高灵活性并一定程度降低了运维管理成本。Spark 在强大的社区支撑下，技术的成熟度是在几大大数据计算框架中最高也是最全面的。但是除了 Spark，在大数据计算框架中还有一颗冉冉升起的新星，It is Apache Flink。本文我们来聊聊 Apache Flink 以及如何与 Azure Kubernetes Service 集成来做流批计算。</p>
<h2 id="2-Apahce-Flink-介绍"><a href="#2-Apahce-Flink-介绍" class="headerlink" title="2. Apahce Flink 介绍"></a>2. Apahce Flink 介绍</h2><p>Apache Flink 是一个分布式大数据处理引擎，可对有限数据流和无限数据流进行有状态或无状态的计算，能够部署在各种集群环境，对各种规模大小的数据进行快速计算。<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink.jpg&quot;</a> “height:1000px” width&#x3D;”1000px” div align&#x3D;center&#x2F;&gt;<br>（from: <a target="_blank" rel="noopener" href="https://flink.apache.org/">https://flink.apache.org/</a>)</p>
<p>Flink 的代码主要是由 Java 语言实现的，部分代码是 Scala，提供主流的 Java 及 Scala API，并且从 1.0 版本开始也提供 Python API 即 Pyflink。对 Flink 而言，其所要处理的主要场景就是 Streaming 流数据，Batch 批数据只是流数据的一个时间维度上的特例而已，所以 Flink 是一款真正的流批统一的计算引擎，这种设计思路对于某些业务场景可以提高代码的复用率，所以这也是 Flink 被很多大厂接受并广泛使用的原因之一。下面我们来看看 Flink 的内部架构：</p>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flinkarch.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flinkarch.jpg&quot;</a> “height:600px” width&#x3D;”600px” div align&#x3D;center&#x2F;&gt;</p>
<p>从下至上来看：<br><strong>部署：</strong> Flink 支持本地运行（IDE 中直接运行程序）、能在独立集群（Standalone 模式）或者在被 YARN、Mesos、K8s 管理的集群上运行，也能部署在云上。<br><strong>运行：</strong>Flink 的核心是分布式流式数据引擎，意味着数据以一次一个事件的形式被处理。<br><strong>API：</strong>DataStream、DataSet、Table、SQL API。<br><strong>扩展库：</strong>Flink 还包括用于 CEP（复杂事件处理）、机器学习、图形处理等场景。</p>
<p>本文仅调研 Flink on Azure Kubernetes 并做流批场景的技术可行性验证，对于其他部署模式不展开讨论，有兴趣的同学可以自行研究。</p>
<h2 id="3-Flink-on-AKS-实现"><a href="#3-Flink-on-AKS-实现" class="headerlink" title="3. Flink on AKS 实现"></a>3. Flink on AKS 实现</h2><p>本实验需要正确安装 Azure Cli、Terraform，Kubectl、Docker 等软件包，详细步骤请参考相应文档，本文不进行赘述。具体的操作过程在 AKS Vnet 的一台内网服务器上进行，该服务器作为 Flink 集群的跳板机使用。</p>
<h3 id="3-1-创建-AKS-集群、ACR-及跳板机"><a href="#3-1-创建-AKS-集群、ACR-及跳板机" class="headerlink" title="3.1 创建 AKS 集群、ACR 及跳板机"></a>3.1 创建 AKS 集群、ACR 及跳板机</h3><p>为了提高效率，本文直接使用 Terraform 来做自动化一键部署，Terraform 的介绍不做赘述，同学们自行搜索吧。废话少说，直接上 Code，具体 Terraform Azure 的用法可以参考<a target="_blank" rel="noopener" href="https://www.terraform.io/docs/providers/azurerm/index.html">这里</a>。本文按照 Terraform 的最佳实践结构设计，由于 variables.tf 包含一些个人 Azure 账号信息，所以本文只展现主要的 azure-aks.tf 文件，内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configure the Microsoft Azure Provider</span></span><br><span class="line">provider <span class="string">&quot;azurerm&quot;</span> &#123;</span><br><span class="line">    subscription_id = <span class="string">&quot;<span class="variable">$&#123;var.subscription_id&#125;</span>&quot;</span></span><br><span class="line">    client_id       = <span class="string">&quot;<span class="variable">$&#123;var.client_id&#125;</span>&quot;</span></span><br><span class="line">    client_secret   = <span class="string">&quot;<span class="variable">$&#123;var.client_secret&#125;</span>&quot;</span></span><br><span class="line">    tenant_id       = <span class="string">&quot;<span class="variable">$&#123;var.tenant_id&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a resource group if it doesn’t exist</span></span><br><span class="line">resource <span class="string">&quot;azurerm_resource_group&quot;</span> <span class="string">&quot;myterraformgroup&quot;</span> &#123;</span><br><span class="line">    name     = <span class="string">&quot;<span class="variable">$&#123;var.resource_group_name&#125;</span>&quot;</span></span><br><span class="line">    location = <span class="string">&quot;<span class="variable">$&#123;var.location&#125;</span>&quot;</span></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create virtual network</span></span><br><span class="line">resource <span class="string">&quot;azurerm_virtual_network&quot;</span> <span class="string">&quot;myterraformnetwork&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;<span class="variable">$&#123;var.vnet_name&#125;</span>&quot;</span></span><br><span class="line">    address_space       = <span class="string">&quot;<span class="variable">$&#123;var.vnet_address_space&#125;</span>&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create Network Security Group and rule</span></span><br><span class="line">resource <span class="string">&quot;azurerm_network_security_group&quot;</span> <span class="string">&quot;public_nsg&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;<span class="variable">$&#123;var.public_nsg&#125;</span>&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;SSH&quot;</span></span><br><span class="line">        priority                   = 1001</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;22&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_network_security_group&quot;</span> <span class="string">&quot;op_nsg&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;<span class="variable">$&#123;var.op_nsg&#125;</span>&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;SSH&quot;</span></span><br><span class="line">        priority                   = 1001</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;22&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_network_security_group&quot;</span> <span class="string">&quot;aks_nsg&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;<span class="variable">$&#123;var.aks_nsg&#125;</span>&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;SSH&quot;</span></span><br><span class="line">        priority                   = 1001</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;22&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    security_rule &#123;</span><br><span class="line">        name                       = <span class="string">&quot;AKSWebUI&quot;</span></span><br><span class="line">        priority                   = 1002</span><br><span class="line">        direction                  = <span class="string">&quot;Inbound&quot;</span></span><br><span class="line">        access                     = <span class="string">&quot;Allow&quot;</span></span><br><span class="line">        protocol                   = <span class="string">&quot;Tcp&quot;</span></span><br><span class="line">        source_port_range          = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_port_range     = <span class="string">&quot;8081&quot;</span></span><br><span class="line">        source_address_prefix      = <span class="string">&quot;*&quot;</span></span><br><span class="line">        destination_address_prefix = <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create subnet</span></span><br><span class="line">resource <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;public_subnet&quot;</span> &#123;</span><br><span class="line">    name                 = <span class="string">&quot;<span class="variable">$&#123;var.public_subnet&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name  = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    virtual_network_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_virtual_network.myterraformnetwork.name&#125;</span>&quot;</span></span><br><span class="line">    address_prefix       = <span class="string">&quot;<span class="variable">$&#123;var.public_subnet_address_prefix&#125;</span>&quot;</span></span><br><span class="line">    network_security_group_id = <span class="string">&quot;<span class="variable">$&#123;azurerm_network_security_group.public_nsg.id&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;op_subnet&quot;</span> &#123;</span><br><span class="line">    name                 = <span class="string">&quot;<span class="variable">$&#123;var.op_subnet&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name  = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    virtual_network_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_virtual_network.myterraformnetwork.name&#125;</span>&quot;</span></span><br><span class="line">    address_prefix       = <span class="string">&quot;<span class="variable">$&#123;var.op_subnet_address_prefix&#125;</span>&quot;</span></span><br><span class="line">    network_security_group_id = <span class="string">&quot;<span class="variable">$&#123;azurerm_network_security_group.public_nsg.id&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;aks_subnet&quot;</span> &#123;</span><br><span class="line">    name                 = <span class="string">&quot;<span class="variable">$&#123;var.aks_subnet&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name  = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    virtual_network_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_virtual_network.myterraformnetwork.name&#125;</span>&quot;</span></span><br><span class="line">    address_prefix       = <span class="string">&quot;<span class="variable">$&#123;var.aks_subnet_address_prefix&#125;</span>&quot;</span></span><br><span class="line">    network_security_group_id = <span class="string">&quot;<span class="variable">$&#123;azurerm_network_security_group.aks_nsg.id&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create Azure Kubernetes Service Cluster</span></span><br><span class="line">resource <span class="string">&quot;azurerm_log_analytics_workspace&quot;</span> <span class="string">&quot;myterraform_log_analytics_workspace&quot;</span> &#123;</span><br><span class="line">    <span class="comment"># The WorkSpace name has to be unique across the whole of azure, not just the current subscription/tenant.</span></span><br><span class="line">    name                = <span class="string">&quot;<span class="variable">$&#123;var.log_analytics_workspace_name&#125;</span>&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    sku                 = <span class="string">&quot;<span class="variable">$&#123;var.log_analytics_workspace_sku&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_log_analytics_solution&quot;</span> <span class="string">&quot;myterraform_log_analytics_solution&quot;</span> &#123;</span><br><span class="line">    solution_name         = <span class="string">&quot;ContainerInsights&quot;</span></span><br><span class="line">    location              = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name   = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    workspace_resource_id = <span class="string">&quot;<span class="variable">$&#123;azurerm_log_analytics_workspace.myterraform_log_analytics_workspace.id&#125;</span>&quot;</span></span><br><span class="line">    workspace_name        = <span class="string">&quot;<span class="variable">$&#123;azurerm_log_analytics_workspace.myterraform_log_analytics_workspace.name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    plan &#123;</span><br><span class="line">        publisher = <span class="string">&quot;Microsoft&quot;</span></span><br><span class="line">        product   = <span class="string">&quot;OMSGallery/ContainerInsights&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_kubernetes_cluster&quot;</span> <span class="string">&quot;myterraform_kubernetes_cluster&quot;</span> &#123;</span><br><span class="line">    name                = <span class="string">&quot;<span class="variable">$&#123;var.azure_kubernetes_service_cluster_name&#125;</span>&quot;</span></span><br><span class="line">    location            = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    dns_prefix          = <span class="string">&quot;<span class="variable">$&#123;var.azure_kubernetes_service_dns_prefix&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    kubernetes_version = <span class="string">&quot;<span class="variable">$&#123;var.azure_kubernetes_service_cluster_version&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    linux_profile &#123;</span><br><span class="line">        admin_username = <span class="string">&quot;<span class="variable">$&#123;var.admin_username&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        ssh_key &#123;</span><br><span class="line">            key_data = <span class="string">&quot;<span class="variable">$&#123;var.ssh_public_key_data&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    agent_pool_profile &#123;</span><br><span class="line">        name            = <span class="string">&quot;agentpool&quot;</span></span><br><span class="line">        count           = <span class="string">&quot;<span class="variable">$&#123;var.agent_count&#125;</span>&quot;</span></span><br><span class="line">        vm_size         = <span class="string">&quot;Standard_D4s_v3&quot;</span></span><br><span class="line">        os_type         = <span class="string">&quot;Linux&quot;</span></span><br><span class="line">        os_disk_size_gb = 30</span><br><span class="line">        vnet_subnet_id  = <span class="string">&quot;<span class="variable">$&#123;azurerm_subnet.aks_subnet.id&#125;</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    network_profile &#123;</span><br><span class="line">        network_plugin = <span class="string">&quot;azure&quot;</span></span><br><span class="line">        network_policy = <span class="string">&quot;azure&quot;</span></span><br><span class="line">        dns_service_ip = <span class="string">&quot;10.0.0.10&quot;</span></span><br><span class="line">        docker_bridge_cidr = <span class="string">&quot;172.17.0.1/16&quot;</span></span><br><span class="line">        service_cidr = <span class="string">&quot;10.0.0.0/16&quot;</span></span><br><span class="line">        load_balancer_sku = <span class="string">&quot;standard&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    role_based_access_control &#123;</span><br><span class="line">        enabled = <span class="string">&quot;true&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addon_profile &#123;</span><br><span class="line">        oms_agent &#123;</span><br><span class="line">            enabled                    = <span class="string">&quot;true&quot;</span></span><br><span class="line">            log_analytics_workspace_id = <span class="string">&quot;<span class="variable">$&#123;azurerm_log_analytics_workspace.myterraform_log_analytics_workspace.id&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    service_principal &#123;</span><br><span class="line">        client_id       = <span class="string">&quot;<span class="variable">$&#123;var.client_id&#125;</span>&quot;</span></span><br><span class="line">        client_secret   = <span class="string">&quot;<span class="variable">$&#123;var.client_secret&#125;</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        Environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create Azure Container Registry</span></span><br><span class="line">resource <span class="string">&quot;azurerm_container_registry&quot;</span> <span class="string">&quot;myterraform_container_registry&quot;</span> &#123;</span><br><span class="line">  name                     = <span class="string">&quot;<span class="variable">$&#123;var.azure_container_registry_name&#125;</span>&quot;</span></span><br><span class="line">  resource_group_name      = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">  location                 = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">  sku                      = <span class="string">&quot;Premium&quot;</span></span><br><span class="line">  admin_enabled            = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create AKS JumperVM</span></span><br><span class="line">resource <span class="string">&quot;azurerm_public_ip&quot;</span> <span class="string">&quot;aks_jumpervm0001_pip&quot;</span> &#123;</span><br><span class="line">    name                         = <span class="string">&quot;<span class="variable">$&#123;var.aks_jumpervm_name&#125;</span>&quot;</span></span><br><span class="line">    location                     = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name          = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    allocation_method            = <span class="string">&quot;Static&quot;</span></span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">resource <span class="string">&quot;azurerm_network_interface&quot;</span> <span class="string">&quot;aks_jumpervm0001_nic&quot;</span> &#123;</span><br><span class="line">    name                        = <span class="string">&quot;<span class="variable">$&#123;var.aks_jumpervm_nic_name&#125;</span>&quot;</span></span><br><span class="line">    location                    = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name         = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    ip_configuration &#123;</span><br><span class="line">        name                          = <span class="string">&quot;<span class="variable">$&#123;var.aks_jumpervm_nic_name&#125;</span>&quot;</span></span><br><span class="line">        subnet_id                     = <span class="string">&quot;<span class="variable">$&#123;azurerm_subnet.aks_subnet.id&#125;</span>&quot;</span></span><br><span class="line">        private_ip_address_allocation = <span class="string">&quot;Dynamic&quot;</span></span><br><span class="line">        public_ip_address_id          = <span class="string">&quot;<span class="variable">$&#123;azurerm_public_ip.aks_jumpervm0001_pip.id&#125;</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">        environment = <span class="string">&quot;Azure Terraform Kubernetes Service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create virtual machine</span></span><br><span class="line">resource <span class="string">&quot;azurerm_virtual_machine&quot;</span> <span class="string">&quot;aksjumpervm0001&quot;</span> &#123;</span><br><span class="line">    name                  = <span class="string">&quot;<span class="variable">$&#123;var.aks_jumpervm_name&#125;</span>&quot;</span></span><br><span class="line">    location              = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.location&#125;</span>&quot;</span></span><br><span class="line">    resource_group_name   = <span class="string">&quot;<span class="variable">$&#123;azurerm_resource_group.myterraformgroup.name&#125;</span>&quot;</span></span><br><span class="line">    network_interface_ids = [<span class="string">&quot;<span class="variable">$&#123;azurerm_network_interface.aks_jumpervm0001_nic.id&#125;</span>&quot;</span>]</span><br><span class="line">    vm_size               = <span class="string">&quot;Standard_D2s_v3&quot;</span></span><br><span class="line"></span><br><span class="line">    storage_os_disk &#123;</span><br><span class="line">        name              = <span class="string">&quot;<span class="variable">$&#123;var.aks_jumpervm_name&#125;</span>OsDisk&quot;</span></span><br><span class="line">        caching           = <span class="string">&quot;ReadWrite&quot;</span></span><br><span class="line">        create_option     = <span class="string">&quot;FromImage&quot;</span></span><br><span class="line">        managed_disk_type = <span class="string">&quot;Standard_LRS&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    storage_image_reference &#123;</span><br><span class="line">        <span class="built_in">id</span> = <span class="string">&quot;/subscriptions/xxxx-xxxx-xxxx-xxxx-xxxx/resourceGroups/xxxx-xxxx/providers/Microsoft.Compute/images/xxxx&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    os_profile &#123;</span><br><span class="line">        computer_name  = <span class="string">&quot;<span class="variable">$&#123;var.aks_jumpervm_name&#125;</span>&quot;</span></span><br><span class="line">        admin_username = <span class="string">&quot;azureuser&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    os_profile_linux_config &#123;</span><br><span class="line">        disable_password_authentication = <span class="literal">true</span></span><br><span class="line">        ssh_keys &#123;</span><br><span class="line">            path     = <span class="string">&quot;/home/azureuser/.ssh/authorized_keys&quot;</span></span><br><span class="line">            key_data = <span class="string">&quot;<span class="variable">$&#123;var.ssh_public_key_data&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有资源会在 10 分钟以内部署完成。</p>
<h3 id="3-2-获取-AKS-Credential-并查看-AKS-Cluster-信息："><a href="#3-2-获取-AKS-Credential-并查看-AKS-Cluster-信息：" class="headerlink" title="3.2 获取 AKS Credential 并查看 AKS Cluster 信息："></a>3.2 获取 AKS Credential 并查看 AKS Cluster 信息：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az aks get-credentials --resource-group aksrg001 --name akscluster001</span><br></pre></td></tr></table></figure>
<p>集群节点信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get node</span><br><span class="line">NAME                       STATUS   ROLES   AGE   VERSION</span><br><span class="line">aks-agentpool-26667448-0   Ready    agent   17m   v1.14.8</span><br><span class="line">aks-agentpool-26667448-1   Ready    agent   16m   v1.14.8</span><br><span class="line">aks-agentpool-26667448-2   Ready    agent   16m   v1.14.8</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Docker-Login-登陆-ACR-Azure-Container-Registry"><a href="#3-3-Docker-Login-登陆-ACR-Azure-Container-Registry" class="headerlink" title="3.3 Docker Login 登陆 ACR (Azure Container Registry)"></a>3.3 Docker Login 登陆 ACR (Azure Container Registry)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login aksacr001.azurecr.io</span><br></pre></td></tr></table></figure>

<h3 id="3-4-Flink-Streaming-on-AKS"><a href="#3-4-Flink-Streaming-on-AKS" class="headerlink" title="3.4 Flink Streaming on AKS"></a>3.4 Flink Streaming on AKS</h3><h4 id="3-4-1-Streaming-任务示例"><a href="#3-4-1-Streaming-任务示例" class="headerlink" title="3.4.1 Streaming 任务示例"></a>3.4.1 Streaming 任务示例</h4><p>该任务会从某个端口中读取文本，分割为单词，并且每 5 秒钟打印一次每个单词出现的次数。以下代码是从 <a target="_blank" rel="noopener" href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/datastream_api.html#example-program">Flink 官方文档</a> 上获取来的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.FlatMapFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.Time;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WindowWordCount</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; dataStream = env</span><br><span class="line">                .socketTextStream(<span class="string">&quot;10.11.4.4&quot;</span>, <span class="number">9999</span>)</span><br><span class="line">                .flatMap(<span class="keyword">new</span> <span class="title class_">Splitter</span>())</span><br><span class="line">                .keyBy(<span class="number">0</span>)</span><br><span class="line">                .timeWindow(Time.seconds(<span class="number">5</span>))</span><br><span class="line">                .sum(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        dataStream.print();</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">&quot;Window WordCount&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Splitter</span> <span class="keyword">implements</span> <span class="title class_">FlatMapFunction</span>&lt;String, Tuple2&lt;String, Integer&gt;&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap</span><span class="params">(String sentence, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">for</span> (String word: sentence.split(<span class="string">&quot; &quot;</span>)) &#123;</span><br><span class="line">                out.collect(<span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;String, Integer&gt;(word, <span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来执行 mvn clean package 命令，打包好的 Jar 文件路径为 target&#x2F;flink-on-kubernetes-1.0.0-SNAPSHOT-jar-with-dependencies.jar。</p>
<h4 id="3-4-2-构建自定义-Flink-Docker-镜像并推送至-ACR"><a href="#3-4-2-构建自定义-Flink-Docker-镜像并推送至-ACR" class="headerlink" title="3.4.2 构建自定义 Flink Docker 镜像并推送至 ACR"></a>3.4.2 构建自定义 Flink Docker 镜像并推送至 ACR</h4><p>Flink 在 <a target="_blank" rel="noopener" href="https://hub.docker.com/_/flink">DockerHub</a> 上提供了一个官方的容器镜像，我们可以以该镜像为基础，构建独立的 Flink 镜像，主要就是将自定义 Jar 包打到镜像里面去。此外，新版 Flink 已将 Hadoop 依赖从官方发行版中剥离，因此我们在打镜像时也需要包含进去。官方的 <a target="_blank" rel="noopener" href="https://github.com/docker-flink/docker-flink/blob/master/1.9/scala_2.12-debian/Dockerfile">Dockerfile</a> 主要做了将 OpenJDK 1.8 作为 JDK 环境，下载并安装 Flink 至 &#x2F;opt&#x2F;flink，同时添加 flink 用户和组等。我们在此基础上构建自定义 Flink 镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FROM flink:1.9.1-scala_2.12</span><br><span class="line"></span><br><span class="line">ARG hadoop_jar</span><br><span class="line">ARG job_jar</span><br><span class="line"></span><br><span class="line">ENV FLINK_CONF=<span class="variable">$FLINK_HOME</span>/conf/flink-conf.yaml</span><br><span class="line"></span><br><span class="line">RUN <span class="built_in">set</span> -x &amp;&amp; \</span><br><span class="line">  sed -i -e <span class="string">&quot;s/jobmanager\.heap\.size:.*/jobmanager.heap.size: 128m/g&quot;</span> <span class="variable">$FLINK_CONF</span> &amp;&amp; \</span><br><span class="line">  sed -i -e <span class="string">&quot;s/taskmanager\.heap\.size:.*/taskmanager.heap.size: 256m/g&quot;</span> <span class="variable">$FLINK_CONF</span></span><br><span class="line"></span><br><span class="line">COPY --<span class="built_in">chown</span>=flink:flink <span class="variable">$hadoop_jar</span> <span class="variable">$job_jar</span> <span class="variable">$FLINK_HOME</span>/lib/</span><br><span class="line"></span><br><span class="line">USER flink</span><br></pre></td></tr></table></figure>
<p>注：hadoop_jar 从<a target="_blank" rel="noopener" href="https://repo.maven.apache.org/maven2/org/apache/flink/flink-shaded-hadoop-2-uber/2.8.3-7.0/flink-shaded-hadoop-2-uber-2.8.3-7.0.jar">这里</a>下载；job_jar 为刚刚编译打包好的 flink-on-kubernetes-1.0.0-SNAPSHOT-jar-with-dependencies.jar。下载好后做编译：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /path/to/Dockerfile</span><br><span class="line">$ <span class="built_in">cp</span> /path/to/flink-shaded-hadoop-2-uber-2.8.3-7.0.jar hadoop.jar</span><br><span class="line">$ <span class="built_in">cp</span> /path/to/flink-on-kubernetes-1.0.0-SNAPSHOT-jar-with-dependencies.jar job.jar</span><br><span class="line">$ docker build --build-arg hadoop_jar=hadoop.jar --build-arg job_jar=job.jar --tag flink-on-kubernetes:1.0.0 .</span><br></pre></td></tr></table></figure>
<p>查看镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker image <span class="built_in">ls</span></span><br><span class="line">REPOSITORY            TAG                 IMAGE ID            CREATED              SIZE</span><br><span class="line">flink-on-kubernetes   1.0.0               25a02549b943        8 seconds ago        575MB</span><br></pre></td></tr></table></figure>
<p>镜像推送至 ACR：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag flink-on-kubernetes:1.0.0 aksacr001.azurecr.io/flink-on-kubernetes:v1</span><br><span class="line">docker push aksacr001.azurecr.io/flink-on-kubernetes:v1</span><br></pre></td></tr></table></figure>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink_acr.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink_acr.jpg&quot;</a> “height:1000px” width&#x3D;”1000px” div align&#x3D;center&#x2F;&gt;</p>
<h4 id="3-4-3-构建-Flink-Streaming-JobManager-和-Service"><a href="#3-4-3-构建-Flink-Streaming-JobManager-和-Service" class="headerlink" title="3.4.3 构建 Flink Streaming JobManager 和 Service"></a>3.4.3 构建 Flink Streaming JobManager 和 Service</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ vi flink-streaming-on-aks-jobmanager.yml</span><br><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="variable">$&#123;JOB&#125;</span>-jobmanager</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: flink</span><br><span class="line">        instance: <span class="variable">$&#123;JOB&#125;</span>-jobmanager</span><br><span class="line">    spec:</span><br><span class="line">      restartPolicy: OnFailure</span><br><span class="line">      containers:</span><br><span class="line">      - name: jobmanager</span><br><span class="line">        image: aksacr001.azurecr.io/flink-on-kubernetes:v1</span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">&quot;/opt/flink/bin/standalone-job.sh&quot;</span>]</span><br><span class="line">        args: [<span class="string">&quot;start-foreground&quot;</span>,</span><br><span class="line">               <span class="string">&quot;-Djobmanager.rpc.address=<span class="variable">$&#123;JOB&#125;</span>-jobmanager&quot;</span>,</span><br><span class="line">               <span class="string">&quot;-Dparallelism.default=1&quot;</span>,</span><br><span class="line">               <span class="string">&quot;-Dblob.server.port=6124&quot;</span>,</span><br><span class="line">               <span class="string">&quot;-Dqueryable-state.server.ports=6125&quot;</span>]</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6123</span><br><span class="line">          name: rpc</span><br><span class="line">        - containerPort: 6124</span><br><span class="line">          name: blob</span><br><span class="line">        - containerPort: 6125</span><br><span class="line">          name: query</span><br><span class="line">        - containerPort: 8081</span><br><span class="line">          name: ui</span><br></pre></td></tr></table></figure>
<p>使用 kubectl 命令创建对象，并查看状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> JOB=flink-streaming-on-aks</span><br><span class="line">$ envsubst &lt;flink-streaming-on-aks-jobmanager.yml | kubectl apply -f -</span><br><span class="line">$ kubectl get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">flink-streaming-on-aks-jobmanager-xhkkc   1/1     Running   0          48s</span><br></pre></td></tr></table></figure>
<p>接着创建一个 Service 来将 JobManager 的端口开放出来，以便 TaskManager 做服务注册和调用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ vi flink-streaming-on-aks-service.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="variable">$&#123;JOB&#125;</span>-jobmanager</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: flink</span><br><span class="line">    instance: <span class="variable">$&#123;JOB&#125;</span>-jobmanager</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: rpc</span><br><span class="line">    port: 6123</span><br><span class="line">  - name: blob</span><br><span class="line">    port: 6124</span><br><span class="line">  - name: query</span><br><span class="line">    port: 6125</span><br><span class="line">  - name: ui</span><br><span class="line">    port: 8081</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ envsubst &lt;flink-streaming-on-aks-service.yml | kubectl apply -f -</span><br><span class="line">$ kubectl get svc flink-streaming-on-aks-jobmanager</span><br><span class="line">NAME                                TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)                                                       AGE</span><br><span class="line">flink-streaming-on-aks-jobmanager   NodePort   10.0.25.24   &lt;none&gt;        6123:32291/TCP,6124:30580/TCP,6125:30458/TCP,8081:30855/TCP   46s</span><br></pre></td></tr></table></figure>

<h4 id="3-4-4-构建-Flink-Streaming-TaskManager"><a href="#3-4-4-构建-Flink-Streaming-TaskManager" class="headerlink" title="3.4.4 构建 Flink Streaming TaskManager"></a>3.4.4 构建 Flink Streaming TaskManager</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ vi flink-streaming-on-aks-taskmanager.yml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="variable">$&#123;JOB&#125;</span>-taskmanager</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: flink</span><br><span class="line">      instance: <span class="variable">$&#123;JOB&#125;</span>-taskmanager</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: flink</span><br><span class="line">        instance: <span class="variable">$&#123;JOB&#125;</span>-taskmanager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: taskmanager</span><br><span class="line">        image: aksacr001.azurecr.io/flink-on-kubernetes:v1</span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">&quot;/opt/flink/bin/taskmanager.sh&quot;</span>]</span><br><span class="line">        args: [<span class="string">&quot;start-foreground&quot;</span>, <span class="string">&quot;-Djobmanager.rpc.address=<span class="variable">$&#123;JOB&#125;</span>-jobmanager&quot;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ envsubst &lt;flink-streaming-on-aks-taskmanager.yml | kubectl apply -f -</span><br><span class="line">$ kubectl get pods</span><br><span class="line">NAME                                                 READY   STATUS              RESTARTS   AGE</span><br><span class="line">flink-streaming-on-aks-jobmanager-xhkkc              1/1     Running             0          19m</span><br><span class="line">flink-streaming-on-aks-taskmanager-b9df9657d-2vnrt   0/1     Running   0          5s</span><br><span class="line">flink-streaming-on-aks-taskmanager-b9df9657d-5nx95   0/1     Running   0          6s</span><br><span class="line">flink-streaming-on-aks-taskmanager-b9df9657d-g2p7w   0/1     Running   0          5s</span><br></pre></td></tr></table></figure>
<p>目前启动了 JobManager 和 TaskManager 的 AKS Pods 作为整个 Streaming 流计算任务的计算资源，下面进行实时计算任务测试。Flink WebUI如下：<br>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink_streaming_ui.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink_streaming_ui.jpg&quot;</a> “height:1000px” width&#x3D;”1000px” div align&#x3D;center&#x2F;&gt;<br>Flink JobManager 的 WebUI 可以清晰看到 Job 以及整个 Flink Job 的 Pipeline，包括所有的 Log 和 GC 的情况也有显示。</p>
<h4 id="3-4-5-Flink-Streaming-Job-运行和结果"><a href="#3-4-5-Flink-Streaming-Job-运行和结果" class="headerlink" title="3.4.5 Flink Streaming Job 运行和结果"></a>3.4.5 Flink Streaming Job 运行和结果</h4><p>还记得 3.6.1 的 Java 代码吗？ 此时我们需要通过 nc 命令打开 9999 端口，然后输入 messages (输出系统日志来模拟) ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ nc -lk 9999</span><br><span class="line">Sep 18 05:17:16 localhost journal: Runtime journal is using 8.0M (max allowed 398.2M, trying to leave 597.3M free of 3.8G available → current <span class="built_in">limit</span> 398.2M).</span><br><span class="line"></span><br><span class="line">Sep 18 05:17:16 localhost kernel: Initializing cgroup subsys cpuset</span><br><span class="line">Sep 18 05:17:16 localhost kernel: Initializing cgroup subsys cpu</span><br><span class="line">Sep 18 05:17:16 localhost kernel: Initializing cgroup subsys cpuacct</span><br><span class="line"></span><br><span class="line">Sep 18 05:17:16 localhost kernel: BIOS-e820: [mem 0x0000000000000000-0x000000000009fbff] usable</span><br><span class="line">Sep 18 05:17:16 localhost kernel: BIOS-e820: [mem 0x000000000009fc00-0x000000000009ffff] reserved</span><br><span class="line">Sep 18 05:17:16 localhost kernel: BIOS-e820: [mem 0x00000000000e0000-0x00000000000fffff] reserved</span><br><span class="line">Sep 18 05:17:16 localhost kernel: BIOS-e820: [mem 0x0000000000100000-0x000000003ffeffff] usable</span><br><span class="line"></span><br><span class="line">Sep 18 05:17:16 localhost kernel: DMI: Microsoft Corporation Virtual Machine/Virtual Machine, BIOS 090007  06/02/2017</span><br><span class="line">Sep 18 05:17:16 localhost kernel: Hypervisor detected: Microsoft HyperV</span><br><span class="line">Sep 18 05:17:16 localhost kernel: HyperV: features 0x2e7f, hints 0x44c2c</span><br><span class="line">Sep 18 05:17:16 localhost kernel: Hyper-V Host Build:14393-10.0-0-0.299</span><br><span class="line">Sep 18 05:17:16 localhost kernel: HyperV: LAPIC Timer Frequency: 0x30d40</span><br></pre></td></tr></table></figure>
<p>Flink Streaming Job 实时结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs -f -l instance=<span class="variable">$JOB</span>-taskmanager</span><br><span class="line">(,4)</span><br><span class="line">(Sep,1)</span><br><span class="line">(398.2M).,1)</span><br><span class="line">(<span class="built_in">limit</span>,1)</span><br><span class="line">(current,1)</span><br><span class="line">(→,1)</span><br><span class="line">(available,1)</span><br><span class="line">(3.8G,1)</span><br><span class="line">(of,1)</span><br><span class="line">(free,1)</span><br><span class="line">(597.3M,1)</span><br><span class="line">(leave,1)</span><br><span class="line">(to,1)</span><br><span class="line">(trying,1)</span><br><span class="line">(398.2M,,1)</span><br><span class="line">(allowed,1)</span><br><span class="line">((max,1)</span><br><span class="line">(8.0M,1)</span><br><span class="line">(using,1)</span><br><span class="line">(is,1)</span><br><span class="line">(journal,1)</span><br><span class="line">(Runtime,1)</span><br><span class="line">(journal:,1)</span><br><span class="line">(localhost,1)</span><br><span class="line">(05:17:16,1)</span><br><span class="line">(18,1)</span><br><span class="line">(,2)</span><br><span class="line">(cpuacct,1)</span><br><span class="line">(cpu,1)</span><br><span class="line">(cpuset,1)</span><br><span class="line">(subsys,3)</span><br><span class="line">(cgroup,3)</span><br><span class="line">(Initializing,3)</span><br><span class="line">(kernel:,3)</span><br><span class="line">(localhost,3)</span><br><span class="line">(05:17:16,3)</span><br><span class="line">(18,3)</span><br><span class="line">(Sep,3)</span><br><span class="line">(Sep,4)</span><br><span class="line">(0x0000000000100000-0x000000003ffeffff],1)</span><br><span class="line">(0x00000000000e0000-0x00000000000fffff],1)</span><br><span class="line">(reserved,2)</span><br><span class="line">(0x000000000009fc00-0x000000000009ffff],1)</span><br><span class="line">(usable,2)</span><br><span class="line">(0x0000000000000000-0x000000000009fbff],1)</span><br><span class="line">([mem,4)</span><br><span class="line">(BIOS-e820:,4)</span><br><span class="line">(kernel:,4)</span><br><span class="line">(localhost,4)</span><br><span class="line">(05:17:16,4)</span><br><span class="line">(18,4)</span><br><span class="line">(,1)</span><br><span class="line">(Sep,5)</span><br><span class="line">(0x30d40,1)</span><br><span class="line">(Frequency:,1)</span><br><span class="line">(Timer,1)</span><br><span class="line">(LAPIC,1)</span><br><span class="line">(Build:14393-10.0-0-0.299,1)</span><br><span class="line">(Host,1)</span><br><span class="line">(Hyper-V,1)</span><br><span class="line">(0x44c2c,1)</span><br><span class="line">(hints,1)</span><br><span class="line">(0x2e7f,,1)</span><br><span class="line">(features,1)</span><br><span class="line">(HyperV:,2)</span><br><span class="line">(HyperV,1)</span><br><span class="line">(detected:,1)</span><br><span class="line">(Hypervisor,1)</span><br><span class="line">... 后面结果省略了 ...</span><br></pre></td></tr></table></figure>
<p>随着实时任务不断的输入追加，整个 Flink Streaming Job 都处于 Running 状态，永远都不会停下来。</p>
<h3 id="3-5-Flink-Batch-on-AKS"><a href="#3-5-Flink-Batch-on-AKS" class="headerlink" title="3.5 Flink Batch on AKS"></a>3.5 Flink Batch on AKS</h3><p>玩完 Streaming 流计算，我们再来看看批处理任务。其实批处理任务和流计算任务本属一家，只是时间维度上的特例，所以这也是 Flink 对流批任务处理的思想的统一。下面我们也运行同样的 WordCount 批处理任务来玩玩 Flink Batch on AKS。</p>
<h4 id="3-5-1-下载-Flink-二进制文件"><a href="#3-5-1-下载-Flink-二进制文件" class="headerlink" title="3.5.1 下载 Flink 二进制文件"></a>3.5.1 下载 Flink 二进制文件</h4><p>从 <a target="_blank" rel="noopener" href="https://www.apache.org/dyn/closer.lua/flink/flink-1.9.1/flink-1.9.1-bin-scala_2.12.tgz">Flink 官网</a> 选择合适的版本下载，本例中使用 1.9.1 版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://www-us.apache.org/dist/flink/flink-1.9.1/flink-1.9.1-bin-scala_2.12.tgz</span><br><span class="line">tar -zvxf flink-1.9.1-bin-scala_2.12.tgz</span><br></pre></td></tr></table></figure>
<h4 id="3-5-1-编写-ConfigMap-Yaml-文件"><a href="#3-5-1-编写-ConfigMap-Yaml-文件" class="headerlink" title="3.5.1 编写 ConfigMap Yaml 文件"></a>3.5.1 编写 ConfigMap Yaml 文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ vi flink-batch-on-aks-configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: flink-batch-on-aks-configmap</span><br><span class="line">  labels:</span><br><span class="line">    app: flink</span><br><span class="line">data:</span><br><span class="line">  flink-conf.yaml: |+</span><br><span class="line">    jobmanager.rpc.address: flink-jobmanager</span><br><span class="line">    taskmanager.numberOfTaskSlots: 1</span><br><span class="line">    blob.server.port: 6124</span><br><span class="line">    jobmanager.rpc.port: 6123</span><br><span class="line">    taskmanager.rpc.port: 6122</span><br><span class="line">    jobmanager.heap.size: 1024m</span><br><span class="line">    taskmanager.heap.size: 1024m</span><br><span class="line">  log4j.properties: |+</span><br><span class="line">    log4j.rootLogger=INFO, file</span><br><span class="line">    log4j.logger.akka=INFO</span><br><span class="line">    log4j.logger.org.apache.kafka=INFO</span><br><span class="line">    log4j.logger.org.apache.hadoop=INFO</span><br><span class="line">    log4j.logger.org.apache.zookeeper=INFO</span><br><span class="line">    log4j.appender.file=org.apache.log4j.FileAppender</span><br><span class="line">    log4j.appender.file.file=<span class="variable">$&#123;log.file&#125;</span></span><br><span class="line">    log4j.appender.file.layout=org.apache.log4j.PatternLayout</span><br><span class="line">    log4j.appender.file.layout.ConversionPattern=%d&#123;yyyy-MM-<span class="built_in">dd</span> HH:mm:ss,SSS&#125; %-5p %-60c %x - %m%n</span><br><span class="line">    log4j.logger.org.apache.flink.shaded.akka.org.jboss.netty.channel.DefaultChannelPipeline=ERROR, file</span><br></pre></td></tr></table></figure>
<p>创建并查看 ConfigMap：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f flink-batch-on-aks-configmap.yaml</span><br><span class="line">$ kubectl get cm</span><br><span class="line">NAME                           DATA   AGE</span><br><span class="line">flink-batch-on-aks-configmap   2      25s</span><br></pre></td></tr></table></figure>
<h4 id="3-5-2-编写-JobManager-Yaml-文件"><a href="#3-5-2-编写-JobManager-Yaml-文件" class="headerlink" title="3.5.2 编写 JobManager Yaml 文件"></a>3.5.2 编写 JobManager Yaml 文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ vi flink-batch-on-aks-jobmanager.yaml </span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: flink-batch-on-aks-jobmanager</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: flink</span><br><span class="line">        component: jobmanager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: jobmanager</span><br><span class="line">        image: aksacr001.azurecr.io/flink-on-kubernetes:v1</span><br><span class="line">        workingDir: /opt/flink</span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;<span class="variable">$FLINK_HOME</span>/bin/jobmanager.sh start;\</span></span><br><span class="line"><span class="string">          while :;</span></span><br><span class="line"><span class="string">          do</span></span><br><span class="line"><span class="string">            if [[ -f <span class="subst">$(find log -name &#x27;*jobmanager*.log&#x27; -print -quit)</span> ]];</span></span><br><span class="line"><span class="string">              then tail -f -n +1 log/*jobmanager*.log;</span></span><br><span class="line"><span class="string">            fi;</span></span><br><span class="line"><span class="string">          done&quot;</span>]</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6123</span><br><span class="line">          name: rpc</span><br><span class="line">        - containerPort: 6124</span><br><span class="line">          name: blob</span><br><span class="line">        - containerPort: 8081</span><br><span class="line">          name: ui</span><br><span class="line">        livenessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 6123</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 60</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: flink-config-volume</span><br><span class="line">          mountPath: /opt/flink/conf</span><br><span class="line">      volumes:</span><br><span class="line">      - name: flink-config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: flink-batch-on-aks-configmap</span><br><span class="line">          items:</span><br><span class="line">          - key: flink-conf.yaml</span><br><span class="line">            path: flink-conf.yaml</span><br><span class="line">          - key: log4j.properties</span><br><span class="line">            path: log4j.properties</span><br></pre></td></tr></table></figure>
<p>创建并查看 JobManager :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f flink-batch-on-aks-jobmanager.yaml</span><br><span class="line">$ kubectl get pods</span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">flink-batch-on-aks-jobmanager-7ddb5cf4bc-nh7b8   1/1     Running   0          7s</span><br></pre></td></tr></table></figure>
<h4 id="3-5-3-编写-TaskManager-Yaml-文件"><a href="#3-5-3-编写-TaskManager-Yaml-文件" class="headerlink" title="3.5.3 编写 TaskManager Yaml 文件"></a>3.5.3 编写 TaskManager Yaml 文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ vi flink-batch-on-aks-taskmanager.yml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: flink-batch-on-aks-taskmanager</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: flink</span><br><span class="line">        component: taskmanager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: taskmanager</span><br><span class="line">        image: aksacr001.azurecr.io/flink-on-kubernetes:v1</span><br><span class="line">        workingDir: /opt/flink</span><br><span class="line">        <span class="built_in">command</span>: [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;<span class="variable">$FLINK_HOME</span>/bin/taskmanager.sh start; \</span></span><br><span class="line"><span class="string">          while :;</span></span><br><span class="line"><span class="string">          do</span></span><br><span class="line"><span class="string">            if [[ -f <span class="subst">$(find log -name &#x27;*taskmanager*.log&#x27; -print -quit)</span> ]];</span></span><br><span class="line"><span class="string">              then tail -f -n +1 log/*taskmanager*.log;</span></span><br><span class="line"><span class="string">            fi;</span></span><br><span class="line"><span class="string">          done&quot;</span>]</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6122</span><br><span class="line">          name: rpc</span><br><span class="line">        livenessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 6122</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 60</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: flink-config-volume</span><br><span class="line">          mountPath: /opt/flink/conf/</span><br><span class="line">      volumes:</span><br><span class="line">      - name: flink-config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: flink-batch-on-aks-configmap</span><br><span class="line">          items:</span><br><span class="line">          - key: flink-conf.yaml</span><br><span class="line">            path: flink-conf.yaml</span><br><span class="line">          - key: log4j.properties</span><br><span class="line">            path: log4j.properties </span><br></pre></td></tr></table></figure>
<p>创建并查看 TaskManager：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f flink-batch-on-aks-taskmanager.yaml</span><br><span class="line">$ kubectl get pods</span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">flink-batch-on-aks-jobmanager-7ddb5cf4bc-nh7b8   1/1     Running   0          2m28s</span><br><span class="line">flink-batch-on-aks-taskmanager-cdc4498b9-6pctv   1/1     Running   0          11s</span><br><span class="line">flink-batch-on-aks-taskmanager-cdc4498b9-kbkdf   1/1     Running   0          11s</span><br></pre></td></tr></table></figure>
<h4 id="3-5-4-编写-JobManager-Service-Yaml-文件"><a href="#3-5-4-编写-JobManager-Service-Yaml-文件" class="headerlink" title="3.5.4 编写 JobManager Service Yaml 文件"></a>3.5.4 编写 JobManager Service Yaml 文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ vi flink-batch-on-aks-jobmanager-service.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: flink-batch-on-aks-jobmanager</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - name: rpc</span><br><span class="line">    port: 6123</span><br><span class="line">  - name: blob</span><br><span class="line">    port: 6124</span><br><span class="line">  - name: ui</span><br><span class="line">    port: 8081</span><br><span class="line">  selector:</span><br><span class="line">    app: flink</span><br><span class="line">    component: jobmanager</span><br></pre></td></tr></table></figure>
<p>创建并查看 TaskManager Service :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f flink-batch-on-aks-jobmanager-service.yaml </span><br><span class="line">$ kubectl get svc</span><br><span class="line">NAME                            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">flink-batch-on-aks-jobmanager   ClusterIP   10.0.23.214   &lt;none&gt;        6123/TCP,6124/TCP,8081/TCP   7s</span><br></pre></td></tr></table></figure>
<h4 id="3-5-5-启动-Flink-UI-："><a href="#3-5-5-启动-Flink-UI-：" class="headerlink" title="3.5.5 启动 Flink UI ："></a>3.5.5 启动 Flink UI ：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl port-forward flink-batch-on-aks-jobmanager-7ddb5cf4bc-nh7b8 --address 0.0.0.0 8081:8081</span><br></pre></td></tr></table></figure>
<p>&lt;img src&#x3D;”<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink_batch_ui.jpg&quot;">https://cdn.jsdelivr.net/gh/TheoDoreW/CDN_Images@master/images/2019-11-18-FlinkonAKS/flink_batch_ui.jpg&quot;</a> “height:1000px” width&#x3D;”1000px” div align&#x3D;center&#x2F;&gt;</p>
<h4 id="3-5-6-提交-Flink-Batch-Job-到-AKS-集群-："><a href="#3-5-6-提交-Flink-Batch-Job-到-AKS-集群-：" class="headerlink" title="3.5.6 提交 Flink Batch Job 到 AKS 集群 ："></a>3.5.6 提交 Flink Batch Job 到 AKS 集群 ：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/flink run -m 10.11.4.4:8081 ./examples/streaming/WordCount.jar --input ./input.txt</span><br><span class="line">Starting execution of program</span><br><span class="line">Printing result to stdout. Use --output to specify output path.</span><br><span class="line">Program execution finished</span><br><span class="line">Job with JobID 7a9037a6c6573a6a7f01f36e6e9d7382 has finished.</span><br><span class="line">Job Runtime: 138 ms</span><br></pre></td></tr></table></figure>
<p>可以通过 Flink Batch UI 查看计算结果。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>Flink 的思想是把一切任务都看作流来实现流批的计算。本文举例了 2 个场景，验证了在 AKS 上如何运行 Flink Streaming &amp; Batch 作业，希望能够给大家一些参考。但是本文也有很多其他场景并未考虑到，比如：JobManager HA、External Checkpoints (可以和 Azure Blob Storage集成)、动态的任务扩容、与 Eventhub 或 Kafka 的集成等等，这些场景留待大家自己发现和实践了。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://theodorew.github.io/wxsblog.github.io/2019/11/17/2019-11-18-FlinkonAKS/" data-id="claq9cbqd0000i1xz45ej01sb" class="article-share-link" data-share="baidu" data-title="新一代大数据计算框架 Flink 与 Microsoft Azure Kubernetes 集成来做流批计算">Share</a>
      

      

      
        <a class="article-reward-link">Reward</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Bigdata/" rel="tag">Bigdata</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Flink/" rel="tag">Flink</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Kubernetes/" rel="tag">Kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/wxsblog.github.io/tags/Microsoft-Azure/" rel="tag">Microsoft Azure</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/wxsblog.github.io/2019/12/09/2019-12-09-AzureDMS/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Azure Database Migration Service — 数据库迁移到 Microsoft Azure 平台的好帮手
        
      </div>
    </a>
  
  
    <a href="/wxsblog.github.io/2019/10/13/2019-10-13-SparkonAKS/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">强强联合! 利用 Microsoft Azure AKS 集群集成 Apache Spark 来做大数据计算</div>
    </a>
  
</nav>

  
</article>


</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Linux/">Linux</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Linux/Windows-10/">Windows 10</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Linux/Windows-10/WSL/">WSL</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/">Microsoft Azure</a><span class="category-list-count">14</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Database/">Database</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Database/MySQL/">MySQL</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Database/MySQL/Linux/">Linux</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Databricks/">Databricks</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Databricks/Bigdata/">Bigdata</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Databricks/Bigdata/Linux/">Linux</a><span class="category-list-count">4</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Github/">Github</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Github/CDN/">CDN</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Github/CDN/Linux/">Linux</a><span class="category-list-count">2</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/">Kubernetes</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/">Bigdata</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/Flink/">Flink</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/Flink/Linux/">Linux</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Kubernetes/Bigdata/Linux/">Linux</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/">Monitor</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/MongoDB/">MongoDB</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/MongoDB/Linux/">Linux</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/SNMP/">SNMP</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/SNMP/Linux/">Linux</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/Monitor/SNMP/Linux/Fortigate/">Fortigate</a><span class="category-list-count">1</span></li></ul></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/infrastructure/">infrastructure</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/infrastructure/Linux/">Linux</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/infrastructure/Linux/Automation/">Automation</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/wxsblog.github.io/categories/Microsoft-Azure/infrastructure/Linux/DataBase/">DataBase</a><span class="category-list-count">1</span></li></ul></li></ul></li></ul></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Automation/" rel="tag">Automation</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Bigdata/" rel="tag">Bigdata</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/CDN/" rel="tag">CDN</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/DataBase/" rel="tag">DataBase</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Database/" rel="tag">Database</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Databricks/" rel="tag">Databricks</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Flink/" rel="tag">Flink</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Fortigate/" rel="tag">Fortigate</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Github/" rel="tag">Github</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Kubernetes/" rel="tag">Kubernetes</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Microsoft-Azure/" rel="tag">Microsoft Azure</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/MongoDB/" rel="tag">MongoDB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Monitor/" rel="tag">Monitor</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/MySQL/" rel="tag">MySQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/SNMP/" rel="tag">SNMP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/WSL/" rel="tag">WSL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/Windows-10/" rel="tag">Windows 10</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/wxsblog.github.io/tags/infrastructure/" rel="tag">infrastructure</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/wxsblog.github.io/tags/Automation/" style="font-size: 11.67px;">Automation</a> <a href="/wxsblog.github.io/tags/Bigdata/" style="font-size: 16.67px;">Bigdata</a> <a href="/wxsblog.github.io/tags/CDN/" style="font-size: 11.67px;">CDN</a> <a href="/wxsblog.github.io/tags/DataBase/" style="font-size: 10px;">DataBase</a> <a href="/wxsblog.github.io/tags/Database/" style="font-size: 10px;">Database</a> <a href="/wxsblog.github.io/tags/Databricks/" style="font-size: 15px;">Databricks</a> <a href="/wxsblog.github.io/tags/Flink/" style="font-size: 10px;">Flink</a> <a href="/wxsblog.github.io/tags/Fortigate/" style="font-size: 10px;">Fortigate</a> <a href="/wxsblog.github.io/tags/Github/" style="font-size: 11.67px;">Github</a> <a href="/wxsblog.github.io/tags/Kubernetes/" style="font-size: 11.67px;">Kubernetes</a> <a href="/wxsblog.github.io/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/wxsblog.github.io/tags/Microsoft-Azure/" style="font-size: 18.33px;">Microsoft Azure</a> <a href="/wxsblog.github.io/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/wxsblog.github.io/tags/Monitor/" style="font-size: 11.67px;">Monitor</a> <a href="/wxsblog.github.io/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/wxsblog.github.io/tags/SNMP/" style="font-size: 10px;">SNMP</a> <a href="/wxsblog.github.io/tags/WSL/" style="font-size: 10px;">WSL</a> <a href="/wxsblog.github.io/tags/Windows-10/" style="font-size: 10px;">Windows 10</a> <a href="/wxsblog.github.io/tags/infrastructure/" style="font-size: 13.33px;">infrastructure</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2022/11/">November 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2021/07/">July 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2020/12/">December 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2020/11/">November 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2020/09/">September 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2020/01/">January 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2019/12/">December 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2019/11/">November 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2019/10/">October 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/wxsblog.github.io/archives/2019/01/">January 2019</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/wxsblog.github.io/2022/11/11/2022-11-11-AzureMySQLFlexibleServerNetworking/">Azure MySQL Flexible Server 内网 DNS 集成方案blog</a>
          </li>
        
          <li>
            <a href="/wxsblog.github.io/2021/07/26/2021-07-26-AzureImageBuilderCLSIGI/">Azure Image Builder（二）之自动化构建自定义托管镜像 CentOS 7.7 并集成 Azure Shared Image Gallery 做全球分发</a>
          </li>
        
          <li>
            <a href="/wxsblog.github.io/2021/07/25/2021-07-25-AzureImageBuilderCLMI/">Azure Image Builder（一）之自动化构建自定义托管镜像 CentOS 7.7</a>
          </li>
        
          <li>
            <a href="/wxsblog.github.io/2021/03/17/2021-03-17-AzureDatabricksMonitor/">Azure Databricks 系列 Blog（四）之通过 Azure Monitor 做集群监控</a>
          </li>
        
          <li>
            <a href="/wxsblog.github.io/2020/12/17/2020-12-17-AzureDatabricksSparkSQLonDeltaLake/">Azure Databricks 系列 Blog（三）之 SparkSQL on Delta Lake</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://arvinxiang.com" target="_blank">主题作者</a>
          </li>
        
          <li>
            <a href="http://reqianduan.com" target="_blank">热前端</a>
          </li>
        
          <li>
            <a href="http://yuancheng.work" target="_blank">远程.work</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Xinsheng Wang<br>
 
      <span id="busuanzi_container_site_pv">
      本站总访问量<span id="busuanzi_value_site_pv"></span>次
      </span>
      <span id="busuanzi_container_site_uv">
      本站访客数<span id="busuanzi_value_site_uv"></span>人次
      </span>

      <br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>

  </div>
  <nav id="mobile-nav">
  
    <a href="/wxsblog.github.io/" class="mobile-nav-link">Home</a>
  
    <a href="/wxsblog.github.io/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/wxsblog.github.io/img/scrollup.png"/></a>
</div>

<!-- totop end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/wxsblog.github.io/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>





<script src="/wxsblog.github.io/js/script.js"></script>


</div>
</body>
</html>
